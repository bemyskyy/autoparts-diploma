This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: **/*.lock, **/*.svg, **/*.png, **/*.ico, **/*.json
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
autoparts-client/
  .git/
    hooks/
      applypatch-msg.sample
      commit-msg.sample
      fsmonitor-watchman.sample
      post-update.sample
      pre-applypatch.sample
      pre-commit.sample
      pre-merge-commit.sample
      pre-push.sample
      pre-rebase.sample
      pre-receive.sample
      prepare-commit-msg.sample
      push-to-checkout.sample
      sendemail-validate.sample
      update.sample
    info/
      exclude
    logs/
      refs/
        heads/
          main
      HEAD
    objects/
      24/
        4306f98af6707ac2cb22c1faf06b98271cb4c5
      26/
        4f459bf8765c2eeb6a818ad09ad37a9cb4ff60
      2a/
        b7442758fef79ae3551353028b98cdfa1ed562
      2c/
        c5d57a0120716653e033e66a3eae52190fab9a
      57/
        614f9c967596fad0a3989bec2b1deff33034f6
      5b/
        6856841ddbc62416d603fd9011c629a1e44c22
      5d/
        f75f9c838ea50f80ee4d5703b68dd8ac7243d4
      6b/
        edcbccd975e137b08afb0e4f39464e543c97bb
      6d/
        eacb4cf88e7d2bc618d7ceaa3a648195ea4e30
      77/
        b374577de83b86d846eadda2dd17532d7dabaa
      81/
        da39d9f29ccf466d43aef7b1e15348cc4fac4c
      84/
        1a8bd17d275ba332ab3e619d41b819b50fe580
      90/
        d4ee0072ce3fc41812f8af910219f9eea3c3de
      92/
        5af837050a4abe679c5fea0df7e41faf6fc011
      94/
        b6f547c556efd66e359411d44e76a1ce32b703
      96/
        2dc2d7d79e472f6a6ee713fb471b476aff9407
      a4/
        b57e90cec39e8ef2224c6aafe248440228ba66
      b1/
        d225e26e57bcee9e328012d38bb473df5ae1c9
      b3/
        f1ecf44a54372bf90afbb60491417242b8769c
      c1/
        b5526625c04eb771b716ffe760e7ada1d98c48
      cb/
        1270e96310d7ef573ddac94ae4273dc4263052
      cd/
        3b6057ebac3c6637d3a3532f7c176060a94973
      d3/
        8370633f6dc18f5bb2a55884e5ac0c5eceb8d0
      dc/
        39edb5f23a35f788cba146dd7337127ba6c5ab
      e0/
        118a1523a3c96e8d87d1e277a0f6cf9c1f2216
      e4/
        0f46b4d14ab6dbc4a92b24470cbc97c7a0f597
      e6/
        9de29bb2d1d6434b8b29ae775ad8c2e48c5391
      f1/
        66060da1cbc9f216e9f5e99a1ef6074ce2a8f8
    refs/
      heads/
        main
    COMMIT_EDITMSG
    config
    description
    HEAD
    index
  src/
    app/
      core/
        auth/
          auth.service.ts
        guards/
          admin.guard.ts
          guest.guard.ts
        interceptors/
          auth.interceptor.ts
        models/
          auth.models.ts
          cart.models.ts
          catalog.models.ts
        services/
          cart.service.ts
          category.service.ts
          order.service.ts
          product.service.ts
      environments/
        environment.ts
      features/
        admin/
          admin-layout/
            admin-layout.component.ts
          categories/
            admin-categories.component.ts
          orders/
            admin-orders.component.ts
          products/
            admin-products.component.ts
        auth/
          login/
            login.component.ts
          register/
            register.component.ts
        cart/
          cart.component.ts
        catalog/
          catalog.component.ts
        landing/
          landing.component.ts
        profile/
          profile.component.ts
      layout/
        footer/
          footer.component.ts
        header/
          header.component.ts
        main-layout/
          main-layout.component.ts
      app.config.ts
      app.html
      app.routes.ts
      app.scss
      app.spec.ts
      app.ts
    index.html
    main.ts
    styles.scss
  .editorconfig
  .gitignore
  README.md
  tailwind.config.js
autoparts-store/
  .mvn/
    wrapper/
      maven-wrapper.properties
  src/
    main/
      java/
        com/
          diploma/
            autoparts_store/
              config/
                ApplicationConfig.java
                DataInitializer.java
                SecurityConfig.java
              controller/
                AuthController.java
                CartController.java
                CategoryController.java
                OrderController.java
                ProductController.java
              dto/
                AddToCartRequest.java
                AuthRequest.java
                AuthResponse.java
                CartDto.java
                CartItemDto.java
                CategoryDto.java
                CreateProductRequest.java
                OrderDto.java
                ProductDto.java
                RegisterRequest.java
                UserResponse.java
              entity/
                Cart.java
                CartItem.java
                Category.java
                Order.java
                OrderItem.java
                OrderStatus.java
                Product.java
                Role.java
                User.java
              repository/
                CartRepository.java
                CategoryRepository.java
                OrderRepository.java
                ProductRepository.java
                UserRepository.java
              security/
                AuthEntryPointJwt.java
                JwtAuthenticationFilter.java
                JwtService.java
              service/
                AuthenticationService.java
                CartService.java
                CategoryService.java
                OrderService.java
                ProductService.java
              AutopartsStoreApplication.java
      resources/
        db/
          migration/
            V1__init_schema.sql
        application.yaml
    test/
      java/
        com/
          diploma/
            autoparts_store/
              AutopartsStoreApplicationTests.java
  .gitattributes
  .gitignore
  docker-compose.yaml
  mvnw
  mvnw.cmd
  pom.xml
  repomix-output.xml
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="autoparts-client/.git/hooks/applypatch-msg.sample">
#!/bin/sh
#
# An example hook script to check the commit log message taken by
# applypatch from an e-mail message.
#
# The hook should exit with non-zero status after issuing an
# appropriate message if it wants to stop the commit.  The hook is
# allowed to edit the commit message file.
#
# To enable this hook, rename this file to "applypatch-msg".

. git-sh-setup
commitmsg="$(git rev-parse --git-path hooks/commit-msg)"
test -x "$commitmsg" && exec "$commitmsg" ${1+"$@"}
:
</file>

<file path="autoparts-client/.git/hooks/commit-msg.sample">
#!/bin/sh
#
# An example hook script to check the commit log message.
# Called by "git commit" with one argument, the name of the file
# that has the commit message.  The hook should exit with non-zero
# status after issuing an appropriate message if it wants to stop the
# commit.  The hook is allowed to edit the commit message file.
#
# To enable this hook, rename this file to "commit-msg".

# Uncomment the below to add a Signed-off-by line to the message.
# Doing this in a hook is a bad idea in general, but the prepare-commit-msg
# hook is more suited to it.
#
# SOB=$(git var GIT_AUTHOR_IDENT | sed -n 's/^\(.*>\).*$/Signed-off-by: \1/p')
# grep -qs "^$SOB" "$1" || echo "$SOB" >> "$1"

# This example catches duplicate Signed-off-by lines.

test "" = "$(grep '^Signed-off-by: ' "$1" |
	 sort | uniq -c | sed -e '/^[ 	]*1[ 	]/d')" || {
	echo >&2 Duplicate Signed-off-by lines.
	exit 1
}
</file>

<file path="autoparts-client/.git/hooks/fsmonitor-watchman.sample">
#!/usr/bin/perl

use strict;
use warnings;
use IPC::Open2;

# An example hook script to integrate Watchman
# (https://facebook.github.io/watchman/) with git to speed up detecting
# new and modified files.
#
# The hook is passed a version (currently 2) and last update token
# formatted as a string and outputs to stdout a new update token and
# all files that have been modified since the update token. Paths must
# be relative to the root of the working tree and separated by a single NUL.
#
# To enable this hook, rename this file to "query-watchman" and set
# 'git config core.fsmonitor .git/hooks/query-watchman'
#
my ($version, $last_update_token) = @ARGV;

# Uncomment for debugging
# print STDERR "$0 $version $last_update_token\n";

# Check the hook interface version
if ($version ne 2) {
	die "Unsupported query-fsmonitor hook version '$version'.\n" .
	    "Falling back to scanning...\n";
}

my $git_work_tree = get_working_dir();

my $retry = 1;

my $json_pkg;
eval {
	require JSON::XS;
	$json_pkg = "JSON::XS";
	1;
} or do {
	require JSON::PP;
	$json_pkg = "JSON::PP";
};

launch_watchman();

sub launch_watchman {
	my $o = watchman_query();
	if (is_work_tree_watched($o)) {
		output_result($o->{clock}, @{$o->{files}});
	}
}

sub output_result {
	my ($clockid, @files) = @_;

	# Uncomment for debugging watchman output
	# open (my $fh, ">", ".git/watchman-output.out");
	# binmode $fh, ":utf8";
	# print $fh "$clockid\n@files\n";
	# close $fh;

	binmode STDOUT, ":utf8";
	print $clockid;
	print "\0";
	local $, = "\0";
	print @files;
}

sub watchman_clock {
	my $response = qx/watchman clock "$git_work_tree"/;
	die "Failed to get clock id on '$git_work_tree'.\n" .
		"Falling back to scanning...\n" if $? != 0;

	return $json_pkg->new->utf8->decode($response);
}

sub watchman_query {
	my $pid = open2(\*CHLD_OUT, \*CHLD_IN, 'watchman -j --no-pretty')
	or die "open2() failed: $!\n" .
	"Falling back to scanning...\n";

	# In the query expression below we're asking for names of files that
	# changed since $last_update_token but not from the .git folder.
	#
	# To accomplish this, we're using the "since" generator to use the
	# recency index to select candidate nodes and "fields" to limit the
	# output to file names only. Then we're using the "expression" term to
	# further constrain the results.
	my $last_update_line = "";
	if (substr($last_update_token, 0, 1) eq "c") {
		$last_update_token = "\"$last_update_token\"";
		$last_update_line = qq[\n"since": $last_update_token,];
	}
	my $query = <<"	END";
		["query", "$git_work_tree", {$last_update_line
			"fields": ["name"],
			"expression": ["not", ["dirname", ".git"]]
		}]
	END

	# Uncomment for debugging the watchman query
	# open (my $fh, ">", ".git/watchman-query.json");
	# print $fh $query;
	# close $fh;

	print CHLD_IN $query;
	close CHLD_IN;
	my $response = do {local $/; <CHLD_OUT>};

	# Uncomment for debugging the watch response
	# open ($fh, ">", ".git/watchman-response.json");
	# print $fh $response;
	# close $fh;

	die "Watchman: command returned no output.\n" .
	"Falling back to scanning...\n" if $response eq "";
	die "Watchman: command returned invalid output: $response\n" .
	"Falling back to scanning...\n" unless $response =~ /^\{/;

	return $json_pkg->new->utf8->decode($response);
}

sub is_work_tree_watched {
	my ($output) = @_;
	my $error = $output->{error};
	if ($retry > 0 and $error and $error =~ m/unable to resolve root .* directory (.*) is not watched/) {
		$retry--;
		my $response = qx/watchman watch "$git_work_tree"/;
		die "Failed to make watchman watch '$git_work_tree'.\n" .
		    "Falling back to scanning...\n" if $? != 0;
		$output = $json_pkg->new->utf8->decode($response);
		$error = $output->{error};
		die "Watchman: $error.\n" .
		"Falling back to scanning...\n" if $error;

		# Uncomment for debugging watchman output
		# open (my $fh, ">", ".git/watchman-output.out");
		# close $fh;

		# Watchman will always return all files on the first query so
		# return the fast "everything is dirty" flag to git and do the
		# Watchman query just to get it over with now so we won't pay
		# the cost in git to look up each individual file.
		my $o = watchman_clock();
		$error = $output->{error};

		die "Watchman: $error.\n" .
		"Falling back to scanning...\n" if $error;

		output_result($o->{clock}, ("/"));
		$last_update_token = $o->{clock};

		eval { launch_watchman() };
		return 0;
	}

	die "Watchman: $error.\n" .
	"Falling back to scanning...\n" if $error;

	return 1;
}

sub get_working_dir {
	my $working_dir;
	if ($^O =~ 'msys' || $^O =~ 'cygwin') {
		$working_dir = Win32::GetCwd();
		$working_dir =~ tr/\\/\//;
	} else {
		require Cwd;
		$working_dir = Cwd::cwd();
	}

	return $working_dir;
}
</file>

<file path="autoparts-client/.git/hooks/post-update.sample">
#!/bin/sh
#
# An example hook script to prepare a packed repository for use over
# dumb transports.
#
# To enable this hook, rename this file to "post-update".

exec git update-server-info
</file>

<file path="autoparts-client/.git/hooks/pre-applypatch.sample">
#!/bin/sh
#
# An example hook script to verify what is about to be committed
# by applypatch from an e-mail message.
#
# The hook should exit with non-zero status after issuing an
# appropriate message if it wants to stop the commit.
#
# To enable this hook, rename this file to "pre-applypatch".

. git-sh-setup
precommit="$(git rev-parse --git-path hooks/pre-commit)"
test -x "$precommit" && exec "$precommit" ${1+"$@"}
:
</file>

<file path="autoparts-client/.git/hooks/pre-commit.sample">
#!/bin/sh
#
# An example hook script to verify what is about to be committed.
# Called by "git commit" with no arguments.  The hook should
# exit with non-zero status after issuing an appropriate message if
# it wants to stop the commit.
#
# To enable this hook, rename this file to "pre-commit".

if git rev-parse --verify HEAD >/dev/null 2>&1
then
	against=HEAD
else
	# Initial commit: diff against an empty tree object
	against=$(git hash-object -t tree /dev/null)
fi

# If you want to allow non-ASCII filenames set this variable to true.
allownonascii=$(git config --type=bool hooks.allownonascii)

# Redirect output to stderr.
exec 1>&2

# Cross platform projects tend to avoid non-ASCII filenames; prevent
# them from being added to the repository. We exploit the fact that the
# printable range starts at the space character and ends with tilde.
if [ "$allownonascii" != "true" ] &&
	# Note that the use of brackets around a tr range is ok here, (it's
	# even required, for portability to Solaris 10's /usr/bin/tr), since
	# the square bracket bytes happen to fall in the designated range.
	test $(git diff-index --cached --name-only --diff-filter=A -z $against |
	  LC_ALL=C tr -d '[ -~]\0' | wc -c) != 0
then
	cat <<\EOF
Error: Attempt to add a non-ASCII file name.

This can cause problems if you want to work with people on other platforms.

To be portable it is advisable to rename the file.

If you know what you are doing you can disable this check using:

  git config hooks.allownonascii true
EOF
	exit 1
fi

# If there are whitespace errors, print the offending file names and fail.
exec git diff-index --check --cached $against --
</file>

<file path="autoparts-client/.git/hooks/pre-merge-commit.sample">
#!/bin/sh
#
# An example hook script to verify what is about to be committed.
# Called by "git merge" with no arguments.  The hook should
# exit with non-zero status after issuing an appropriate message to
# stderr if it wants to stop the merge commit.
#
# To enable this hook, rename this file to "pre-merge-commit".

. git-sh-setup
test -x "$GIT_DIR/hooks/pre-commit" &&
        exec "$GIT_DIR/hooks/pre-commit"
:
</file>

<file path="autoparts-client/.git/hooks/pre-push.sample">
#!/bin/sh

# An example hook script to verify what is about to be pushed.  Called by "git
# push" after it has checked the remote status, but before anything has been
# pushed.  If this script exits with a non-zero status nothing will be pushed.
#
# This hook is called with the following parameters:
#
# $1 -- Name of the remote to which the push is being done
# $2 -- URL to which the push is being done
#
# If pushing without using a named remote those arguments will be equal.
#
# Information about the commits which are being pushed is supplied as lines to
# the standard input in the form:
#
#   <local ref> <local oid> <remote ref> <remote oid>
#
# This sample shows how to prevent push of commits where the log message starts
# with "WIP" (work in progress).

remote="$1"
url="$2"

zero=$(git hash-object --stdin </dev/null | tr '[0-9a-f]' '0')

while read local_ref local_oid remote_ref remote_oid
do
	if test "$local_oid" = "$zero"
	then
		# Handle delete
		:
	else
		if test "$remote_oid" = "$zero"
		then
			# New branch, examine all commits
			range="$local_oid"
		else
			# Update to existing branch, examine new commits
			range="$remote_oid..$local_oid"
		fi

		# Check for WIP commit
		commit=$(git rev-list -n 1 --grep '^WIP' "$range")
		if test -n "$commit"
		then
			echo >&2 "Found WIP commit in $local_ref, not pushing"
			exit 1
		fi
	fi
done

exit 0
</file>

<file path="autoparts-client/.git/hooks/pre-rebase.sample">
#!/bin/sh
#
# Copyright (c) 2006, 2008 Junio C Hamano
#
# The "pre-rebase" hook is run just before "git rebase" starts doing
# its job, and can prevent the command from running by exiting with
# non-zero status.
#
# The hook is called with the following parameters:
#
# $1 -- the upstream the series was forked from.
# $2 -- the branch being rebased (or empty when rebasing the current branch).
#
# This sample shows how to prevent topic branches that are already
# merged to 'next' branch from getting rebased, because allowing it
# would result in rebasing already published history.

publish=next
basebranch="$1"
if test "$#" = 2
then
	topic="refs/heads/$2"
else
	topic=`git symbolic-ref HEAD` ||
	exit 0 ;# we do not interrupt rebasing detached HEAD
fi

case "$topic" in
refs/heads/??/*)
	;;
*)
	exit 0 ;# we do not interrupt others.
	;;
esac

# Now we are dealing with a topic branch being rebased
# on top of master.  Is it OK to rebase it?

# Does the topic really exist?
git show-ref -q "$topic" || {
	echo >&2 "No such branch $topic"
	exit 1
}

# Is topic fully merged to master?
not_in_master=`git rev-list --pretty=oneline ^master "$topic"`
if test -z "$not_in_master"
then
	echo >&2 "$topic is fully merged to master; better remove it."
	exit 1 ;# we could allow it, but there is no point.
fi

# Is topic ever merged to next?  If so you should not be rebasing it.
only_next_1=`git rev-list ^master "^$topic" ${publish} | sort`
only_next_2=`git rev-list ^master           ${publish} | sort`
if test "$only_next_1" = "$only_next_2"
then
	not_in_topic=`git rev-list "^$topic" master`
	if test -z "$not_in_topic"
	then
		echo >&2 "$topic is already up to date with master"
		exit 1 ;# we could allow it, but there is no point.
	else
		exit 0
	fi
else
	not_in_next=`git rev-list --pretty=oneline ^${publish} "$topic"`
	/usr/bin/perl -e '
		my $topic = $ARGV[0];
		my $msg = "* $topic has commits already merged to public branch:\n";
		my (%not_in_next) = map {
			/^([0-9a-f]+) /;
			($1 => 1);
		} split(/\n/, $ARGV[1]);
		for my $elem (map {
				/^([0-9a-f]+) (.*)$/;
				[$1 => $2];
			} split(/\n/, $ARGV[2])) {
			if (!exists $not_in_next{$elem->[0]}) {
				if ($msg) {
					print STDERR $msg;
					undef $msg;
				}
				print STDERR " $elem->[1]\n";
			}
		}
	' "$topic" "$not_in_next" "$not_in_master"
	exit 1
fi

<<\DOC_END

This sample hook safeguards topic branches that have been
published from being rewound.

The workflow assumed here is:

 * Once a topic branch forks from "master", "master" is never
   merged into it again (either directly or indirectly).

 * Once a topic branch is fully cooked and merged into "master",
   it is deleted.  If you need to build on top of it to correct
   earlier mistakes, a new topic branch is created by forking at
   the tip of the "master".  This is not strictly necessary, but
   it makes it easier to keep your history simple.

 * Whenever you need to test or publish your changes to topic
   branches, merge them into "next" branch.

The script, being an example, hardcodes the publish branch name
to be "next", but it is trivial to make it configurable via
$GIT_DIR/config mechanism.

With this workflow, you would want to know:

(1) ... if a topic branch has ever been merged to "next".  Young
    topic branches can have stupid mistakes you would rather
    clean up before publishing, and things that have not been
    merged into other branches can be easily rebased without
    affecting other people.  But once it is published, you would
    not want to rewind it.

(2) ... if a topic branch has been fully merged to "master".
    Then you can delete it.  More importantly, you should not
    build on top of it -- other people may already want to
    change things related to the topic as patches against your
    "master", so if you need further changes, it is better to
    fork the topic (perhaps with the same name) afresh from the
    tip of "master".

Let's look at this example:

		   o---o---o---o---o---o---o---o---o---o "next"
		  /       /           /           /
		 /   a---a---b A     /           /
		/   /               /           /
	       /   /   c---c---c---c B         /
	      /   /   /             \         /
	     /   /   /   b---b C     \       /
	    /   /   /   /             \     /
    ---o---o---o---o---o---o---o---o---o---o---o "master"


A, B and C are topic branches.

 * A has one fix since it was merged up to "next".

 * B has finished.  It has been fully merged up to "master" and "next",
   and is ready to be deleted.

 * C has not merged to "next" at all.

We would want to allow C to be rebased, refuse A, and encourage
B to be deleted.

To compute (1):

	git rev-list ^master ^topic next
	git rev-list ^master        next

	if these match, topic has not merged in next at all.

To compute (2):

	git rev-list master..topic

	if this is empty, it is fully merged to "master".

DOC_END
</file>

<file path="autoparts-client/.git/hooks/pre-receive.sample">
#!/bin/sh
#
# An example hook script to make use of push options.
# The example simply echoes all push options that start with 'echoback='
# and rejects all pushes when the "reject" push option is used.
#
# To enable this hook, rename this file to "pre-receive".

if test -n "$GIT_PUSH_OPTION_COUNT"
then
	i=0
	while test "$i" -lt "$GIT_PUSH_OPTION_COUNT"
	do
		eval "value=\$GIT_PUSH_OPTION_$i"
		case "$value" in
		echoback=*)
			echo "echo from the pre-receive-hook: ${value#*=}" >&2
			;;
		reject)
			exit 1
		esac
		i=$((i + 1))
	done
fi
</file>

<file path="autoparts-client/.git/hooks/prepare-commit-msg.sample">
#!/bin/sh
#
# An example hook script to prepare the commit log message.
# Called by "git commit" with the name of the file that has the
# commit message, followed by the description of the commit
# message's source.  The hook's purpose is to edit the commit
# message file.  If the hook fails with a non-zero status,
# the commit is aborted.
#
# To enable this hook, rename this file to "prepare-commit-msg".

# This hook includes three examples. The first one removes the
# "# Please enter the commit message..." help message.
#
# The second includes the output of "git diff --name-status -r"
# into the message, just before the "git status" output.  It is
# commented because it doesn't cope with --amend or with squashed
# commits.
#
# The third example adds a Signed-off-by line to the message, that can
# still be edited.  This is rarely a good idea.

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2
SHA1=$3

/usr/bin/perl -i.bak -ne 'print unless(m/^. Please enter the commit message/..m/^#$/)' "$COMMIT_MSG_FILE"

# case "$COMMIT_SOURCE,$SHA1" in
#  ,|template,)
#    /usr/bin/perl -i.bak -pe '
#       print "\n" . `git diff --cached --name-status -r`
# 	 if /^#/ && $first++ == 0' "$COMMIT_MSG_FILE" ;;
#  *) ;;
# esac

# SOB=$(git var GIT_COMMITTER_IDENT | sed -n 's/^\(.*>\).*$/Signed-off-by: \1/p')
# git interpret-trailers --in-place --trailer "$SOB" "$COMMIT_MSG_FILE"
# if test -z "$COMMIT_SOURCE"
# then
#   /usr/bin/perl -i.bak -pe 'print "\n" if !$first_line++' "$COMMIT_MSG_FILE"
# fi
</file>

<file path="autoparts-client/.git/hooks/push-to-checkout.sample">
#!/bin/sh

# An example hook script to update a checked-out tree on a git push.
#
# This hook is invoked by git-receive-pack(1) when it reacts to git
# push and updates reference(s) in its repository, and when the push
# tries to update the branch that is currently checked out and the
# receive.denyCurrentBranch configuration variable is set to
# updateInstead.
#
# By default, such a push is refused if the working tree and the index
# of the remote repository has any difference from the currently
# checked out commit; when both the working tree and the index match
# the current commit, they are updated to match the newly pushed tip
# of the branch. This hook is to be used to override the default
# behaviour; however the code below reimplements the default behaviour
# as a starting point for convenient modification.
#
# The hook receives the commit with which the tip of the current
# branch is going to be updated:
commit=$1

# It can exit with a non-zero status to refuse the push (when it does
# so, it must not modify the index or the working tree).
die () {
	echo >&2 "$*"
	exit 1
}

# Or it can make any necessary changes to the working tree and to the
# index to bring them to the desired state when the tip of the current
# branch is updated to the new commit, and exit with a zero status.
#
# For example, the hook can simply run git read-tree -u -m HEAD "$1"
# in order to emulate git fetch that is run in the reverse direction
# with git push, as the two-tree form of git read-tree -u -m is
# essentially the same as git switch or git checkout that switches
# branches while keeping the local changes in the working tree that do
# not interfere with the difference between the branches.

# The below is a more-or-less exact translation to shell of the C code
# for the default behaviour for git's push-to-checkout hook defined in
# the push_to_deploy() function in builtin/receive-pack.c.
#
# Note that the hook will be executed from the repository directory,
# not from the working tree, so if you want to perform operations on
# the working tree, you will have to adapt your code accordingly, e.g.
# by adding "cd .." or using relative paths.

if ! git update-index -q --ignore-submodules --refresh
then
	die "Up-to-date check failed"
fi

if ! git diff-files --quiet --ignore-submodules --
then
	die "Working directory has unstaged changes"
fi

# This is a rough translation of:
#
#   head_has_history() ? "HEAD" : EMPTY_TREE_SHA1_HEX
if git cat-file -e HEAD 2>/dev/null
then
	head=HEAD
else
	head=$(git hash-object -t tree --stdin </dev/null)
fi

if ! git diff-index --quiet --cached --ignore-submodules $head --
then
	die "Working directory has staged changes"
fi

if ! git read-tree -u -m "$commit"
then
	die "Could not update working tree to new HEAD"
fi
</file>

<file path="autoparts-client/.git/hooks/sendemail-validate.sample">
#!/bin/sh

# An example hook script to validate a patch (and/or patch series) before
# sending it via email.
#
# The hook should exit with non-zero status after issuing an appropriate
# message if it wants to prevent the email(s) from being sent.
#
# To enable this hook, rename this file to "sendemail-validate".
#
# By default, it will only check that the patch(es) can be applied on top of
# the default upstream branch without conflicts in a secondary worktree. After
# validation (successful or not) of the last patch of a series, the worktree
# will be deleted.
#
# The following config variables can be set to change the default remote and
# remote ref that are used to apply the patches against:
#
#   sendemail.validateRemote (default: origin)
#   sendemail.validateRemoteRef (default: HEAD)
#
# Replace the TODO placeholders with appropriate checks according to your
# needs.

validate_cover_letter () {
	file="$1"
	# TODO: Replace with appropriate checks (e.g. spell checking).
	true
}

validate_patch () {
	file="$1"
	# Ensure that the patch applies without conflicts.
	git am -3 "$file" || return
	# TODO: Replace with appropriate checks for this patch
	# (e.g. checkpatch.pl).
	true
}

validate_series () {
	# TODO: Replace with appropriate checks for the whole series
	# (e.g. quick build, coding style checks, etc.).
	true
}

# main -------------------------------------------------------------------------

if test "$GIT_SENDEMAIL_FILE_COUNTER" = 1
then
	remote=$(git config --default origin --get sendemail.validateRemote) &&
	ref=$(git config --default HEAD --get sendemail.validateRemoteRef) &&
	worktree=$(mktemp --tmpdir -d sendemail-validate.XXXXXXX) &&
	git worktree add -fd --checkout "$worktree" "refs/remotes/$remote/$ref" &&
	git config --replace-all sendemail.validateWorktree "$worktree"
else
	worktree=$(git config --get sendemail.validateWorktree)
fi || {
	echo "sendemail-validate: error: failed to prepare worktree" >&2
	exit 1
}

unset GIT_DIR GIT_WORK_TREE
cd "$worktree" &&

if grep -q "^diff --git " "$1"
then
	validate_patch "$1"
else
	validate_cover_letter "$1"
fi &&

if test "$GIT_SENDEMAIL_FILE_COUNTER" = "$GIT_SENDEMAIL_FILE_TOTAL"
then
	git config --unset-all sendemail.validateWorktree &&
	trap 'git worktree remove -ff "$worktree"' EXIT &&
	validate_series
fi
</file>

<file path="autoparts-client/.git/hooks/update.sample">
#!/bin/sh
#
# An example hook script to block unannotated tags from entering.
# Called by "git receive-pack" with arguments: refname sha1-old sha1-new
#
# To enable this hook, rename this file to "update".
#
# Config
# ------
# hooks.allowunannotated
#   This boolean sets whether unannotated tags will be allowed into the
#   repository.  By default they won't be.
# hooks.allowdeletetag
#   This boolean sets whether deleting tags will be allowed in the
#   repository.  By default they won't be.
# hooks.allowmodifytag
#   This boolean sets whether a tag may be modified after creation. By default
#   it won't be.
# hooks.allowdeletebranch
#   This boolean sets whether deleting branches will be allowed in the
#   repository.  By default they won't be.
# hooks.denycreatebranch
#   This boolean sets whether remotely creating branches will be denied
#   in the repository.  By default this is allowed.
#

# --- Command line
refname="$1"
oldrev="$2"
newrev="$3"

# --- Safety check
if [ -z "$GIT_DIR" ]; then
	echo "Don't run this script from the command line." >&2
	echo " (if you want, you could supply GIT_DIR then run" >&2
	echo "  $0 <ref> <oldrev> <newrev>)" >&2
	exit 1
fi

if [ -z "$refname" -o -z "$oldrev" -o -z "$newrev" ]; then
	echo "usage: $0 <ref> <oldrev> <newrev>" >&2
	exit 1
fi

# --- Config
allowunannotated=$(git config --type=bool hooks.allowunannotated)
allowdeletebranch=$(git config --type=bool hooks.allowdeletebranch)
denycreatebranch=$(git config --type=bool hooks.denycreatebranch)
allowdeletetag=$(git config --type=bool hooks.allowdeletetag)
allowmodifytag=$(git config --type=bool hooks.allowmodifytag)

# check for no description
projectdesc=$(sed -e '1q' "$GIT_DIR/description")
case "$projectdesc" in
"Unnamed repository"* | "")
	echo "*** Project description file hasn't been set" >&2
	exit 1
	;;
esac

# --- Check types
# if $newrev is 0000...0000, it's a commit to delete a ref.
zero=$(git hash-object --stdin </dev/null | tr '[0-9a-f]' '0')
if [ "$newrev" = "$zero" ]; then
	newrev_type=delete
else
	newrev_type=$(git cat-file -t $newrev)
fi

case "$refname","$newrev_type" in
	refs/tags/*,commit)
		# un-annotated tag
		short_refname=${refname##refs/tags/}
		if [ "$allowunannotated" != "true" ]; then
			echo "*** The un-annotated tag, $short_refname, is not allowed in this repository" >&2
			echo "*** Use 'git tag [ -a | -s ]' for tags you want to propagate." >&2
			exit 1
		fi
		;;
	refs/tags/*,delete)
		# delete tag
		if [ "$allowdeletetag" != "true" ]; then
			echo "*** Deleting a tag is not allowed in this repository" >&2
			exit 1
		fi
		;;
	refs/tags/*,tag)
		# annotated tag
		if [ "$allowmodifytag" != "true" ] && git rev-parse $refname > /dev/null 2>&1
		then
			echo "*** Tag '$refname' already exists." >&2
			echo "*** Modifying a tag is not allowed in this repository." >&2
			exit 1
		fi
		;;
	refs/heads/*,commit)
		# branch
		if [ "$oldrev" = "$zero" -a "$denycreatebranch" = "true" ]; then
			echo "*** Creating a branch is not allowed in this repository" >&2
			exit 1
		fi
		;;
	refs/heads/*,delete)
		# delete branch
		if [ "$allowdeletebranch" != "true" ]; then
			echo "*** Deleting a branch is not allowed in this repository" >&2
			exit 1
		fi
		;;
	refs/remotes/*,commit)
		# tracking branch
		;;
	refs/remotes/*,delete)
		# delete tracking branch
		if [ "$allowdeletebranch" != "true" ]; then
			echo "*** Deleting a tracking branch is not allowed in this repository" >&2
			exit 1
		fi
		;;
	*)
		# Anything else (is there anything else?)
		echo "*** Update hook: unknown type of update to ref $refname of type $newrev_type" >&2
		exit 1
		;;
esac

# --- Finished
exit 0
</file>

<file path="autoparts-client/.git/info/exclude">
# git ls-files --others --exclude-from=.git/info/exclude
# Lines that start with '#' are comments.
# For a project mostly in C, the following would be a good set of
# exclude patterns (uncomment them if you want to use them):
# *.[oa]
# *~
</file>

<file path="autoparts-client/.git/logs/refs/heads/main">
0000000000000000000000000000000000000000 e40f46b4d14ab6dbc4a92b24470cbc97c7a0f597 Syomin Nikolay <youfuckupmylifee@mail.ru> 1769580347 +0500	commit (initial): initial commit
</file>

<file path="autoparts-client/.git/logs/HEAD">
0000000000000000000000000000000000000000 e40f46b4d14ab6dbc4a92b24470cbc97c7a0f597 Syomin Nikolay <youfuckupmylifee@mail.ru> 1769580347 +0500	commit (initial): initial commit
</file>

<file path="autoparts-client/.git/refs/heads/main">
e40f46b4d14ab6dbc4a92b24470cbc97c7a0f597
</file>

<file path="autoparts-client/.git/COMMIT_EDITMSG">
initial commit
</file>

<file path="autoparts-client/.git/config">
[core]
	repositoryformatversion = 0
	filemode = true
	bare = false
	logallrefupdates = true
	ignorecase = true
	precomposeunicode = true
</file>

<file path="autoparts-client/.git/description">
Unnamed repository; edit this file 'description' to name the repository.
</file>

<file path="autoparts-client/.git/HEAD">
ref: refs/heads/main
</file>

<file path="autoparts-client/src/app/core/auth/auth.service.ts">
import { Injectable, signal, inject } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Router } from '@angular/router';
import { Observable, tap, of, catchError } from 'rxjs';
import { AuthRequest, AuthResponse, RegisterRequest, User } from '../models/auth.models';
import { environment } from '../../environments/environment';

@Injectable({
  providedIn: 'root'
})
export class AuthService {
  private readonly apiUrl = `${environment.apiUrl}/auth`;
  private readonly tokenKey = 'auth_token';

  private http = inject(HttpClient);
  private router = inject(Router);

  currentUserSig = signal<User | null>(null);

  constructor() {
    if (this.getToken()) {
      this.getProfile().subscribe({
        error: () => this.logout()
      });
    }
  }

  register(request: RegisterRequest): Observable<AuthResponse> {
    return this.http.post<AuthResponse>(`${this.apiUrl}/register`, request).pipe(
      tap(response => {
        localStorage.setItem(this.tokenKey, response.token);
        this.getProfile().subscribe();
        this.router.navigate(['/']);
      })
    );
  }

  login(request: AuthRequest): Observable<AuthResponse> {
    return this.http.post<AuthResponse>(`${this.apiUrl}/login`, request).pipe(
      tap(response => {
        localStorage.setItem(this.tokenKey, response.token);
        this.getProfile().subscribe();
        this.router.navigate(['/profile']);
      })
    );
  }

  getProfile(): Observable<User> {
    return this.http.get<User>(`${this.apiUrl}/me`).pipe(
      tap(user => {
        console.log('User loaded:', user);
        this.currentUserSig.set(user);
      })
    );
  }

  logout(): void {
    localStorage.removeItem(this.tokenKey);
    this.currentUserSig.set(null);
    this.router.navigate(['/login']);
  }

  isAdmin(): boolean {
    const payload = this.getPayload();
    console.log('Данные из токена:', payload);
    return payload?.role === 'ADMIN';
  }

   private getPayload(): any {
    const token = this.getToken();
    if (!token) return null;
    try {
      const base64Url = token.split('.')[1];

      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');

      const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));

      return JSON.parse(jsonPayload);
    } catch (e) {
      console.error('Ошибка парсинга токена:', e);
      return null;
    }
  }

  getToken(): string | null {
    return localStorage.getItem(this.tokenKey);
  }

  isAuthenticated(): boolean {
    return !!this.getToken();
  }
}
</file>

<file path="autoparts-client/src/app/core/guards/admin.guard.ts">
import { CanActivateFn, Router } from '@angular/router';
import { inject } from '@angular/core';
import { AuthService } from '../auth/auth.service';
import { MessageService } from 'primeng/api';

export const adminGuard: CanActivateFn = (route, state) => {
  const authService = inject(AuthService);
  const router = inject(Router);
  const messageService = inject(MessageService);

  if (authService.isAuthenticated() && authService.isAdmin()) {
    return true;
  }

  messageService.add({
    severity: 'error',
    summary: 'Доступ запрещен',
    detail: 'Требуются права администратора'
  });
  router.navigate(['/']);
  return false;
};
</file>

<file path="autoparts-client/src/app/core/guards/guest.guard.ts">
import { CanActivateFn, Router } from '@angular/router';
import { inject } from '@angular/core';
import { AuthService } from '../auth/auth.service';

export const guestGuard: CanActivateFn = (route, state) => {
  const authService = inject(AuthService);
  const router = inject(Router);

  if (authService.isAuthenticated()) {
    router.navigate(['/profile']);
    return false;
  }
  return true;
};
</file>

<file path="autoparts-client/src/app/core/interceptors/auth.interceptor.ts">
import { HttpInterceptorFn } from '@angular/common/http';

export const authInterceptor: HttpInterceptorFn = (req, next) => {
  const token = localStorage.getItem('auth_token');

  if (token) {
    const clonedReq = req.clone({
      setHeaders: {
        Authorization: `Bearer ${token}`
      }
    });
    return next(clonedReq);
  }

  return next(req);
};
</file>

<file path="autoparts-client/src/app/core/models/auth.models.ts">
export interface AuthRequest {
  phone: string;
  password: string;
}

export interface RegisterRequest {
  phone: string;
  password: string;
  firstName: string;
  lastName: string;
}

export interface AuthResponse {
  token: string;
}

export interface JwtPayload {
  sub: string;
  exp: number;
  iat: number;
  role?: string;
}

export interface User {
  id: number;
  phone: string;
  firstName: string;
  lastName: string;
  role: string;
  balance: number;
}
</file>

<file path="autoparts-client/src/app/core/models/cart.models.ts">
export interface CartDto {
  items: CartItemDto[];
  totalPrice: number;
}

export interface CartItemDto {
  id: number;
  productId: number;
  sku: string;
  name: string;
  imageUrl: string | null;
  quantity: number;
  price: number;
  sum: number;
}
</file>

<file path="autoparts-client/src/app/core/models/catalog.models.ts">
export interface CategoryDto {
  id: number;
  name: string;
  parentId: number | null;
  children: CategoryDto[];
}

export interface ProductDto {
  id: number;
  sku: string;
  name: string;
  description: string;
  price: number;
  stockQuantity: number;
  imageUrl: string | null;
  categoryName: string;
  categoryId: number;
}
</file>

<file path="autoparts-client/src/app/core/services/cart.service.ts">
import { Injectable, inject, signal } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { tap } from 'rxjs';
import { environment } from '../../environments/environment';
import { CartDto } from '../models/cart.models';
import { MessageService } from 'primeng/api';

@Injectable({
  providedIn: 'root'
})
export class CartService {
  private http = inject(HttpClient);
  private messageService = inject(MessageService);
  private apiUrl = `${environment.apiUrl}/api/v1/cart`;

  cartCountSig = signal<number>(0);
  cartSig = signal<CartDto | null>(null);

  getCart() {
    return this.http.get<CartDto>(this.apiUrl).pipe(
      tap(cart => this.updateState(cart))
    );
  }

  addToCart(productId: number, quantity: number = 1) {
    return this.http.post<CartDto>(`${this.apiUrl}/items`, { productId, quantity }).pipe(
      tap(cart => {
        this.updateState(cart);
      })
    );
  }

  removeItem(cartItemId: number) {
    return this.http.delete<CartDto>(`${this.apiUrl}/items/${cartItemId}`).pipe(
      tap(cart => {
        this.updateState(cart);
        this.messageService.add({ severity: 'info', summary: 'Корзина', detail: 'Товар удален' });
      })
    );
  }

  clearCart() {
    return this.http.delete<void>(this.apiUrl).pipe(
      tap(() => {
        this.updateState({ items: [], totalPrice: 0 });
      })
    );
  }

  private updateState(cart: CartDto) {
    this.cartSig.set(cart);
    const count = cart.items.reduce((acc, item) => acc + item.quantity, 0);
    this.cartCountSig.set(count);
  }
}
</file>

<file path="autoparts-client/src/app/core/services/category.service.ts">
import { Injectable, inject } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { map, Observable } from 'rxjs';
import { environment } from '../../environments/environment';
import { CategoryDto } from '../models/catalog.models';
import { TreeNode } from 'primeng/api';

@Injectable({
  providedIn: 'root'
})
export class CategoryService {
  private http = inject(HttpClient);
  private apiUrl = `${environment.apiUrl}/api/v1/categories`;

  getTree(): Observable<TreeNode[]> {
    return this.http.get<CategoryDto[]>(this.apiUrl).pipe(
      map(categories => categories.map(c => this.mapToTreeNode(c)))
    );
  }

  private mapToTreeNode(dto: CategoryDto): TreeNode {
    return {
      label: dto.name,
      data: dto.id,
      key: dto.id.toString(),
      expandedIcon: 'pi pi-folder-open',
      collapsedIcon: 'pi pi-folder',
      children: dto.children ? dto.children.map(c => this.mapToTreeNode(c)) : []
    };
  }

  create(name: string, parentId: number | null): Observable<void> {
    const params: any = { name };
    if (parentId) params.parentId = parentId;
    return this.http.post<void>(this.apiUrl, null, { params });
  }

  update(id: number, name: string, parentId: number | null): Observable<void> {
    const params: any = { name };
    if (parentId) params.parentId = parentId;
    return this.http.put<void>(`${this.apiUrl}/${id}`, null, { params });
  }

  delete(id: number): Observable<void> {
    return this.http.delete<void>(`${this.apiUrl}/${id}`);
  }
}
</file>

<file path="autoparts-client/src/app/core/services/order.service.ts">
import { Injectable, inject } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { environment } from '../../environments/environment';
import { Observable } from 'rxjs';
import { CartItemDto } from '../models/cart.models';

export interface OrderDto {
  id: number;
  status: string;
  totalPrice: number;
  createdAt: string;
  contactPhone: string;
  items: CartItemDto[];
}

@Injectable({
  providedIn: 'root'
})
export class OrderService {
  private http = inject(HttpClient);
  private apiUrl = `${environment.apiUrl}/api/v1/orders`;

  createOrder(): Observable<OrderDto> {
    return this.http.post<OrderDto>(this.apiUrl, {});
  }

  getOrders(): Observable<OrderDto[]> {
    return this.http.get<OrderDto[]>(this.apiUrl);
  }

  updateStatus(id: number, status: string): Observable<void> {
    return this.http.patch<void>(`${this.apiUrl}/${id}/status`, null, {
      params: { status }
    });
  }
}
</file>

<file path="autoparts-client/src/app/core/services/product.service.ts">
import { Injectable, inject } from '@angular/core';
import { HttpClient, HttpParams } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../environments/environment';
import { ProductDto } from '../models/catalog.models';

@Injectable({
  providedIn: 'root'
})
export class ProductService {
  private http = inject(HttpClient);
  private apiUrl = `${environment.apiUrl}/api/v1/products`;

  getAll(categoryId?: number, query?: string): Observable<ProductDto[]> {
    let params = new HttpParams();

    if (categoryId) {
      params = params.set('categoryId', categoryId.toString());
    }
    if (query) {
      params = params.set('query', query);
    }

    return this.http.get<ProductDto[]>(this.apiUrl, { params });
  }

  create(product: any): Observable<ProductDto> {
    return this.http.post<ProductDto>(this.apiUrl, product);
  }

  update(id: number, product: any): Observable<ProductDto> {
    return this.http.put<ProductDto>(`${this.apiUrl}/${id}`, product);
  }

  delete(id: number): Observable<void> {
    return this.http.delete<void>(`${this.apiUrl}/${id}`);
  }
}
</file>

<file path="autoparts-client/src/app/environments/environment.ts">
export const environment = {
  production: false,
  apiUrl: 'http://localhost:8080'
};
</file>

<file path="autoparts-client/src/app/features/admin/admin-layout/admin-layout.component.ts">
import { Component, inject } from '@angular/core';
import { Router, RouterLink, RouterOutlet } from '@angular/router';
import { CommonModule } from '@angular/common';
import { AuthService } from '../../../core/auth/auth.service';

import { TabMenuModule } from 'primeng/tabmenu';
import { MenuItem } from 'primeng/api';
import { ButtonModule } from 'primeng/button';
import { AvatarModule } from 'primeng/avatar';

@Component({
  selector: 'app-admin-layout',
  standalone: true,
  imports: [CommonModule, RouterOutlet, RouterLink, TabMenuModule, ButtonModule, AvatarModule],
  template: `
    <div class="min-h-screen bg-[#F8F9FA] flex flex-col">

      <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-[1600px] mx-auto px-4 sm:px-6 h-16 flex items-center justify-between">

          <div class="flex items-center gap-6">
            <div class="flex items-center gap-2 text-gray-900">
              <div class="w-8 h-8 bg-gray-900 rounded-lg flex items-center justify-center text-white">
                <i class="pi pi-cog spin-slow"></i>
              </div>
              <span class="font-bold text-lg tracking-tight">AdminPanel</span>
            </div>

            <div class="h-6 w-px bg-gray-200"></div>

            <a routerLink="/" class="text-sm text-gray-500 hover:text-blue-600 transition-colors flex items-center gap-2 group">
              <i class="pi pi-arrow-left group-hover:-translate-x-1 transition-transform"></i>
              В магазин
            </a>
          </div>

          <div class="flex items-center gap-4">
            <div class="hidden md:flex flex-col items-end">
              <span class="text-sm font-bold text-gray-800">Администратор</span>
              <span class="text-xs text-gray-500">Super User</span>
            </div>
            <p-avatar icon="pi pi-user" shape="circle" styleClass="bg-blue-100 text-blue-600"></p-avatar>
            <button
                pButton
                icon="pi pi-sign-out"
                class="p-button-rounded p-button-text p-button-secondary text-gray-400 hover:text-red-500"
                (click)="logout()"
                pTooltip="Выйти">
            </button>
          </div>

        </div>
      </header>

      <div class="bg-white border-b border-gray-200">
        <div class="max-w-[1600px] mx-auto px-4 sm:px-6">
          <p-tabMenu [model]="items" styleClass="custom-tabmenu border-none"></p-tabMenu>
        </div>
      </div>

      <main class="flex-1 w-full max-w-[1600px] mx-auto p-4 sm:p-6 fade-in">
        <router-outlet></router-outlet>
      </main>

    </div>
  `,
  styles: [`
    .spin-slow { animation: spin 10s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Кастомизация TabMenu под стиль Tailwind */
    :host ::ng-deep .custom-tabmenu .p-tabmenu-nav {
      background: transparent;
      border: none;
    }
    :host ::ng-deep .custom-tabmenu .p-tabmenuitem .p-menuitem-link {
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: #6B7280; /* gray-500 */
      padding: 1rem 1.5rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    :host ::ng-deep .custom-tabmenu .p-tabmenuitem.p-highlight .p-menuitem-link {
      color: #2563EB; /* blue-600 */
      border-color: #2563EB;
      background: transparent;
    }
    :host ::ng-deep .custom-tabmenu .p-tabmenuitem .p-menuitem-link:hover {
      color: #111827; /* gray-900 */
      background: #F9FAFB;
    }
    :host ::ng-deep .custom-tabmenu .p-menuitem-icon {
      margin-right: 0.5rem;
    }
  `]
})
export class AdminLayoutComponent {
  private authService = inject(AuthService);
  private router = inject(Router);

  items: MenuItem[] = [
    { label: 'Заказы', icon: 'pi pi-shopping-bag', routerLink: '/admin/orders' },
    { label: 'Товары', icon: 'pi pi-box', routerLink: '/admin/products' },
    { label: 'Категории', icon: 'pi pi-list', routerLink: '/admin/categories' }
  ];

  logout() {
    this.authService.logout();
    this.router.navigate(['/login']);
  }
}
</file>

<file path="autoparts-client/src/app/features/admin/categories/admin-categories.component.ts">
import { Component, inject, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { CategoryService } from '../../../core/services/category.service';
import { TreeNode, MessageService, MenuItem } from 'primeng/api';

import { TreeModule } from 'primeng/tree';
import { ButtonModule } from 'primeng/button';
import { DialogModule } from 'primeng/dialog';
import { InputTextModule } from 'primeng/inputtext';
import { ContextMenuModule } from 'primeng/contextmenu';
import { TooltipModule } from 'primeng/tooltip';

@Component({
  selector: 'app-admin-categories',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    TreeModule,
    ButtonModule,
    DialogModule,
    InputTextModule,
    ContextMenuModule,
    TooltipModule
  ],
  template: `
    <div class="space-y-6">

        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Категории</h1>
                <p class="text-gray-500 text-sm mt-1">Структура каталога товаров</p>
            </div>

            <button
                pButton
                label="Создать корневую категорию"
                icon="pi pi-plus"
                class="bg-blue-600 border-none hover:bg-blue-700 shadow-lg shadow-blue-600/30 px-5 py-3 rounded-xl font-bold transition-all hover:-translate-y-0.5"
                (click)="openDialog(null)">
            </button>
        </div>

        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden p-6 min-h-[500px]">

            <div class="mb-4 p-4 bg-blue-50 rounded-xl border border-blue-100 text-blue-800 text-sm flex items-center gap-3">
                <i class="pi pi-info-circle text-lg"></i>
                <span>Нажмите <strong>правую кнопку мыши</strong> на категории, чтобы добавить подкатегорию, изменить или удалить её.</span>
            </div>

            <p-tree
                [value]="categories"
                selectionMode="single"
                [(selection)]="selectedNode"
                [contextMenu]="cm"
                styleClass="w-full border-none p-0 custom-tree"
                [filter]="true"
                filterPlaceholder="Поиск категории..."
                filterMode="lenient"
            >
                <ng-template let-node pTemplate="default">
                    <div class="flex items-center gap-2 py-1 w-full">
                        <i class="pi text-yellow-500" [ngClass]="node.expanded ? 'pi-folder-open' : 'pi-folder'"></i>
                        <span class="font-medium text-gray-700">{{ node.label }}</span>
                        <span *ngIf="node.children?.length" class="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full ml-2">
                            {{ node.children.length }}
                        </span>
                    </div>
                </ng-template>
            </p-tree>

            <p-contextMenu #cm [model]="menuItems" styleClass="custom-context-menu"></p-contextMenu>
        </div>

      <p-dialog
        [(visible)]="displayDialog"
        [header]="editMode ? 'Редактировать категорию' : 'Новая категория'"
        [modal]="true"
        [style]="{width: '450px'}"
        styleClass="p-fluid custom-dialog"
        [draggable]="false"
        [resizable]="false"
        [closeOnEscape]="true"
        [dismissableMask]="true"
      >
        <div class="flex flex-col gap-5 pt-2">

          <div class="field">
            <label class="font-bold text-gray-700 mb-1 block">Название категории</label>
            <input
                pInputText
                [(ngModel)]="categoryName"
                autofocus
                class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all"
                placeholder="Например: Двигатель"
            />
          </div>

          <div *ngIf="parentNode && !editMode" class="p-3 bg-gray-50 rounded-xl border border-gray-200 flex items-center gap-3">
             <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center border border-gray-200">
                 <i class="pi pi-folder-open text-yellow-500 text-xl"></i>
             </div>
             <div>
                 <span class="text-xs text-gray-500 uppercase font-bold tracking-wider">Родитель</span>
                 <div class="font-bold text-gray-800">{{ parentNode.label }}</div>
             </div>
          </div>

        </div>

        <ng-template pTemplate="footer">
            <div class="flex justify-end gap-2 pt-4">
                <button
                    pButton
                    label="Отмена"
                    class="p-button-text p-button-secondary font-bold"
                    (click)="displayDialog = false">
                </button>
                <button
                    pButton
                    [label]="editMode ? 'Сохранить' : 'Создать'"
                    icon="pi pi-check"
                    class="bg-blue-600 border-none hover:bg-blue-700 px-6 rounded-xl font-bold shadow-lg shadow-blue-500/20"
                    (click)="save()"
                    [disabled]="!categoryName">
                </button>
            </div>
        </ng-template>
      </p-dialog>
    </div>
  `,
  styles: [`
    /* Стилизация дерева */
    :host ::ng-deep .custom-tree .p-treenode-content {
        padding: 0.5rem 0.5rem !important;
        border-radius: 0.75rem;
        margin-bottom: 2px;
        border: 1px solid transparent;
        transition: all 0.2s;
    }
    :host ::ng-deep .custom-tree .p-treenode-content:hover {
        background-color: #F3F4F6 !important;
        border-color: #E5E7EB;
    }
    :host ::ng-deep .custom-tree .p-treenode-content.p-highlight {
        background-color: #EFF6FF !important;
        border-color: #BFDBFE;
        color: #1D4ED8;
    }
    :host ::ng-deep .custom-tree .p-treenode-content.p-highlight .p-tree-toggler {
        color: #2563EB;
    }
    :host ::ng-deep .p-tree-filter-container { margin-bottom: 1rem; }
    :host ::ng-deep .p-tree-filter-container .p-inputtext {
        width: 100%;
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        background-color: #F9FAFB;
        border: 1px solid #E5E7EB;
    }
    :host ::ng-deep .p-tree-filter-container .p-inputtext:focus {
        background-color: white;
        border-color: #3B82F6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    /* Диалог */
    :host ::ng-deep .p-dialog .p-dialog-header { border-bottom: 1px solid #F3F4F6; padding: 1.5rem; border-top-left-radius: 1rem; border-top-right-radius: 1rem; }
    :host ::ng-deep .p-dialog .p-dialog-content { padding: 1.5rem; }
    :host ::ng-deep .p-dialog .p-dialog-footer { padding: 1rem 1.5rem; border-top: 1px solid #F3F4F6; border-bottom-left-radius: 1rem; border-bottom-right-radius: 1rem; }
    :host ::ng-deep .custom-dialog { border-radius: 1rem; box-shadow: 0 20px 50px rgba(0,0,0,0.1); border: 1px solid #E5E7EB; }
  `]
})
export class AdminCategoriesComponent implements OnInit {
  private categoryService = inject(CategoryService);
  private messageService = inject(MessageService);

  categories: TreeNode[] = [];
  selectedNode: TreeNode | null = null;
  menuItems: MenuItem[] = [];

  // Dialog state
  displayDialog = false;
  editMode = false;
  categoryName = '';
  parentNode: TreeNode | null = null;
  editNodeId: number | null = null;

  ngOnInit() {
    this.loadCategories();

    this.menuItems = [
      {
          label: 'Добавить подкатегорию',
          icon: 'pi pi-plus',
          command: () => this.openDialog(this.selectedNode)
      },
      {
          label: 'Редактировать',
          icon: 'pi pi-pencil',
          command: () => this.openEditDialog(this.selectedNode)
      },
      { separator: true },
      {
          label: 'Удалить',
          icon: 'pi pi-trash',
          styleClass: 'text-red-500',
          command: () => this.deleteCategory(this.selectedNode)
      }
    ];
  }

  loadCategories() {
    this.categoryService.getTree().subscribe(data => this.categories = data);
  }

  openDialog(parent: TreeNode | null) {
    this.editMode = false;
    this.parentNode = parent;
    this.categoryName = '';
    this.displayDialog = true;
  }

  openEditDialog(node: TreeNode | null) {
    if (!node) return;
    this.editMode = true;
    this.categoryName = node.label!;
    this.editNodeId = node.data;
    this.parentNode = node.parent || null;
    this.displayDialog = true;
  }

  save() {
    const parentId = this.parentNode ? this.parentNode.data : null;

    if (this.editMode && this.editNodeId) {
      this.categoryService.update(this.editNodeId, this.categoryName, parentId).subscribe({
        next: () => {
          this.messageService.add({ severity: 'success', summary: 'Обновлено', detail: 'Категория изменена' });
          this.displayDialog = false;
          this.loadCategories();
        }
      });
    } else {
      this.categoryService.create(this.categoryName, parentId).subscribe({
        next: () => {
          this.messageService.add({ severity: 'success', summary: 'Создано', detail: 'Новая категория добавлена' });
          this.displayDialog = false;
          this.loadCategories();
        }
      });
    }
  }

  deleteCategory(node: TreeNode | null) {
    if (!node) return;

    if (confirm(`Вы уверены, что хотите удалить категорию "${node.label}"? Вложенные категории тоже будут удалены.`)) {
      this.categoryService.delete(node.data).subscribe({
        next: () => {
          this.messageService.add({ severity: 'info', summary: 'Удалено', detail: `Категория "${node.label}" удалена` });
          this.loadCategories();
        }
      });
    }
  }
}
</file>

<file path="autoparts-client/src/app/features/admin/orders/admin-orders.component.ts">
import { Component, inject, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { OrderDto, OrderService } from '../../../core/services/order.service';
import { MessageService } from 'primeng/api';

import { TableModule } from 'primeng/table';
import { DropdownModule } from 'primeng/dropdown';
import { TagModule } from 'primeng/tag';
import { InputTextModule } from 'primeng/inputtext';
import { ButtonModule } from 'primeng/button';
import { TooltipModule } from 'primeng/tooltip';
import { CardModule } from 'primeng/card';
import { IconFieldModule } from 'primeng/iconfield';
import { InputIconModule } from 'primeng/inputicon';

@Component({
  selector: 'app-admin-orders',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    TableModule,
    DropdownModule,
    TagModule,
    InputTextModule,
    ButtonModule,
    TooltipModule,
    CardModule,
    IconFieldModule,
    InputIconModule
  ],
  template: `
    <div class="space-y-6">

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 flex items-center justify-between hover:shadow-md transition-shadow">
           <div>
              <p class="text-gray-500 text-sm font-medium mb-1">Всего заказов</p>
              <h3 class="text-2xl font-extrabold text-gray-900">{{ orders.length }}</h3>
           </div>
           <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center text-xl">
              <i class="pi pi-shopping-bag"></i>
           </div>
        </div>

        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 flex items-center justify-between hover:shadow-md transition-shadow">
           <div>
              <p class="text-gray-500 text-sm font-medium mb-1">Общая выручка</p>
              <h3 class="text-2xl font-extrabold text-gray-900">{{ totalRevenue | number:'1.0-0' }} ₽</h3>
           </div>
           <div class="w-12 h-12 bg-green-50 text-green-600 rounded-xl flex items-center justify-center text-xl">
              <i class="pi pi-wallet"></i>
           </div>
        </div>

        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 flex items-center justify-between hover:shadow-md transition-shadow">
           <div>
              <p class="text-gray-500 text-sm font-medium mb-1">В обработке</p>
              <h3 class="text-2xl font-extrabold text-orange-600">{{ pendingCount }}</h3>
           </div>
           <div class="w-12 h-12 bg-orange-50 text-orange-600 rounded-xl flex items-center justify-center text-xl">
              <i class="pi pi-clock"></i>
           </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">

        <div class="p-6 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4">
          <h2 class="text-lg font-bold text-gray-800">Список заказов</h2>

          <div class="flex gap-3 w-full sm:w-auto items-center">

             <div class="relative w-full sm:w-72">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                  <i class="pi pi-search text-gray-400"></i>
                </div>
                <input
                    pInputText
                    type="text"
                    (input)="dt.filterGlobal($any($event.target).value, 'contains')"
                    placeholder="Поиск по ID или телефону..."
                    class="w-full pl-11 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-900 placeholder-gray-400 focus:outline-none focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all font-medium"
                />
             </div>

             <button
                pButton
                icon="pi pi-refresh"
                class="p-button-rounded p-button-text p-button-secondary w-10 h-10"
                (click)="loadOrders()"
                pTooltip="Обновить данные">
             </button>
          </div>
        </div>

        <p-table
            #dt
            [value]="orders"
            [paginator]="true"
            [rows]="10"
            [rowsPerPageOptions]="[10, 25, 50]"
            [globalFilterFields]="['id', 'contactPhone', 'totalPrice']"
            dataKey="id"
            [rowHover]="true"
            styleClass="p-datatable-gridlines-none p-datatable-sm"
            [tableStyle]="{ 'min-width': '60rem' }"
        >
          <ng-template pTemplate="header">
            <tr class="bg-gray-50/50 text-xs uppercase text-gray-500 tracking-wider border-b border-gray-100">
              <th style="width: 3rem"></th>
              <th pSortableColumn="id" class="py-4 pl-4">ID <p-sortIcon field="id"></p-sortIcon></th>
              <th pSortableColumn="createdAt">Дата <p-sortIcon field="createdAt"></p-sortIcon></th>
              <th>Клиент</th>
              <th pSortableColumn="totalPrice">Сумма <p-sortIcon field="totalPrice"></p-sortIcon></th>
              <th>Статус</th>
              <th class="text-center">Позиций</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-order let-expanded="expanded">
            <tr class="border-b border-gray-50 hover:bg-slate-50 transition-colors">
              <td class="text-center">
                <button type="button" pButton pRipple [pRowToggler]="order" class="p-button-text p-button-rounded p-button-plain p-button-sm w-8 h-8" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
              </td>
              <td class="font-bold text-gray-700 pl-4">#{{ order.id }}</td>
              <td class="text-sm">
                <div class="font-medium text-gray-900">{{ order.createdAt | date:'dd.MM.yyyy' }}</div>
                <div class="text-xs text-gray-400">{{ order.createdAt | date:'HH:mm' }}</div>
              </td>
              <td>
                 <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 border border-gray-200">
                        <i class="pi pi-user text-xs"></i>
                    </div>
                    <div>
                        <div class="text-sm font-bold text-gray-800">{{ order.contactPhone }}</div>
                        <div class="text-xs text-gray-500">Покупатель</div>
                    </div>
                 </div>
              </td>
              <td class="font-bold text-gray-900">
                {{ order.totalPrice | number:'1.0-0' }} ₽
              </td>
              <td>
                <p-dropdown
                  [options]="statuses"
                  [(ngModel)]="order.status"
                  (onChange)="onStatusChange(order)"
                  appendTo="body"
                  styleClass="w-40 border-0 shadow-none bg-transparent"
                  [panelStyle]="{'border-radius': '12px', 'box-shadow': '0 10px 30px rgba(0,0,0,0.1)'}"
                >
                  <ng-template pTemplate="selectedItem">
                    <p-tag [value]="getStatusLabel(order.status)" [severity]="getSeverity(order.status)" styleClass="text-xs font-bold uppercase tracking-wide px-2 py-1"></p-tag>
                  </ng-template>
                  <ng-template pTemplate="item" let-status>
                    <div class="flex items-center gap-2 py-1">
                        <span [class]="'w-2 h-2 rounded-full ' + getStatusDotColor(status)"></span>
                        <span class="text-sm">{{ getStatusLabel(status) }}</span>
                    </div>
                  </ng-template>
                </p-dropdown>
              </td>
              <td class="text-center">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 border border-gray-200">
                  {{ order.items.length }} шт.
                </span>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="rowexpansion" let-order>
            <tr>
              <td colspan="7" class="p-0 bg-gray-50/30 border-b border-gray-100">
                <div class="p-6 pl-16">
                  <h4 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                      <i class="pi pi-box"></i> Состав заказа #{{order.id}}
                  </h4>

                  <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm max-w-4xl">
                      <table class="w-full text-sm text-left">
                          <thead class="bg-gray-50 text-gray-500 font-medium">
                              <tr>
                                  <th class="px-4 py-3 border-b border-gray-100">Товар</th>
                                  <th class="px-4 py-3 border-b border-gray-100">Артикул</th>
                                  <th class="px-4 py-3 text-right border-b border-gray-100">Цена</th>
                                  <th class="px-4 py-3 text-center border-b border-gray-100">Кол-во</th>
                                  <th class="px-4 py-3 text-right border-b border-gray-100">Итого</th>
                              </tr>
                          </thead>
                          <tbody class="divide-y divide-gray-100">
                              <tr *ngFor="let item of order.items">
                                  <td class="px-4 py-3 font-medium text-gray-900 flex items-center gap-3">
                                      <div class="w-9 h-9 rounded bg-gray-50 flex-shrink-0 flex items-center justify-center overflow-hidden border border-gray-200">
                                          <img *ngIf="item.imageUrl" [src]="item.imageUrl" class="w-full h-full object-cover mix-blend-multiply">
                                          <i *ngIf="!item.imageUrl" class="pi pi-image text-gray-300 text-xs"></i>
                                      </div>
                                      {{ item.name }}
                                  </td>
                                  <td class="px-4 py-3 text-gray-500 font-mono text-xs">{{ item.sku }}</td>
                                  <td class="px-4 py-3 text-right text-gray-600">{{ item.price | number:'1.0-0' }} ₽</td>
                                  <td class="px-4 py-3 text-center font-bold text-gray-800">x{{ item.quantity }}</td>
                                  <td class="px-4 py-3 text-right font-bold text-blue-600">{{ (item.price * item.quantity) | number:'1.0-0' }} ₽</td>
                              </tr>
                          </tbody>
                      </table>
                  </div>
                </div>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
             <tr>
                <td colspan="7" class="text-center py-12 text-gray-500">
                   <div class="flex flex-col items-center justify-center">
                      <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-3">
                          <i class="pi pi-search text-gray-400"></i>
                      </div>
                      <p>Заказы не найдены.</p>
                   </div>
                </td>
             </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  `,
  styles: [`
    :host ::ng-deep .p-datatable .p-datatable-thead > tr > th { background: transparent; border: none; }
    :host ::ng-deep .p-dropdown-panel { border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
  `]
})
export class AdminOrdersComponent implements OnInit {
  private orderService = inject(OrderService);
  private messageService = inject(MessageService);

  orders: OrderDto[] = [];

  statuses = ['CREATED', 'CONFIRMED', 'PAID', 'SHIPPED', 'COMPLETED', 'CANCELLED'];

  ngOnInit() {
    this.loadOrders();
  }

  loadOrders() {
    this.orderService.getOrders().subscribe(data => {
        this.orders = data.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
    });
  }

  get totalRevenue(): number {
    return this.orders
        .filter(o => o.status !== 'CANCELLED')
        .reduce((acc, curr) => acc + curr.totalPrice, 0);
  }

  get pendingCount(): number {
    return this.orders.filter(o => ['CREATED', 'CONFIRMED'].includes(o.status)).length;
  }

  onStatusChange(order: OrderDto) {
    this.orderService.updateStatus(order.id, order.status).subscribe({
      next: () => {
        this.messageService.add({
          severity: 'success',
          summary: 'Успешно',
          detail: `Статус заказа #${order.id} изменен на ${this.getStatusLabel(order.status)}`
        });
      },
      error: () => {
        this.messageService.add({ severity: 'error', summary: 'Ошибка', detail: 'Не удалось обновить статус' });
      }
    });
  }

  getSeverity(status: string): "success" | "info" | "warning" | "danger" | "secondary" | "contrast" | undefined {
    switch (status) {
      case 'CREATED': return 'secondary';
      case 'CONFIRMED': return 'info';
      case 'PAID': return 'success';
      case 'SHIPPED': return 'warning';
      case 'COMPLETED': return 'success';
      case 'CANCELLED': return 'danger';
      default: return 'info';
    }
  }

  getStatusLabel(status: string): string {
    const map: Record<string, string> = {
      'CREATED': 'Новый',
      'CONFIRMED': 'Подтвержден',
      'PAID': 'Оплачен',
      'SHIPPED': 'В пути',
      'COMPLETED': 'Выдан',
      'CANCELLED': 'Отменен'
    };
    return map[status] || status;
  }

  getStatusDotColor(status: string): string {
      switch (status) {
          case 'CREATED': return 'bg-gray-400';
          case 'CONFIRMED': return 'bg-blue-400';
          case 'PAID': return 'bg-green-500';
          case 'SHIPPED': return 'bg-orange-400';
          case 'COMPLETED': return 'bg-green-600';
          case 'CANCELLED': return 'bg-red-500';
          default: return 'bg-gray-400';
      }
  }
}
</file>

<file path="autoparts-client/src/app/features/admin/products/admin-products.component.ts">
import { Component, inject, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { ProductService } from '../../../core/services/product.service';
import { CategoryService } from '../../../core/services/category.service';
import { ProductDto } from '../../../core/models/catalog.models';
import { MessageService, TreeNode } from 'primeng/api';

import { TableModule } from 'primeng/table';
import { ButtonModule } from 'primeng/button';
import { DialogModule } from 'primeng/dialog';
import { InputTextModule } from 'primeng/inputtext';
import { InputNumberModule } from 'primeng/inputnumber';
import { InputTextareaModule } from 'primeng/inputtextarea';
import { DropdownModule } from 'primeng/dropdown';
import { ToolbarModule } from 'primeng/toolbar';
import { TagModule } from 'primeng/tag';
import { IconFieldModule } from 'primeng/iconfield';
import { InputIconModule } from 'primeng/inputicon';
import { TooltipModule } from 'primeng/tooltip';

@Component({
  selector: 'app-admin-products',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    TableModule,
    ButtonModule,
    DialogModule,
    InputTextModule,
    InputNumberModule,
    InputTextareaModule,
    DropdownModule,
    ToolbarModule,
    TagModule,
    IconFieldModule,
    InputIconModule,
    TooltipModule
  ],
  template: `
    <div class="space-y-6">

        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Товары</h1>
                <p class="text-gray-500 text-sm mt-1">Управление ассортиментом магазина</p>
            </div>

            <button
                pButton
                label="Добавить товар"
                icon="pi pi-plus"
                class="bg-blue-600 border-none hover:bg-blue-700 shadow-lg shadow-blue-600/30 px-6 py-3 rounded-xl font-bold transition-all hover:-translate-y-0.5"
                (click)="openNew()">
            </button>
        </div>

        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">

            <div class="p-5 border-b border-gray-100 bg-white">
                <div class="relative w-full sm:w-96">
                  <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i class="pi pi-search text-gray-400"></i>
                  </div>
                  <input
                      pInputText
                      type="text"
                      (input)="dt.filterGlobal($any($event.target).value, 'contains')"
                      placeholder="Поиск по названию или SKU..."
                      class="w-full pl-11 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-900 placeholder-gray-400 focus:outline-none focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all font-medium"
                  />
               </div>
            </div>

            <p-table
                #dt
                [value]="products"
                [paginator]="true"
                [rows]="10"
                [rowsPerPageOptions]="[10, 25, 50]"
                [globalFilterFields]="['name', 'sku', 'categoryName']"
                styleClass="p-datatable-gridlines-none"
                [tableStyle]="{ 'min-width': '60rem' }"
                [rowHover]="true"
            >
                <ng-template pTemplate="header">
                <tr class="bg-gray-50/50 text-xs uppercase text-gray-500 tracking-wider border-b border-gray-100">
                    <th class="py-4 pl-6 w-24">Фото</th>
                    <th pSortableColumn="name">Название <p-sortIcon field="name"></p-sortIcon></th>
                    <th pSortableColumn="sku" class="w-32">Артикул <p-sortIcon field="sku"></p-sortIcon></th>
                    <th pSortableColumn="categoryName" class="w-48">Категория <p-sortIcon field="categoryName"></p-sortIcon></th>
                    <th pSortableColumn="price" class="text-right w-32">Цена <p-sortIcon field="price"></p-sortIcon></th>
                    <th pSortableColumn="stockQuantity" class="text-center w-32">Остаток <p-sortIcon field="stockQuantity"></p-sortIcon></th>
                    <th class="text-center w-32">Действия</th>
                </tr>
                </ng-template>

                <ng-template pTemplate="body" let-product>
                <tr class="border-b border-gray-50 hover:bg-slate-50 transition-colors">
                    <td class="pl-6 py-3">
                        <div class="w-12 h-12 rounded-lg bg-white border border-gray-200 p-1 flex items-center justify-center overflow-hidden">
                             <img [src]="product.imageUrl || 'https://placehold.co/100?text=No+Img'" class="w-full h-full object-contain mix-blend-multiply"/>
                        </div>
                    </td>
                    <td class="font-bold text-gray-800 text-sm">{{ product.name }}</td>
                    <td>
                        <span class="bg-gray-100 text-gray-500 text-xs font-mono px-2 py-1 rounded border border-gray-200">
                            {{ product.sku }}
                        </span>
                    </td>
                    <td>
                        <span class="text-sm text-gray-600 bg-blue-50 px-2 py-1 rounded-md text-blue-700 font-medium text-xs">
                            {{ product.categoryName || 'Без категории' }}
                        </span>
                    </td>
                    <td class="text-right font-bold text-gray-900">
                        {{ product.price | number:'1.0-0' }} ₽
                    </td>
                    <td class="text-center">
                        <div [class]="getStockClass(product.stockQuantity) + ' inline-flex px-2 py-1 rounded-md text-xs font-bold'">
                            {{ product.stockQuantity }} шт.
                        </div>
                    </td>
                    <td class="text-center">
                    <div class="flex items-center justify-center gap-2">
                        <button
                            pButton
                            icon="pi pi-pencil"
                            class="p-button-rounded p-button-text p-button-secondary w-8 h-8 hover:bg-blue-50 hover:text-blue-600"
                            (click)="editProduct(product)"
                            pTooltip="Редактировать">
                        </button>
                        <button
                            pButton
                            icon="pi pi-trash"
                            class="p-button-rounded p-button-text p-button-secondary w-8 h-8 hover:bg-red-50 hover:text-red-600"
                            (click)="deleteProduct(product)"
                            pTooltip="Удалить">
                        </button>
                    </div>
                    </td>
                </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="7" class="text-center py-10 text-gray-500">
                            Товары не найдены. <span class="text-blue-500 cursor-pointer" (click)="openNew()">Добавить первый?</span>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>

      <p-dialog
        [(visible)]="productDialog"
        [style]="{width: '600px', maxWidth: '95vw'}"
        header="Карточка товара"
        [modal]="true"
        styleClass="p-fluid custom-dialog"
        [draggable]="false"
        [resizable]="false"
        [closeOnEscape]="true"
        [dismissableMask]="true"
      >
        <ng-template pTemplate="content">
          <div class="flex flex-col gap-5 pt-2">

            <div class="flex justify-center mb-2">
                 <div class="w-32 h-32 rounded-2xl bg-gray-50 border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden relative group">
                     <img *ngIf="product.imageUrl" [src]="product.imageUrl" class="w-full h-full object-contain mix-blend-multiply p-2">
                     <i *ngIf="!product.imageUrl" class="pi pi-image text-3xl text-gray-300"></i>
                     <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-white text-xs text-center p-2">
                        Вставьте URL ниже
                     </div>
                 </div>
            </div>

            <div class="field">
                <label for="name" class="font-bold text-gray-700 mb-1 block">Название товара <span class="text-red-500">*</span></label>
                <input
                    type="text"
                    pInputText
                    id="name"
                    [(ngModel)]="product.name"
                    required
                    autofocus
                    class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all"
                    placeholder="Например: Масло моторное 5W-40"
                />
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="field">
                    <label for="sku" class="font-bold text-gray-700 mb-1 block">Артикул (SKU) <span class="text-red-500">*</span></label>
                    <input
                        type="text"
                        pInputText
                        id="sku"
                        [(ngModel)]="product.sku"
                        required
                        class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-blue-500 transition-all"
                        placeholder="AB-12345"
                    />
                </div>
                <div class="field">
                    <label for="category" class="font-bold text-gray-700 mb-1 block">Категория</label>
                    <p-dropdown
                        [options]="flatCategories"
                        [(ngModel)]="selectedCategory"
                        optionLabel="label"
                        placeholder="Выберите категорию"
                        [filter]="true"
                        styleClass="w-full"
                        [style]="{'background-color': '#F9FAFB', 'border-radius': '0.75rem', 'border-color': '#E5E7EB'}"
                        appendTo="body"
                    ></p-dropdown>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="field">
                    <label for="price" class="font-bold text-gray-700 mb-1 block">Цена (₽)</label>
                    <p-inputNumber
                        id="price"
                        [(ngModel)]="product.price"
                        mode="currency"
                        currency="RUB"
                        locale="ru-RU"
                        [minFractionDigits]="0"
                        styleClass="w-full"
                        [inputStyle]="{'background-color': '#F9FAFB', 'border-radius': '0.75rem'}"
                    ></p-inputNumber>
                </div>
                <div class="field">
                    <label for="quantity" class="font-bold text-gray-700 mb-1 block">Остаток (шт)</label>
                    <p-inputNumber
                        id="quantity"
                        [(ngModel)]="product.stockQuantity"
                        styleClass="w-full"
                        [inputStyle]="{'background-color': '#F9FAFB', 'border-radius': '0.75rem'}"
                        [showButtons]="true"
                        buttonLayout="horizontal"
                        spinnerMode="horizontal"
                        decrementButtonClass="p-button-secondary p-button-text"
                        incrementButtonClass="p-button-secondary p-button-text"
                        incrementButtonIcon="pi pi-plus"
                        decrementButtonIcon="pi pi-minus"
                    ></p-inputNumber>
                </div>
            </div>

            <div class="field">
                <label for="image" class="font-bold text-gray-700 mb-1 block">Ссылка на фото</label>
                <div class="relative">
                    <i class="pi pi-link absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input
                        type="text"
                        pInputText
                        id="image"
                        [(ngModel)]="product.imageUrl"
                        class="w-full pl-10 pr-3 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-blue-500 transition-all"
                        placeholder="https://example.com/image.jpg"
                    />
                </div>
            </div>

            <div class="field">
                <label for="description" class="font-bold text-gray-700 mb-1 block">Описание</label>
                <textarea
                    id="description"
                    pInputTextarea
                    [(ngModel)]="product.description"
                    rows="3"
                    class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-blue-500 transition-all"
                    placeholder="Краткое описание товара..."
                ></textarea>
            </div>

          </div>
        </ng-template>

        <ng-template pTemplate="footer">
            <div class="flex justify-end gap-2 pt-4">
                <button
                    pButton
                    label="Отмена"
                    class="p-button-text p-button-secondary font-bold"
                    (click)="productDialog = false">
                </button>
                <button
                    pButton
                    label="Сохранить"
                    icon="pi pi-check"
                    class="bg-blue-600 border-none hover:bg-blue-700 px-6 rounded-xl font-bold shadow-lg shadow-blue-500/20"
                    (click)="saveProduct()">
                </button>
            </div>
        </ng-template>
      </p-dialog>
    </div>
  `,
  styles: [`
    /* Стили для PrimeNG элементов внутри Tailwind контекста */
    :host ::ng-deep .p-datatable .p-datatable-thead > tr > th { background: transparent; border: none; }
    :host ::ng-deep .p-dropdown { border: 1px solid #E5E7EB; border-radius: 0.75rem; background: #F9FAFB; }
    :host ::ng-deep .p-dropdown:not(.p-disabled).p-focus { border-color: #3B82F6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); background: white; }

    :host ::ng-deep .p-inputnumber-input { width: 100%; border: 1px solid #E5E7EB; padding: 0.75rem; }
    :host ::ng-deep .p-inputnumber-input:focus { border-color: #3B82F6; outline: none; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); background: white; }

    :host ::ng-deep .p-dialog .p-dialog-header { border-bottom: 1px solid #F3F4F6; padding: 1.5rem; border-top-left-radius: 1rem; border-top-right-radius: 1rem; }
    :host ::ng-deep .p-dialog .p-dialog-content { padding: 1.5rem; }
    :host ::ng-deep .p-dialog .p-dialog-footer { padding: 1rem 1.5rem; border-top: 1px solid #F3F4F6; border-bottom-left-radius: 1rem; border-bottom-right-radius: 1rem; }
    :host ::ng-deep .custom-dialog { border-radius: 1rem; box-shadow: 0 20px 50px rgba(0,0,0,0.1); border: 1px solid #E5E7EB; }
  `]
})
export class AdminProductsComponent implements OnInit {
  private productService = inject(ProductService);
  private categoryService = inject(CategoryService);
  private messageService = inject(MessageService);

  products: ProductDto[] = [];
  flatCategories: any[] = [];

  productDialog = false;
  product: any = {};
  selectedCategory: any = null;

  ngOnInit() {
    this.loadProducts();
    this.loadCategories();
  }

  loadProducts() {
    this.productService.getAll().subscribe(data => this.products = data);
  }

  loadCategories() {
    this.categoryService.getTree().subscribe(tree => {
      this.flatCategories = this.flattenTree(tree);
    });
  }

  flattenTree(nodes: TreeNode[]): any[] {
    let result: any[] = [];
    for (const node of nodes) {
      result.push({ label: node.label, value: node.data });
      if (node.children) {
        result = result.concat(this.flattenTree(node.children));
      }
    }
    return result;
  }

  openNew() {
    this.product = {};
    this.selectedCategory = null;
    this.productDialog = true;
  }

  editProduct(product: ProductDto) {
    this.product = { ...product };
    this.selectedCategory = this.flatCategories.find(c => c.value === product.categoryId);
    this.productDialog = true;
  }

  deleteProduct(product: ProductDto) {
    if (confirm(`Удалить товар "${product.name}"?`)) {
      this.productService.delete(product.id).subscribe({
        next: () => {
          this.messageService.add({ severity: 'success', summary: 'Товар удален' });
          this.loadProducts();
        }
      });
    }
  }

  saveProduct() {
    if (!this.product.name || !this.product.sku) {
        this.messageService.add({ severity: 'warn', summary: 'Ошибка', detail: 'Заполните обязательные поля' });
        return;
    }

    const request = {
      ...this.product,
      categoryId: this.selectedCategory ? this.selectedCategory.value : null
    };

    if (this.product.id) {
      this.productService.update(this.product.id, request).subscribe({
        next: () => {
          this.messageService.add({ severity: 'success', summary: 'Товар обновлен' });
          this.productDialog = false;
          this.loadProducts();
        }
      });
    } else {
      this.productService.create(request).subscribe({
        next: () => {
          this.messageService.add({ severity: 'success', summary: 'Товар создан' });
          this.productDialog = false;
          this.loadProducts();
        }
      });
    }
  }

  getStockClass(quantity: number): string {
      if (quantity === 0) return 'bg-red-50 text-red-600 border border-red-100';
      if (quantity < 5) return 'bg-orange-50 text-orange-600 border border-orange-100';
      return 'bg-green-50 text-green-600 border border-green-100';
  }
}
</file>

<file path="autoparts-client/src/app/features/auth/login/login.component.ts">
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';
import { RouterLink } from '@angular/router';
import { AuthService } from '../../../core/auth/auth.service';

import { ButtonModule } from 'primeng/button';
import { InputTextModule } from 'primeng/inputtext';
import { PasswordModule } from 'primeng/password';
import { ToastModule } from 'primeng/toast';
import { MessageService } from 'primeng/api';

@Component({
  selector: 'app-login',
  standalone: true,
  imports: [
    CommonModule,
    ReactiveFormsModule,
    RouterLink,
    ButtonModule,
    InputTextModule,
    PasswordModule,
    ToastModule
  ],
  providers: [MessageService],
  template: `
    <div class="min-h-screen flex w-full bg-white font-sans">
      <p-toast></p-toast>

      <div class="flex-1 flex items-center justify-center p-8 sm:p-12 lg:p-20 relative animate-fade-in-left">

        <a routerLink="/" class="absolute top-8 left-8 text-gray-400 hover:text-blue-600 transition-colors flex items-center gap-2 font-medium">
           <i class="pi pi-arrow-left"></i> На главную
        </a>

        <div class="w-full max-w-md space-y-8">
          <div class="text-center md:text-left">
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">С возвращением!</h1>
            <p class="mt-2 text-gray-500">Введите телефон и пароль для входа в кабинет.</p>
          </div>

          <form [formGroup]="loginForm" (ngSubmit)="onSubmit()" class="mt-8 space-y-6">

            <div class="space-y-5">

              <div>
                <label for="phone" class="block text-sm font-bold text-gray-700 mb-2">Номер телефона</label>
                <div class="relative">
                  <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i class="pi pi-phone text-gray-400"></i>
                  </div>
                  <input
                    pInputText
                    id="phone"
                    formControlName="phone"
                    placeholder="+7 777 000 00 00"
                    class="w-full pl-11 pr-4 py-3.5 bg-gray-50 border border-gray-200 rounded-xl text-gray-900 placeholder-gray-400 focus:outline-none focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all font-medium"
                    [ngClass]="{'border-red-300 bg-red-50 text-red-900 placeholder-red-300 focus:border-red-500 focus:ring-red-200': isFieldInvalid('phone')}"
                  />
                </div>
                <small *ngIf="isFieldInvalid('phone')" class="text-red-500 text-xs mt-1.5 font-medium flex items-center gap-1">
                   <i class="pi pi-info-circle"></i> Введите корректный номер
                </small>
              </div>

              <div>
                <div class="flex items-center justify-between mb-2">
                   <label for="password" class="block text-sm font-bold text-gray-700">Пароль</label>
                   <a href="#" class="text-sm font-semibold text-blue-600 hover:text-blue-500 transition-colors">Забыли пароль?</a>
                </div>

                <p-password
                  id="password"
                  formControlName="password"
                  [feedback]="false"
                  [toggleMask]="true"
                  styleClass="w-full"
                  inputStyleClass="w-full pl-4 pr-10 py-3.5 bg-gray-50 border border-gray-200 rounded-xl text-gray-900 placeholder-gray-400 focus:outline-none focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all font-medium"
                  placeholder="••••••••"
                  [ngClass]="{'ng-invalid-custom': isFieldInvalid('password')}"
                ></p-password>

                 <small *ngIf="isFieldInvalid('password')" class="text-red-500 text-xs mt-1.5 font-medium flex items-center gap-1">
                    <i class="pi pi-info-circle"></i> Введите пароль
                 </small>
              </div>
            </div>

            <button
              type="submit"
              [disabled]="isLoading"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg shadow-blue-600/30 transition-all hover:-translate-y-0.5 active:translate-y-0 active:shadow-none flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed"
            >
              <i *ngIf="isLoading" class="pi pi-spin pi-spinner"></i>
              {{ isLoading ? 'Вход...' : 'Войти в аккаунт' }}
            </button>

            <div class="relative my-8">
               <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
               <div class="relative flex justify-center text-sm"><span class="px-4 bg-white text-gray-500 font-medium">или</span></div>
            </div>

            <p class="text-center text-sm text-gray-600">
              Нет аккаунта?
              <a routerLink="/register" class="font-bold text-blue-600 hover:text-blue-700 hover:underline transition-all cursor-pointer">
                Зарегистрироваться бесплатно
              </a>
            </p>
          </form>
        </div>
      </div>

      <div class="hidden lg:block relative w-0 flex-1 bg-gray-900">
         <img class="absolute inset-0 h-full w-full object-cover opacity-60 mix-blend-overlay" src="https://images.unsplash.com/photo-1493238792015-153296bc86d5?q=80&w=1920&auto=format&fit=crop" alt="Car background">
         <div class="absolute inset-0 bg-gradient-to-br from-slate-900 via-blue-900/80 to-slate-900"></div>

         <div class="absolute inset-0 flex flex-col justify-center px-16 text-white">
            <h2 class="text-5xl font-black mb-8 leading-tight tracking-tight">Ваш автомобиль <br>заслуживает <span class="text-blue-400">лучшего</span></h2>
            <p class="text-xl text-blue-100 max-w-lg leading-relaxed font-light">
               Более 50,000 запчастей в каталоге. Быстрая доставка, гарантия качества и персональные скидки.
            </p>

            <div class="mt-12 flex items-center gap-4 p-4 bg-white/10 backdrop-blur-md rounded-2xl w-fit border border-white/10">
               <div class="flex -space-x-3">
                  <img class="w-10 h-10 rounded-full border-2 border-slate-800" src="https://randomuser.me/api/portraits/men/32.jpg" alt=""/>
                  <img class="w-10 h-10 rounded-full border-2 border-slate-800" src="https://randomuser.me/api/portraits/women/44.jpg" alt=""/>
                  <img class="w-10 h-10 rounded-full border-2 border-slate-800" src="https://randomuser.me/api/portraits/men/86.jpg" alt=""/>
               </div>
               <div class="text-sm font-medium">
                  <span class="block text-white font-bold">10k+ довольных</span>
                  <span class="text-blue-200">клиентов по всей стране</span>
               </div>
            </div>
         </div>
      </div>
    </div>
  `,
  styles: [`
    .animate-fade-in-left { animation: fadeInLeft 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes fadeInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }

    /* Кастомный класс для p-password при ошибке */
    :host ::ng-deep .ng-invalid-custom input {
        border-color: #fca5a5; /* red-300 */
        background-color: #fef2f2; /* red-50 */
        color: #7f1d1d;
    }
    :host ::ng-deep .ng-invalid-custom input::placeholder {
        color: #fca5a5;
    }
  `]
})
export class LoginComponent {
  private fb = inject(FormBuilder);
  private authService = inject(AuthService);
  private messageService = inject(MessageService);

  isLoading = false;

  loginForm = this.fb.group({
    phone: ['', [Validators.required]],
    password: ['', [Validators.required]]
  });

  isFieldInvalid(fieldName: string): boolean {
    const field = this.loginForm.get(fieldName);
    return field ? (field.invalid && (field.dirty || field.touched)) : false;
  }

  onSubmit() {
    if (this.loginForm.valid) {
      this.isLoading = true;
      const { phone, password } = this.loginForm.value;

      this.authService.login({ phone: phone!, password: password! }).subscribe({
        next: () => {
          this.isLoading = false;
        },
        error: (err) => {
          this.isLoading = false;
          this.messageService.add({
            severity: 'error',
            summary: 'Ошибка входа',
            detail: 'Неверный телефон или пароль'
          });
        }
      });
    } else {
        this.loginForm.markAllAsTouched();
    }
  }
}
</file>

<file path="autoparts-client/src/app/features/auth/register/register.component.ts">
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';
import { Router, RouterLink } from '@angular/router';
import { AuthService } from '../../../core/auth/auth.service';

import { ButtonModule } from 'primeng/button';
import { InputTextModule } from 'primeng/inputtext';
import { PasswordModule } from 'primeng/password';
import { ToastModule } from 'primeng/toast';
import { MessageService } from 'primeng/api';
import { DividerModule } from 'primeng/divider';

@Component({
  selector: 'app-register',
  standalone: true,
  imports: [
    CommonModule,
    ReactiveFormsModule,
    RouterLink,
    ButtonModule,
    InputTextModule,
    PasswordModule,
    ToastModule,
    DividerModule
  ],
  providers: [MessageService],
  template: `
    <div class="min-h-screen flex w-full bg-white font-sans">
      <p-toast></p-toast>

      <div class="flex-1 flex items-center justify-center p-8 sm:p-12 lg:p-20 relative animate-fade-in-left">

         <a routerLink="/" class="absolute top-8 left-8 text-gray-400 hover:text-blue-600 transition-colors flex items-center gap-2 font-medium">
           <i class="pi pi-arrow-left"></i> На главную
        </a>

        <div class="w-full max-w-lg">
          <div class="mb-10">
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Создание аккаунта</h1>
            <p class="mt-3 text-gray-500 text-lg">Заполните данные, чтобы получить доступ к истории заказов.</p>
          </div>

          <form [formGroup]="registerForm" (ngSubmit)="onSubmit()" class="flex flex-col gap-6">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              <div class="flex flex-col gap-2">
                <label for="firstName" class="text-sm font-bold text-gray-700">Имя <span class="text-red-500">*</span></label>
                <input
                    pInputText
                    id="firstName"
                    formControlName="firstName"
                    placeholder="Иван"
                    class="w-full px-4 py-3.5 bg-gray-50 border border-gray-200 rounded-xl text-gray-900 placeholder-gray-400 focus:outline-none focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all font-medium"
                    [ngClass]="{'border-red-300 bg-red-50': isFieldInvalid('firstName')}"/>
              </div>

              <div class="flex flex-col gap-2">
                <label for="lastName" class="text-sm font-bold text-gray-700">Фамилия</label>
                <input
                    pInputText
                    id="lastName"
                    formControlName="lastName"
                    placeholder="Иванов"
                    class="w-full px-4 py-3.5 bg-gray-50 border border-gray-200 rounded-xl text-gray-900 placeholder-gray-400 focus:outline-none focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all font-medium" />
              </div>
            </div>

            <div class="flex flex-col gap-2">
              <label for="phone" class="text-sm font-bold text-gray-700">Телефон (Логин) <span class="text-red-500">*</span></label>
              <div class="relative">
                 <i class="pi pi-phone absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                 <input
                    pInputText
                    id="phone"
                    formControlName="phone"
                    placeholder="+79990000000"
                    class="w-full pl-11 pr-4 py-3.5 bg-gray-50 border border-gray-200 rounded-xl text-gray-900 placeholder-gray-400 focus:outline-none focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all font-medium"
                    [ngClass]="{'border-red-300 bg-red-50': isFieldInvalid('phone')}"/>
              </div>

              <div *ngIf="isFieldInvalid('phone')" class="flex flex-col gap-1">
                <small *ngIf="registerForm.get('phone')?.hasError('required')" class="text-red-500 text-xs font-medium">
                    Это поле обязательно
                </small>
                <small *ngIf="registerForm.get('phone')?.hasError('pattern')" class="text-red-500 text-xs font-medium">
                    Введите корректный российский номер: +79xxxxxxxxx
                </small>
              </div>
            </div>

            <div class="flex flex-col gap-2">
              <label for="password" class="text-sm font-bold text-gray-700">Пароль <span class="text-red-500">*</span></label>
              <p-password
                id="password"
                formControlName="password"
                [toggleMask]="true"
                [feedback]="true"
                styleClass="w-full"
                inputStyleClass="w-full px-4 py-3.5 bg-gray-50 border border-gray-200 rounded-xl text-gray-900 placeholder-gray-400 focus:outline-none focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all font-medium"
                placeholder="Минимум 6 символов"
                [ngClass]="{'ng-invalid-custom': isFieldInvalid('password')}"
                promptLabel="Придумайте надежный пароль"
                weakLabel="Слабый"
                mediumLabel="Нормальный"
                strongLabel="Отличный"
              ></p-password>
              <small *ngIf="isFieldInvalid('password')" class="text-red-500 text-xs font-medium">Минимум 4 символа</small>
            </div>

            <div class="my-2 p-4 bg-blue-50 rounded-xl border border-blue-100 text-blue-800 text-sm flex gap-3 items-start">
               <i class="pi pi-shield mt-0.5 text-blue-600"></i>
               <p class="leading-relaxed">Ваши данные надежно защищены. Мы не передаем их третьим лицам.</p>
            </div>

            <button
              type="submit"
              [disabled]="isLoading"
              class="w-full bg-gray-900 hover:bg-black text-white font-bold py-4 px-8 rounded-xl shadow-xl shadow-gray-900/10 transition-all hover:-translate-y-0.5 active:translate-y-0 flex items-center justify-center gap-2"
            >
              <i *ngIf="isLoading" class="pi pi-spin pi-spinner"></i>
              {{ isLoading ? 'Регистрация...' : 'Зарегистрироваться' }}
            </button>

            <p class="text-center mt-2 text-sm text-gray-600">
              Уже есть аккаунт?
              <a routerLink="/login" class="font-bold text-blue-600 hover:text-blue-800 transition-colors">
                Войти
              </a>
            </p>
          </form>
        </div>
      </div>

      <div class="hidden lg:block relative w-0 flex-1 bg-gray-900">
         <img class="absolute inset-0 h-full w-full object-cover opacity-80" src="https://images.unsplash.com/photo-1492144534655-ae79c964c9d7?q=80&w=1920&auto=format&fit=crop" alt="Register background">
         <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/40 to-transparent"></div>

         <div class="absolute bottom-0 left-0 right-0 p-20 text-white">
            <div class="mb-8">
               <i class="pi pi-star-fill text-yellow-400 text-2xl"></i>
               <i class="pi pi-star-fill text-yellow-400 text-2xl ml-1"></i>
               <i class="pi pi-star-fill text-yellow-400 text-2xl ml-1"></i>
               <i class="pi pi-star-fill text-yellow-400 text-2xl ml-1"></i>
               <i class="pi pi-star-fill text-yellow-400 text-2xl ml-1"></i>
            </div>
            <blockquote class="text-3xl font-bold leading-snug mb-6">
               "Я всегда покупаю запчасти только здесь. Отличный сервис и быстрая доставка."
            </blockquote>
            <div class="flex items-center gap-4">
               <div class="w-14 h-14 rounded-full border-2 border-white/20 overflow-hidden">
                  <img src="https://randomuser.me/api/portraits/men/32.jpg" class="w-full h-full object-cover">
               </div>
               <div>
                  <div class="font-bold text-lg">Алексей Петров</div>
                  <div class="text-sm text-blue-200">Постоянный клиент</div>
               </div>
            </div>
         </div>
      </div>

    </div>
  `,
  styles: [`
    .animate-fade-in-left { animation: fadeInLeft 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes fadeInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }

    :host ::ng-deep .ng-invalid-custom input {
        border-color: #fca5a5;
        background-color: #fef2f2;
    }
  `]
})
export class RegisterComponent {
  private fb = inject(FormBuilder);
  private authService = inject(AuthService);
  private router = inject(Router);
  private messageService = inject(MessageService);

  isLoading = false;

  private readonly RUS_PHONE_REGEX = /^\+7\d{10}$/;

  registerForm = this.fb.group({
    firstName: ['', Validators.required],
    lastName: [''],
    phone: ['', [Validators.required, Validators.pattern(this.RUS_PHONE_REGEX)]],
    password: ['', [Validators.required, Validators.minLength(4)]]
  });

  isFieldInvalid(fieldName: string): boolean {
    const field = this.registerForm.get(fieldName);
    return field ? (field.invalid && (field.dirty || field.touched)) : false;
  }

  onSubmit() {
    if (this.registerForm.valid) {
      this.isLoading = true;
      const request = {
        firstName: this.registerForm.value.firstName!,
        lastName: this.registerForm.value.lastName || '',
        phone: this.registerForm.value.phone!,
        password: this.registerForm.value.password!
      };

      this.authService.register(request).subscribe({
        next: () => {
          this.isLoading = false;
          this.messageService.add({ severity: 'success', summary: 'Успешно', detail: 'Аккаунт создан! Перенаправление...' });
          setTimeout(() => this.router.navigate(['/']), 1000);
        },
        error: (err) => {
          this.isLoading = false;
          this.messageService.add({
            severity: 'error',
            summary: 'Ошибка',
            detail: 'Возможно, такой пользователь уже существует'
          });
        }
      });
    } else {
      this.registerForm.markAllAsTouched();
    }
  }
}
</file>

<file path="autoparts-client/src/app/features/cart/cart.component.ts">
import { Component, inject, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Router, RouterLink } from '@angular/router';

import { CartService } from '../../core/services/cart.service';
import { OrderService } from '../../core/services/order.service';

import { HeaderComponent } from '../../layout/header/header.component';

import { ButtonModule } from 'primeng/button';
import { MessageService } from 'primeng/api';
import { TooltipModule } from 'primeng/tooltip';
import { DialogModule } from 'primeng/dialog';

@Component({
  selector: 'app-cart',
  standalone: true,
  imports: [
    CommonModule,
    RouterLink,
    ButtonModule,
    TooltipModule,
    HeaderComponent,
    DialogModule // ✅
  ],
  template: `
    <div class="min-h-screen bg-[#F8F9FA] flex flex-col">

      <app-header></app-header>

      <div class="fade-in max-w-7xl mx-auto px-4 sm:px-6 py-8 w-full flex-1">

        <h1 class="text-3xl font-extrabold text-gray-900 mb-8 flex items-center gap-3">
          <span>Корзина</span>
          <span *ngIf="cartCount() > 0" class="text-sm font-medium bg-gray-100 text-gray-500 px-3 py-1 rounded-full">
              {{ cartCount() }} товаров
          </span>
        </h1>

        <div *ngIf="!isLoading && cartCount() === 0" class="flex flex-col items-center justify-center py-20 bg-white rounded-3xl border border-dashed border-gray-200">
          <div class="w-24 h-24 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mb-6">
              <i class="pi pi-shopping-cart text-4xl"></i>
          </div>
          <h2 class="text-2xl font-bold text-gray-900 mb-2">Ваша корзина пуста</h2>
          <p class="text-gray-500 mb-8 text-center max-w-xs">Похоже, вы еще ничего не добавили. Перейдите в каталог, там много интересного.</p>
          <button
              routerLink="/catalog"
              pButton
              label="Перейти к покупкам"
              icon="pi pi-arrow-right"
              iconPos="right"
              class="p-button-rounded p-button-lg">
          </button>
        </div>

        <div *ngIf="cartCount() > 0" class="flex flex-col lg:flex-row gap-8 relative">

          <div class="flex-1 space-y-4">
            <div *ngFor="let item of cart()?.items" class="group relative bg-white rounded-2xl p-4 sm:p-5 border border-gray-100 shadow-sm hover:shadow-md hover:border-blue-200 transition-all duration-300">

              <div class="flex flex-col sm:flex-row items-center gap-6">
                <div class="w-20 h-20 flex-shrink-0 bg-gray-50 rounded-xl overflow-hidden border border-gray-100 flex items-center justify-center">
                  <img
                    [src]="item.imageUrl || 'https://placehold.co/100?text=No+Img'"
                    [alt]="item.name"
                    class="w-full h-full object-contain mix-blend-multiply p-2"
                  />
                </div>

                <div class="flex-1 min-w-0 text-center sm:text-left w-full">
                  <div class="flex flex-col">
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">SKU: {{ item.sku }}</span>
                    <a [routerLink]="['/catalog']" [queryParams]="{q: item.name}" class="text-base sm:text-lg font-bold text-gray-900 hover:text-blue-600 transition-colors line-clamp-2">
                      {{ item.name }}
                    </a>
                  </div>
                </div>

                <div class="flex items-center justify-between w-full sm:w-auto gap-6 sm:gap-8 bg-gray-50 sm:bg-transparent p-3 sm:p-0 rounded-xl sm:rounded-none">

                  <div class="text-right hidden md:block w-24">
                      <span class="text-xs text-gray-400 block mb-1">Цена</span>
                      <span class="font-medium text-gray-600 whitespace-nowrap">{{ item.price | number:'1.0-0' }} ₽</span>
                  </div>

                  <div class="flex items-center bg-white sm:bg-gray-50 rounded-lg border border-gray-200 shadow-sm sm:shadow-none p-1">
                      <button
                          (click)="updateQuantity(item.productId, -1)"
                          [disabled]="item.quantity <= 1 || isUpdating"
                          class="w-8 h-8 flex items-center justify-center text-gray-500 hover:bg-white hover:text-blue-600 hover:shadow-sm rounded-md transition-all disabled:opacity-30">
                          <i class="pi pi-minus text-[10px] font-bold"></i>
                      </button>
                      <span class="w-8 text-center font-bold text-gray-900 text-sm select-none">{{ item.quantity }}</span>
                      <button
                          (click)="updateQuantity(item.productId, 1)"
                          [disabled]="isUpdating"
                          class="w-8 h-8 flex items-center justify-center text-gray-500 hover:bg-white hover:text-blue-600 hover:shadow-sm rounded-md transition-all">
                          <i class="pi pi-plus text-[10px] font-bold"></i>
                      </button>
                  </div>

                  <div class="text-right w-24">
                      <span class="text-xs text-gray-400 block sm:hidden mb-1">Сумма</span>
                      <span class="block text-lg font-extrabold text-blue-600 whitespace-nowrap">{{ item.sum | number:'1.0-0' }} ₽</span>
                  </div>
                </div>

                <button
                  (click)="removeItem(item.id)"
                  pTooltip="Удалить"
                  tooltipPosition="left"
                  class="text-gray-300 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition-all absolute top-2 right-2 sm:static"
                >
                  <i class="pi pi-trash text-lg"></i>
                </button>
              </div>
            </div>

            <div class="flex justify-end pt-2">
              <button (click)="clearCart()" class="text-sm font-medium text-gray-400 hover:text-red-500 transition-colors flex items-center gap-2 group">
                  <i class="pi pi-trash group-hover:animate-bounce"></i> Очистить корзину
              </button>
            </div>
          </div>

          <div class="w-full lg:w-96">
            <div class="bg-white rounded-2xl shadow-xl shadow-blue-900/5 border border-gray-100 p-6 sticky top-28">
              <h3 class="text-xl font-bold text-gray-900 mb-6">Ваш заказ</h3>

              <div class="space-y-3 mb-6">
                  <div class="flex justify-between text-gray-500 text-sm">
                      <span>Товары ({{ cartCount() }})</span>
                      <span class="font-medium">{{ cart()?.totalPrice | number:'1.0-0' }} ₽</span>
                  </div>
                  <div class="flex justify-between text-gray-500 text-sm">
                      <span>Скидка</span>
                      <span class="text-green-600 font-medium">0 ₽</span>
                  </div>
                  <div class="h-px bg-gray-100 my-4"></div>

                  <div class="flex justify-between items-end">
                      <span class="text-lg font-bold text-gray-900">Итого к оплате</span>
                      <span class="text-3xl font-extrabold text-blue-600">{{ cart()?.totalPrice | number:'1.0-0' }} ₽</span>
                  </div>
              </div>

              <button
                  pButton
                  label="Оформить заказ"
                  class="w-full font-bold text-lg py-4 border-none bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 transform hover:-translate-y-0.5 transition-all rounded-xl"
                  [loading]="isOrdering"
                  (click)="checkout()">
              </button>

              <div class="mt-6 flex items-start gap-3 bg-blue-50 p-3 rounded-lg">
                  <i class="pi pi-info-circle text-blue-600 mt-0.5"></i>
                  <p class="text-xs text-blue-800 leading-relaxed">
                    Нажимая кнопку, вы подтверждаете заказ. Оплата и доставка обсуждаются с менеджером.
                  </p>
              </div>
            </div>
          </div>

        </div>
      </div>

      <p-dialog
        [(visible)]="showSuccessDialog"
        [modal]="true"
        [style]="{width: '450px'}"
        styleClass="rounded-2xl overflow-hidden"
        [closable]="false"
        [draggable]="false"
        [resizable]="false">

        <ng-template pTemplate="header">
            <div class="w-full text-center pt-6">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
                    <i class="pi pi-check text-4xl text-green-600 font-bold"></i>
                </div>
                <h2 class="text-2xl font-extrabold text-gray-900">Спасибо за заказ!</h2>
            </div>
        </ng-template>

        <div class="text-center px-4 pb-4">
            <p class="text-lg font-medium text-gray-700 mb-2">
                Заказ <span class="text-blue-600 font-bold">#{{ createdOrderId }}</span> успешно создан.
            </p>
            <p class="text-gray-500 text-sm leading-relaxed">
                Мы уже видим вашу заявку! В ближайшее время (обычно в течение 15 минут) с вами свяжется менеджер для уточнения
                <span class="font-bold text-gray-700">адреса доставки</span> и
                <span class="font-bold text-gray-700">способа оплаты</span>.
            </p>

            <div class="mt-6 p-4 bg-gray-50 rounded-xl border border-gray-100 text-left text-sm text-gray-600">
                <p class="mb-1"><i class="pi pi-phone mr-2 text-gray-400"></i> Держите телефон рядом</p>
                <p><i class="pi pi-clock mr-2 text-gray-400"></i> Мы работаем с 09:00 до 21:00</p>
            </div>
        </div>

        <ng-template pTemplate="footer">
            <div class="p-4 pt-0">
                <button
                    pButton
                    label="Понятно, жду звонка"
                    class="w-full p-button-lg font-bold rounded-xl"
                    (click)="closeSuccessDialog()">
                </button>
            </div>
        </ng-template>
      </p-dialog>

    </div>
  `,
  styles: [`
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Делаем диалог красивым */
    :host ::ng-deep .p-dialog .p-dialog-content { border-radius: 0 !important; }
    :host ::ng-deep .p-dialog .p-dialog-header { border-bottom: none; background: white; padding-bottom: 0; }
    :host ::ng-deep .p-dialog .p-dialog-footer { border-top: none; background: white; padding-top: 0; }
  `]
})
export class CartComponent implements OnInit {
  private cartService = inject(CartService);
  private orderService = inject(OrderService);
  private router = inject(Router);
  private messageService = inject(MessageService);

  cart = this.cartService.cartSig;
  cartCount = this.cartService.cartCountSig;

  isOrdering = false;
  isUpdating = false;
  isLoading = true;

  showSuccessDialog = false;
  createdOrderId: number | null = null;

  ngOnInit() {
    this.cartService.getCart().subscribe({
        next: () => this.isLoading = false,
        error: () => this.isLoading = false
    });
  }

  updateQuantity(productId: number, delta: number) {
    this.isUpdating = true;
    this.cartService.addToCart(productId, delta).subscribe({
        next: () => this.isUpdating = false,
        error: () => {
            this.isUpdating = false;
            this.messageService.add({severity: 'error', summary: 'Ошибка', detail: 'Не удалось обновить количество'});
        }
    });
  }

  removeItem(itemId: number) {
    this.cartService.removeItem(itemId).subscribe({
        next: () => {
             this.messageService.add({severity: 'info', summary: 'Удалено', detail: 'Товар удален из корзины'});
        }
    });
  }

  clearCart() {
    this.cartService.clearCart().subscribe();
  }

  checkout() {
    this.isOrdering = true;
    this.orderService.createOrder().subscribe({
      next: (order) => {
        this.isOrdering = false;

        this.createdOrderId = order.id;
        this.cartService.getCart().subscribe();
        this.showSuccessDialog = true;
      },
      error: (err) => {
        this.isOrdering = false;
        console.error(err);
        this.messageService.add({ severity: 'error', summary: 'Ошибка', detail: 'Не удалось оформить заказ' });
      }
    });
  }

  closeSuccessDialog() {
      this.showSuccessDialog = false;
      this.router.navigate(['/profile']);
  }
}
</file>

<file path="autoparts-client/src/app/features/catalog/catalog.component.ts">
import { Component, inject, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ActivatedRoute } from '@angular/router';
import { FormsModule } from '@angular/forms';
import { switchMap } from 'rxjs';

import { ProductService } from '../../core/services/product.service';
import { CartService } from '../../core/services/cart.service';
import { ProductDto } from '../../core/models/catalog.models';

import { MessageService } from 'primeng/api';
import { DropdownModule } from 'primeng/dropdown';
import { SkeletonModule } from 'primeng/skeleton';
import { ButtonModule } from 'primeng/button';

@Component({
  selector: 'app-catalog',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    DropdownModule,
    SkeletonModule,
    ButtonModule
  ],
  template: `
    <div class="fade-in pb-12">

      <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-8">
        <div>
          <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Каталог запчастей</h1>
          <p class="text-gray-500 mt-2 text-sm" *ngIf="!isLoading">
            Найдено <span class="font-bold text-gray-800">{{ products.length }}</span> товаров
          </p>
          <p class="text-gray-500 mt-2 text-sm" *ngIf="isLoading">
            <p-skeleton width="150px" height="1rem"></p-skeleton>
          </p>
        </div>

        <div class="w-full md:w-64">
          <p-dropdown
            [options]="sortOptions"
            [(ngModel)]="selectedSort"
            (onChange)="onSortChange()"
            optionLabel="label"
            placeholder="Сортировка"
            styleClass="w-full"
            [disabled]="isLoading">
          </p-dropdown>
        </div>
      </div>

      <div *ngIf="isLoading" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <div *ngFor="let i of [1,2,3,4,5,6,7,8]" class="bg-white rounded-2xl p-4 border border-gray-100 shadow-sm">
           <p-skeleton height="180px" styleClass="mb-4 rounded-xl"></p-skeleton>
           <p-skeleton width="40%" styleClass="mb-2"></p-skeleton>
           <p-skeleton width="80%" styleClass="mb-4"></p-skeleton>
           <div class="flex justify-between items-center mt-4">
             <p-skeleton width="30%" height="2rem"></p-skeleton>
             <p-skeleton shape="circle" size="2.5rem"></p-skeleton>
           </div>
        </div>
      </div>

      <div *ngIf="!isLoading && products.length === 0" class="flex flex-col items-center justify-center py-24 bg-white rounded-3xl shadow-sm border border-gray-100 border-dashed">
        <div class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center mb-6 animate-pulse">
          <i class="pi pi-search text-4xl text-blue-300"></i>
        </div>
        <h3 class="text-2xl font-bold text-gray-900 mb-2">Ничего не найдено</h3>
        <p class="text-gray-500 text-center max-w-sm">
          Мы не нашли товаров по вашему запросу. Попробуйте изменить категорию или поисковый запрос.
        </p>
      </div>

      <div *ngIf="!isLoading && products.length > 0" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">

        <div *ngFor="let product of products" class="group relative bg-white rounded-2xl p-4 border border-gray-100 transition-all duration-300 hover:shadow-xl hover:-translate-y-1 hover:border-blue-200 flex flex-col h-full">

          <div class="absolute top-4 left-4 z-10 flex gap-2">
             <span *ngIf="product.stockQuantity === 0" class="bg-red-50 text-red-600 border border-red-100 text-[10px] font-bold px-2.5 py-1 rounded-lg uppercase tracking-wider">
               Нет в наличии
             </span>
             <span *ngIf="product.stockQuantity > 0 && product.stockQuantity < 5" class="bg-orange-50 text-orange-600 border border-orange-100 text-[10px] font-bold px-2.5 py-1 rounded-lg uppercase tracking-wider">
               Заканчивается
             </span>
          </div>

          <div class="relative h-56 mb-5 overflow-hidden rounded-xl bg-gray-50 flex items-center justify-center group-hover:bg-white transition-colors">
            <img
              [src]="product.imageUrl || 'https://placehold.co/400x300?text=No+Image'"
              [alt]="product.name"
              class="h-full w-full object-contain p-6 mix-blend-multiply group-hover:scale-105 transition-transform duration-500 ease-out"
            />
          </div>

          <div class="flex-1 flex flex-col">
            <div class="flex items-center justify-between mb-2">
               <span class="text-[10px] font-bold text-gray-400 bg-gray-100 px-2 py-0.5 rounded-md uppercase tracking-widest">
                 SKU: {{ product.sku }}
               </span>
            </div>

            <h3 class="font-bold text-gray-800 text-base leading-snug mb-3 line-clamp-2 group-hover:text-blue-600 transition-colors cursor-pointer" title="{{product.name}}">
              {{ product.name }}
            </h3>

            <div class="mt-auto pt-4 flex items-center justify-between border-t border-gray-50/50">
              <div class="flex flex-col">
                <span class="text-2xl font-extrabold text-gray-900 tracking-tight">
                  {{ product.price | number:'1.0-0' }} ₽
                </span>
                <span class="text-xs text-gray-400 font-medium">Цена за шт.</span>
              </div>

              <button
                pButton
                icon="pi pi-shopping-cart"
                (click)="addToCart(product)"
                [disabled]="product.stockQuantity === 0"
                class="w-12 h-12 rounded-xl flex items-center justify-center transition-all shadow-sm hover:shadow-blue-200"
                [ngClass]="{
                    'bg-gray-100 text-gray-400 cursor-not-allowed': product.stockQuantity === 0,
                    'bg-blue-600 text-white hover:bg-blue-700 hover:scale-105 active:scale-95': product.stockQuantity > 0
                }"
              >
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
  `,
  styles: [`
    .fade-in { animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Кастомизация дропдауна PrimeNG под Tailwind */
    :host ::ng-deep .p-dropdown {
        border-radius: 0.75rem;
        border-color: #E5E7EB;
    }
    :host ::ng-deep .p-dropdown:not(.p-disabled).p-focus {
        border-color: #3B82F6;
        box-shadow: 0 0 0 2px #BFDBFE;
    }
  `]
})
export class CatalogComponent implements OnInit {
  private route = inject(ActivatedRoute);
  private productService = inject(ProductService);
  private cartService = inject(CartService);
  private messageService = inject(MessageService);

  products: ProductDto[] = [];
  isLoading = true;

  sortOptions = [
    { label: 'По популярности', value: 'popular' },
    { label: 'Сначала дешевые', value: 'price_asc' },
    { label: 'Сначала дорогие', value: 'price_desc' }
  ];
  selectedSort = this.sortOptions[0];

  ngOnInit() {
    this.route.queryParams.pipe(
      switchMap(params => {
        this.isLoading = true;

        const categoryId = params['category'] ? Number(params['category']) : undefined;
        const query = params['q'];

        return this.productService.getAll(categoryId, query);
      })
    ).subscribe({
      next: (data) => {
        this.products = data;
        this.sortProducts();
        this.isLoading = false;
      },
      error: (err) => {
        console.error(err);
        this.messageService.add({ severity: 'error', summary: 'Ошибка', detail: 'Не удалось загрузить товары' });
        this.isLoading = false;
      }
    });
  }

  onSortChange() {
    this.sortProducts();
  }

  sortProducts() {
    if (this.selectedSort.value === 'price_asc') {
      this.products.sort((a, b) => a.price - b.price);
    } else if (this.selectedSort.value === 'price_desc') {
      this.products.sort((a, b) => b.price - a.price);
    }
  }

  addToCart(product: ProductDto) {
    if (product.stockQuantity === 0) return;

    this.cartService.addToCart(product.id).subscribe({
      next: () => {
        this.messageService.add({
          severity: 'success',
          summary: 'Добавлено',
          detail: `${product.name} в корзине`,
          life: 2000
        });
      },
      error: () => {
         this.messageService.add({ severity: 'error', summary: 'Ошибка', detail: 'Не удалось добавить товар' });
      }
    });
  }
}
</file>

<file path="autoparts-client/src/app/features/landing/landing.component.ts">
import { Component, inject, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterLink, Router } from '@angular/router';
import { FormsModule } from '@angular/forms';

import { ProductService } from '../../core/services/product.service';
import { CartService } from '../../core/services/cart.service';
import { ProductDto } from '../../core/models/catalog.models';

import { ButtonModule } from 'primeng/button';
import { CarouselModule } from 'primeng/carousel';
import { TagModule } from 'primeng/tag';
import { MessageService } from 'primeng/api';

@Component({
  selector: 'app-landing',
  standalone: true,
  imports: [CommonModule, RouterLink, FormsModule, ButtonModule, CarouselModule, TagModule],
  template: `
    <div class="min-h-screen bg-[#F8F9FA] font-sans selection:bg-blue-100 selection:text-blue-900 pb-20">

      <section class="relative h-[85vh] min-h-[600px] flex items-center justify-center overflow-hidden">

        <div class="absolute inset-0 z-0">
          <img
            src="https://images.unsplash.com/photo-1486262715619-67b85e0b08d3?q=80&w=1920&auto=format&fit=crop"
            alt="Auto Background"
            class="w-full h-full object-cover scale-105 animate-slow-zoom"
          />
          <div class="absolute inset-0 bg-gradient-to-b from-slate-900/90 via-slate-900/70 to-[#F8F9FA]"></div>
        </div>

        <div class="relative z-10 text-center px-4 max-w-4xl w-full flex flex-col items-center">

          <div class="mb-8 fade-in-up" style="animation-delay: 0.1s;">
            <span class="py-1.5 px-4 rounded-full bg-white/10 border border-white/20 backdrop-blur-md text-blue-200 text-xs font-bold uppercase tracking-widest shadow-lg">
              🚀 Доставка за 24 часа
            </span>
          </div>

          <h1 class="text-4xl md:text-6xl lg:text-7xl font-black text-white mb-6 tracking-tight leading-[1.1] drop-shadow-2xl fade-in-up" style="animation-delay: 0.2s;">
            Найдите запчасти <br />
            <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300">быстро и точно</span>
          </h1>

          <p class="text-slate-300 text-lg md:text-xl mb-12 max-w-2xl font-light leading-relaxed fade-in-up" style="animation-delay: 0.3s;">
            Введите название детали или артикул (SKU).<br class="hidden md:block">
            Оригинальные запчасти и качественные аналоги в наличии.
          </p>

          <div class="w-full max-w-2xl fade-in-up relative z-20" style="animation-delay: 0.4s;">
            <div class="relative group">
              <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-cyan-500 rounded-2xl blur opacity-30 group-hover:opacity-60 transition duration-1000 group-hover:duration-200"></div>

              <div class="relative bg-white/90 backdrop-blur-xl border border-white/50 p-2 rounded-2xl flex items-center shadow-2xl">
                <i class="pi pi-search text-gray-400 text-xl ml-4"></i>
                <input
                  type="text"
                  [(ngModel)]="searchQuery"
                  (keyup.enter)="onSearch()"
                  placeholder="Например: Масляный фильтр или 15208-65F0A"
                  class="flex-1 bg-transparent border-none outline-none px-4 py-4 text-gray-900 text-lg placeholder-gray-500 font-medium"
                />
                <button
                  (click)="onSearch()"
                  class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-xl transition-all duration-300 shadow-lg hover:shadow-blue-500/50 active:scale-95"
                >
                  Найти
                </button>
              </div>
            </div>

            <div class="mt-6 flex flex-wrap justify-center gap-3 text-sm text-slate-400">
              <span class="mt-1">Часто ищут:</span>
              <button (click)="quickSearch('Масло 5w40')" class="px-3 py-1 rounded-full border border-white/10 hover:bg-white/10 hover:text-white transition-colors cursor-pointer bg-white/5">Масло 5w40</button>
              <button (click)="quickSearch('Фильтр')" class="px-3 py-1 rounded-full border border-white/10 hover:bg-white/10 hover:text-white transition-colors cursor-pointer bg-white/5">Фильтры</button>
              <button (click)="quickSearch('Колодки')" class="px-3 py-1 rounded-full border border-white/10 hover:bg-white/10 hover:text-white transition-colors cursor-pointer bg-white/5">Тормозные колодки</button>
            </div>
          </div>
        </div>
      </section>

      <section class="py-12 px-6 relative z-30 -mt-20">
        <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">

          <div class="bg-white/90 backdrop-blur p-8 rounded-3xl shadow-xl shadow-gray-200/50 hover:-translate-y-1 transition-transform duration-300 border border-white/50">
            <div class="w-14 h-14 bg-blue-100 rounded-2xl flex items-center justify-center mb-6 text-blue-600">
              <i class="pi pi-check-circle text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Точный подбор</h3>
            <p class="text-gray-500 text-sm leading-relaxed">Поиск по артикулу гарантирует 100% совместимость с вашим авто.</p>
          </div>

          <div class="bg-white/90 backdrop-blur p-8 rounded-3xl shadow-xl shadow-gray-200/50 hover:-translate-y-1 transition-transform duration-300 border border-white/50">
            <div class="w-14 h-14 bg-orange-100 rounded-2xl flex items-center justify-center mb-6 text-orange-600">
              <i class="pi pi-truck text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Быстрая доставка</h3>
            <p class="text-gray-500 text-sm leading-relaxed">Отгружаем со склада в день заказа. Доставка курьером до двери.</p>
          </div>

          <div class="bg-white/90 backdrop-blur p-8 rounded-3xl shadow-xl shadow-gray-200/50 hover:-translate-y-1 transition-transform duration-300 border border-white/50">
            <div class="w-14 h-14 bg-green-100 rounded-2xl flex items-center justify-center mb-6 text-green-600">
              <i class="pi pi-wallet text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Честная цена</h3>
            <p class="text-gray-500 text-sm leading-relaxed">Работаем напрямую с дистрибьюторами. Никаких скрытых наценок.</p>
          </div>

        </div>
      </section>

      <section class="py-16">
        <div class="max-w-7xl mx-auto px-6">
          <div class="flex justify-between items-end mb-10">
            <div>
              <span class="text-blue-600 font-bold tracking-wider uppercase text-xs">Каталог</span>
              <h2 class="text-3xl font-extrabold text-gray-900 mt-2">Популярные категории</h2>
            </div>
            <a routerLink="/catalog" class="hidden md:flex items-center gap-2 text-gray-500 font-medium hover:text-blue-600 transition-colors text-sm">
              Весь каталог <i class="pi pi-arrow-right text-xs"></i>
            </a>
          </div>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
            <a [routerLink]="['/catalog']" [queryParams]="{q: 'Масло'}" class="group relative h-64 md:h-80 rounded-3xl overflow-hidden cursor-pointer shadow-md hover:shadow-2xl transition-all duration-500">
              <img src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fwww.allcarz.ru%2Fwp-content%2Fuploads%2F2024%2F10%2Ffoto-motornoe-maslo-kak-vybrat_01.jpg&f=1&nofb=1&ipt=29604b7f9bde51d25a3f31eb7c6bef1d668d5de896996aba93da465213f02bbb" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
              <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-transparent to-transparent"></div>
              <div class="absolute bottom-0 left-0 p-6 w-full transform translate-y-2 group-hover:translate-y-0 transition-transform">
                <h3 class="text-xl font-bold text-white">Масла</h3>
                <p class="text-blue-300 text-xs font-medium mt-1 opacity-0 group-hover:opacity-100 transition-opacity">Перейти &rarr;</p>
              </div>
            </a>

            <a [routerLink]="['/catalog']" [queryParams]="{q: 'Фильтр'}" class="group relative h-64 md:h-80 rounded-3xl overflow-hidden cursor-pointer shadow-md hover:shadow-2xl transition-all duration-500">
              <img src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Ftse1.mm.bing.net%2Fth%2Fid%2FOIP.CR6ruiQ_-i9YcX-45lSk9gHaE8%3Fpid%3DApi&f=1&ipt=3517fad84a17e75e811b4a965fdc9b7b2ff418528e75f93e3010b78b63e23ee7" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
              <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-transparent to-transparent"></div>
              <div class="absolute bottom-0 left-0 p-6 w-full transform translate-y-2 group-hover:translate-y-0 transition-transform">
                <h3 class="text-xl font-bold text-white">Фильтры</h3>
                <p class="text-blue-300 text-xs font-medium mt-1 opacity-0 group-hover:opacity-100 transition-opacity">Перейти &rarr;</p>
              </div>
            </a>

            <a [routerLink]="['/catalog']" [queryParams]="{q: 'Аккумулятор'}" class="group relative h-64 md:h-80 rounded-3xl overflow-hidden cursor-pointer shadow-md hover:shadow-2xl transition-all duration-500">
              <img src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Ftj-service.ru%2Fwp-content%2Fuploads%2F2023%2F12%2Fphoto_2023-12-11_11-25-52.jpg&f=1&nofb=1&ipt=5522ab51b928c776ba7eac4e228ecc4676214eb5ad27d2c94e91ef3d8669346e" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
              <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-transparent to-transparent"></div>
              <div class="absolute bottom-0 left-0 p-6 w-full transform translate-y-2 group-hover:translate-y-0 transition-transform">
                <h3 class="text-xl font-bold text-white">Аккумуляторы</h3>
                <p class="text-blue-300 text-xs font-medium mt-1 opacity-0 group-hover:opacity-100 transition-opacity">Перейти &rarr;</p>
              </div>
            </a>

             <a [routerLink]="['/catalog']" [queryParams]="{q: 'Шины'}" class="group relative h-64 md:h-80 rounded-3xl overflow-hidden cursor-pointer shadow-md hover:shadow-2xl transition-all duration-500">
              <img src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Ftaned.ru%2Fwp-content%2Fuploads%2F2023%2F01%2Fgalaxy-xd2010.jpg&f=1&nofb=1&ipt=47405149290782300086d45db4466474d8fd6393e5c829dddae874d6af2ab3b9" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
              <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-transparent to-transparent"></div>
              <div class="absolute bottom-0 left-0 p-6 w-full transform translate-y-2 group-hover:translate-y-0 transition-transform">
                <h3 class="text-xl font-bold text-white">Шины</h3>
                <p class="text-blue-300 text-xs font-medium mt-1 opacity-0 group-hover:opacity-100 transition-opacity">Перейти &rarr;</p>
              </div>
            </a>
          </div>
        </div>
      </section>

      <section class="py-16 bg-white border-y border-gray-100">
        <div class="max-w-7xl mx-auto px-6">
          <div class="text-center mb-12">
            <h2 class="text-3xl font-extrabold text-gray-900">Хиты продаж</h2>
            <p class="text-gray-500 mt-2 max-w-xl mx-auto text-sm">Товары, которые чаще всего выбирают наши клиенты. Отличное соотношение цены и качества.</p>
          </div>

          <p-carousel
            [value]="featuredProducts"
            [numVisible]="4"
            [numScroll]="1"
            [circular]="true"
            [autoplayInterval]="4000"
            [responsiveOptions]="responsiveOptions"
            styleClass="custom-carousel"
          >
            <ng-template let-product pTemplate="item">
              <div class="p-3 h-full">
                <div class="bg-white rounded-2xl border border-gray-100 p-4 h-full flex flex-col relative hover:shadow-xl hover:shadow-blue-50 hover:border-blue-200 transition-all duration-300 group">

                  <div class="absolute top-4 left-4 z-10">
                    <span class="bg-red-50 text-red-600 text-[10px] font-bold px-2 py-1 rounded-md uppercase tracking-wide">-15%</span>
                  </div>

                  <div class="h-48 flex items-center justify-center bg-gray-50 rounded-xl mb-4 overflow-hidden relative">
                    <img [src]="product.imageUrl || 'https://placehold.co/200?text=AutoParts'"
                         class="max-h-full max-w-full object-contain mix-blend-multiply group-hover:scale-110 transition-transform duration-500 p-4">
                  </div>

                  <div class="mb-1 text-[10px] font-bold text-gray-400 uppercase tracking-widest">Арт: {{ product.sku }}</div>
                  <h4 class="font-bold text-gray-800 text-base leading-snug mb-3 line-clamp-2 min-h-[3rem] group-hover:text-blue-600 transition-colors">
                    {{ product.name }}
                  </h4>

                  <div class="mt-auto flex items-end justify-between border-t border-gray-50 pt-3">
                    <div class="flex flex-col">
                      <span class="text-xs text-gray-400 line-through">{{ product.price * 1.15 | number:'1.0-0' }} ₽</span>
                      <span class="text-xl font-extrabold text-gray-900">{{ product.price | number:'1.0-0' }} ₽</span>
                    </div>

                    <button
                      (click)="addToCart(product)"
                      class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center text-blue-600 hover:bg-blue-600 hover:text-white transition-all shadow-sm active:scale-95"
                    >
                      <i class="pi pi-plus font-bold text-sm"></i>
                    </button>
                  </div>
                </div>
              </div>
            </ng-template>
          </p-carousel>
        </div>
      </section>

      <section class="py-20 px-6">
        <div class="max-w-6xl mx-auto rounded-[2.5rem] bg-gradient-to-br from-slate-900 to-blue-900 relative overflow-hidden shadow-2xl shadow-blue-900/30">

          <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-blue-500 rounded-full blur-[120px] opacity-20 translate-x-1/3 -translate-y-1/3"></div>
          <div class="absolute bottom-0 left-0 w-[300px] h-[300px] bg-cyan-500 rounded-full blur-[100px] opacity-10 -translate-x-1/2 translate-y-1/2"></div>

          <div class="relative z-10 flex flex-col md:flex-row items-center justify-between p-10 md:p-16 gap-10">
            <div class="text-center md:text-left max-w-xl">
              <h2 class="text-3xl md:text-4xl font-bold text-white mb-4 leading-tight">
                Зарегистрируйтесь и получите <br/> скидку на первый заказ
              </h2>
              <p class="text-blue-100 text-base mb-8 font-light">
                Создайте личный кабинет, чтобы сохранять историю заказов, отслеживать статус доставки и получать персональные предложения.
              </p>
              <div class="flex flex-col sm:flex-row gap-4 justify-center md:justify-start">
                <button routerLink="/register" class="bg-white text-blue-900 font-bold py-3.5 px-8 rounded-xl hover:bg-blue-50 transition-all shadow-lg hover:shadow-white/20">
                  Создать аккаунт
                </button>
                <button routerLink="/login" class="bg-transparent border border-white/20 text-white font-bold py-3.5 px-8 rounded-xl hover:bg-white/10 transition-colors">
                  Войти
                </button>
              </div>
            </div>

            <div class="hidden md:flex relative animate-float">
               <div class="w-40 h-40 bg-gradient-to-tr from-white/10 to-white/5 rounded-3xl flex items-center justify-center backdrop-blur-md border border-white/10 shadow-2xl transform rotate-6 hover:rotate-0 transition-all duration-500">
                 <i class="pi pi-user text-6xl text-blue-200"></i>
               </div>
            </div>
          </div>
        </div>
      </section>

    </div>
  `,
  styles: [`
    /* Анимации */
    .fade-in-up { opacity: 0; animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

    .animate-slow-zoom { animation: slowZoom 25s infinite alternate ease-in-out; }
    @keyframes slowZoom { from { transform: scale(1.0); } to { transform: scale(1.1); } }

    .animate-float { animation: float 6s ease-in-out infinite; }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

    /* Кастомизация карусели */
    ::ng-deep .custom-carousel .p-carousel-indicators { padding-top: 1.5rem; }
    ::ng-deep .custom-carousel .p-carousel-indicator button { background-color: #E2E8F0; width: 8px; height: 8px; border-radius: 50%; transition: all 0.3s; margin: 0 4px; }
    ::ng-deep .custom-carousel .p-carousel-indicator.p-highlight button { background-color: #3B82F6; transform: scale(1.5); }
  `]
})
export class LandingComponent implements OnInit {
  private productService = inject(ProductService);
  private cartService = inject(CartService);
  private messageService = inject(MessageService);
  private router = inject(Router);

  searchQuery = '';
  featuredProducts: ProductDto[] = [];

  responsiveOptions = [
    { breakpoint: '1400px', numVisible: 4, numScroll: 1 },
    { breakpoint: '1100px', numVisible: 3, numScroll: 1 },
    { breakpoint: '768px', numVisible: 2, numScroll: 1 },
    { breakpoint: '560px', numVisible: 1, numScroll: 1 }
  ];

  ngOnInit() {
    this.productService.getAll().subscribe(data => {
      this.featuredProducts = data.slice(0, 8);
    });
  }

  onSearch() {
    if (this.searchQuery.trim()) {
      this.router.navigate(['/catalog'], { queryParams: { q: this.searchQuery } });
    }
  }

  quickSearch(term: string) {
    this.searchQuery = term;
    this.onSearch();
  }

  addToCart(product: ProductDto) {
    this.cartService.addToCart(product.id).subscribe({
      next: () => {
         this.messageService.add({ severity: 'success', summary: 'Добавлено', detail: `${product.name} в корзине` });
      }
    });
  }
}
</file>

<file path="autoparts-client/src/app/features/profile/profile.component.ts">
import { Component, inject, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Router, RouterLink } from '@angular/router';
import { OrderDto, OrderService } from '../../core/services/order.service';
import { AuthService } from '../../core/auth/auth.service';

import { HeaderComponent } from '../../layout/header/header.component';

import { TableModule } from 'primeng/table';
import { TagModule } from 'primeng/tag';
import { ButtonModule } from 'primeng/button';
import { CardModule } from 'primeng/card';
import { AvatarModule } from 'primeng/avatar';
import { TooltipModule } from 'primeng/tooltip';
import { BadgeModule } from 'primeng/badge';

@Component({
  selector: 'app-profile',
  standalone: true,
  imports: [
    CommonModule,
    RouterLink,
    HeaderComponent,
    TableModule,
    TagModule,
    ButtonModule,
    CardModule,
    AvatarModule,
    TooltipModule,
    BadgeModule
  ],
  template: `
    <div class="min-h-screen bg-[#F8F9FA] flex flex-col">

      <app-header></app-header>

      <div class="flex-1 relative pb-12 fade-in">
        <div class="h-56 bg-gradient-to-r from-slate-800 to-blue-900 w-full absolute top-0 left-0 z-0"></div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 relative z-10 pt-8">

          <h1 class="text-3xl font-bold text-white mb-8">Личный кабинет</h1>

          <div class="flex flex-col lg:flex-row gap-8">

            <div class="w-full lg:w-80 flex-shrink-0">
              <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 sticky top-28">

                <div class="flex flex-col items-center text-center">
                  <div class="relative mb-4">
                    <p-avatar
                      icon="pi pi-user"
                      size="xlarge"
                      shape="circle"
                      styleClass="w-24 h-24 bg-blue-50 text-blue-600 text-4xl border-4 border-white shadow-md">
                    </p-avatar>
                    <span class="absolute bottom-1 right-1 w-5 h-5 bg-green-500 border-2 border-white rounded-full"></span>
                  </div>

                  <h2 class="text-xl font-bold text-gray-900">
                    {{ user()?.firstName }} {{ user()?.lastName }}
                  </h2>
                  <p class="text-gray-500 text-sm mt-1 font-medium bg-gray-50 px-3 py-1 rounded-full">
                      {{ user()?.phone || 'Гость' }}
                  </p>

                  <div class="mt-6 w-full space-y-2">
                     <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                        <span class="text-sm text-gray-500">Всего заказов</span>
                        <span class="font-bold text-gray-900">{{ orders.length }}</span>
                     </div>
                  </div>

                  <div class="w-full border-t border-gray-100 my-6"></div>

                  <button
                    (click)="logout()"
                    class="w-full flex items-center justify-center gap-2 text-red-500 hover:bg-red-50 py-3 rounded-xl transition-colors font-medium">
                    <i class="pi pi-sign-out"></i> Выйти из аккаунта
                  </button>
                </div>
              </div>
            </div>

            <div class="flex-1">
              <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden min-h-[400px]">

                <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-white">
                   <h3 class="font-bold text-lg text-gray-800">История заказов</h3>
                   <button pButton icon="pi pi-refresh" class="p-button-text p-button-rounded p-button-secondary" (click)="loadOrders()" pTooltip="Обновить список"></button>
                </div>

                <div *ngIf="!isLoading && orders.length === 0" class="flex flex-col items-center justify-center py-20 text-center">
                   <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mb-4">
                      <i class="pi pi-inbox text-3xl text-gray-300"></i>
                   </div>
                   <h4 class="text-gray-900 font-bold text-lg">Заказов пока нет</h4>
                   <p class="text-gray-500 max-w-xs mt-2 mb-6">Вы еще ничего не заказывали. Самое время выбрать что-то для своего авто.</p>
                   <button pButton label="Перейти в каталог" routerLink="/catalog" class="p-button-rounded"></button>
                </div>

                <p-table
                  *ngIf="orders.length > 0"
                  [value]="orders"
                  dataKey="id"
                  [expandedRowKeys]="expandedRows"
                  styleClass="p-datatable-gridlines-none"
                  [tableStyle]="{ 'min-width': '50rem' }"
                >
                  <ng-template pTemplate="header">
                    <tr class="bg-gray-50/50 text-xs uppercase tracking-wider text-gray-500 border-b border-gray-100">
                      <th style="width: 4rem"></th>
                      <th class="py-4 pl-4 font-medium">№ Заказа</th>
                      <th class="font-medium">Дата</th>
                      <th class="font-medium">Сумма</th>
                      <th class="font-medium">Статус</th>
                    </tr>
                  </ng-template>

                  <ng-template pTemplate="body" let-order let-expanded="expanded">
                    <tr class="hover:bg-blue-50/30 transition-colors border-b border-gray-50 last:border-0 cursor-pointer" [pRowToggler]="order">
                      <td class="text-center">
                        <button type="button" pButton pRipple class="p-button-text p-button-rounded p-button-plain p-button-sm w-8 h-8" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                      </td>
                      <td class="font-bold text-gray-700 py-5 pl-4">
                         <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-sm">#{{ order.id }}</span>
                      </td>
                      <td class="text-gray-600 text-sm font-medium">
                        {{ order.createdAt | date:'dd.MM.yyyy' }} <span class="text-gray-400 text-xs">{{ order.createdAt | date:'HH:mm' }}</span>
                      </td>
                      <td class="font-bold text-gray-900">
                        {{ order.totalPrice | number:'1.0-0' }} ₽
                      </td>
                      <td>
                        <p-tag [value]="getStatusLabel(order.status)" [severity]="getStatusSeverity(order.status)" styleClass="text-xs font-bold uppercase tracking-wide px-3"></p-tag>
                      </td>
                    </tr>
                  </ng-template>

                  <ng-template pTemplate="rowexpansion" let-order>
                    <tr>
                      <td colspan="5" class="p-0 border-b border-gray-100 bg-gray-50/50">
                        <div class="p-6">
                          <div class="flex items-center gap-2 mb-4">
                             <i class="pi pi-box text-blue-500"></i>
                             <h4 class="font-bold text-gray-700 text-sm uppercase tracking-wide">Состав заказа</h4>
                          </div>

                          <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                              <div *ngFor="let item of order.items; let last = last" class="flex flex-col sm:flex-row items-center gap-4 p-4 hover:bg-slate-50 transition-colors" [class.border-b]="!last" [class.border-gray-100]="!last">
                                  <div class="w-16 h-16 bg-gray-100 rounded-lg flex-shrink-0 flex items-center justify-center overflow-hidden border border-gray-200">
                                     <img *ngIf="item.imageUrl" [src]="item.imageUrl" class="w-full h-full object-cover mix-blend-multiply">
                                     <i *ngIf="!item.imageUrl" class="pi pi-image text-gray-400 text-xl"></i>
                                  </div>
                                  <div class="flex-1 text-center sm:text-left">
                                     <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">SKU: {{ item.sku }}</div>
                                     <div class="font-bold text-gray-800 text-sm">{{ item.name }}</div>
                                  </div>
                                  <div class="text-right w-24">
                                     <span class="font-bold text-blue-600">{{ (item.price * item.quantity) | number:'1.0-0' }} ₽</span>
                                  </div>
                              </div>
                          </div>
                        </div>
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  `,
  styles: [`
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    :host ::ng-deep .p-datatable .p-datatable-thead > tr > th { background: transparent; border: none; }
    :host ::ng-deep .p-datatable .p-datatable-tbody > tr > td { border-width: 0 0 1px 0; }
  `]
})
export class ProfileComponent implements OnInit {
  private orderService = inject(OrderService);
  private authService = inject(AuthService);
  private router = inject(Router);

  orders: OrderDto[] = [];
  expandedRows = {};
  isLoading = true;

  user = this.authService.currentUserSig;

  ngOnInit() {
    this.loadOrders();
  }

  loadOrders() {
    this.isLoading = true;
    this.orderService.getOrders().subscribe({
      next: (data) => {
        this.orders = data;
        this.isLoading = false;
      },
      error: (err) => {
        console.error(err);
        this.isLoading = false;
      }
    });
  }

  logout() {
    this.authService.logout();
    this.router.navigate(['/login']);
  }

  getStatusSeverity(status: string): "success" | "info" | "warning" | "danger" | "secondary" | "contrast" | undefined {
    switch (status) {
      case 'CREATED': return 'secondary';
      case 'CONFIRMED': return 'info';
      case 'PAID': return 'success';
      case 'SHIPPED': return 'warning';
      case 'COMPLETED': return 'success';
      case 'CANCELLED': return 'danger';
      default: return 'info';
    }
  }

  getStatusLabel(status: string): string {
    const map: Record<string, string> = {
      'CREATED': 'Создан', 'CONFIRMED': 'Подтвержден', 'PAID': 'Оплачен',
      'SHIPPED': 'В пути', 'COMPLETED': 'Выдан', 'CANCELLED': 'Отменен'
    };
    return map[status] || status;
  }
}
</file>

<file path="autoparts-client/src/app/layout/footer/footer.component.ts">
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterLink } from '@angular/router';

@Component({
  selector: 'app-footer',
  standalone: true,
  imports: [CommonModule, RouterLink],
  template: `
    <footer class="bg-white border-t border-gray-200 mt-auto">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 py-12">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">

          <div class="col-span-1 md:col-span-1">
            <div class="flex items-center gap-2 mb-4">
              <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                <i class="pi pi-cog spin-slow"></i>
              </div>
              <span class="text-xl font-extrabold text-gray-900 tracking-tight">AutoParts</span>
            </div>
            <p class="text-gray-500 text-sm leading-relaxed">
              Лучший магазин автозапчастей. Качество, гарантия и быстрая доставка по всей стране.
            </p>
          </div>

          <div>
            <h3 class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-4">Магазин</h3>
            <ul class="space-y-3">
              <li><a routerLink="/" class="text-gray-500 hover:text-blue-600 text-sm transition-colors">Главная</a></li>
              <li><a routerLink="/catalog" class="text-gray-500 hover:text-blue-600 text-sm transition-colors">Каталог</a></li>
              <li><a routerLink="/cart" class="text-gray-500 hover:text-blue-600 text-sm transition-colors">Корзина</a></li>
            </ul>
          </div>

          <div>
            <h3 class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-4">Клиентам</h3>
            <ul class="space-y-3">
              <li><a routerLink="/profile" class="text-gray-500 hover:text-blue-600 text-sm transition-colors">Личный кабинет</a></li>
              <li><a href="#" class="text-gray-500 hover:text-blue-600 text-sm transition-colors">Доставка и оплата</a></li>
              <li><a href="#" class="text-gray-500 hover:text-blue-600 text-sm transition-colors">Возврат товара</a></li>
            </ul>
          </div>

          <div>
            <h3 class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-4">Контакты</h3>
            <ul class="space-y-3 text-sm text-gray-500">
              <li class="flex items-center gap-2">
                <i class="pi pi-phone text-blue-500"></i>
                <span>+7 (777) 123-45-67</span>
              </li>
              <li class="flex items-center gap-2">
                <i class="pi pi-envelope text-blue-500"></i>
                <span>support@autoparts.com</span>
              </li>
              <li class="flex items-center gap-2">
                <i class="pi pi-map-marker text-blue-500"></i>
                <span>г. Самара, ул. Николая Панова 64</span>
              </li>
            </ul>
          </div>
        </div>

        <div class="border-t border-gray-100 mt-12 pt-8 flex flex-col md:flex-row justify-between items-center gap-4">
          <p class="text-gray-400 text-sm">© 2026 AutoParts Store. Все права защищены.</p>
          <div class="flex gap-4">
            <i class="pi pi-facebook text-gray-400 hover:text-blue-600 cursor-pointer text-lg transition-colors"></i>
            <i class="pi pi-instagram text-gray-400 hover:text-pink-600 cursor-pointer text-lg transition-colors"></i>
            <i class="pi pi-telegram text-gray-400 hover:text-blue-400 cursor-pointer text-lg transition-colors"></i>
          </div>
        </div>
      </div>
    </footer>
  `,
  styles: [`
    .spin-slow { animation: spin 12s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  `]
})
export class FooterComponent {}
</file>

<file path="autoparts-client/src/app/layout/header/header.component.ts">
import { Component, EventEmitter, Output, inject, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { RouterLink, Router } from '@angular/router';
import { CartService } from '../../core/services/cart.service';
import { AuthService } from '../../core/auth/auth.service';

import { AvatarModule } from 'primeng/avatar';
import { TooltipModule } from 'primeng/tooltip';

@Component({
  selector: 'app-header',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    RouterLink,
    AvatarModule,
    TooltipModule
  ],
  template: `
    <header class="sticky top-0 z-50 w-full bg-white/90 backdrop-blur-md border-b border-gray-100 transition-all duration-300">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 h-20 flex items-center justify-between gap-6">

        <a routerLink="/" class="flex items-center gap-2 group cursor-pointer no-underline">
          <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-600/30 group-hover:scale-105 transition-transform">
            <i class="pi pi-cog text-xl spin-slow"></i>
          </div>
          <div class="flex flex-col">
            <span class="text-xl font-extrabold text-gray-900 tracking-tight leading-none">AutoParts</span>
            <span class="text-[0.65rem] font-bold text-gray-400 uppercase tracking-widest">Store</span>
          </div>
        </a>

        <div class="hidden md:flex flex-1 max-w-xl relative group">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <i class="pi pi-search text-gray-400 group-focus-within:text-blue-500 transition-colors"></i>
          </div>
          <input
            type="text"
            [(ngModel)]="searchQuery"
            (keyup.enter)="onSearch()"
            class="block w-full pl-11 pr-4 py-3 bg-gray-100 border-none rounded-2xl text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:bg-white transition-all shadow-inner"
            placeholder="Поиск запчастей (название, артикул)..."
          >
          <button
            (click)="onSearch()"
            class="absolute right-2 top-2 bottom-2 bg-white shadow-sm text-gray-500 hover:text-blue-600 px-3 rounded-xl transition-all hover:shadow-md text-sm font-medium"
          >
            Найти
          </button>
        </div>

        <div class="flex items-center gap-2 sm:gap-4">

          <button
            routerLink="/cart"
            class="relative w-12 h-12 rounded-2xl flex items-center justify-center hover:bg-gray-100 text-gray-600 transition-colors group"
          >
            <i class="pi pi-shopping-cart text-xl group-hover:text-blue-600 transition-colors"></i>
            <span *ngIf="cartCount() > 0" class="absolute top-2 right-2 flex h-3 w-3">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
            </span>
          </button>

          <div class="h-8 w-px bg-gray-200"></div>

          <ng-container *ngIf="authService.currentUserSig(); else loginBtn">

            <button
              *ngIf="isAdmin"
              routerLink="/admin"
              class="w-12 h-12 rounded-2xl flex items-center justify-center hover:bg-purple-50 text-purple-600 transition-colors"
              pTooltip="Админ-панель"
              tooltipPosition="bottom"
            >
              <i class="pi pi-cog text-xl"></i>
            </button>

            <div
              routerLink="/profile"
              class="flex items-center gap-3 cursor-pointer p-1 pr-3 rounded-full hover:bg-gray-100 transition-all border border-transparent hover:border-gray-200"
            >
              <p-avatar icon="pi pi-user" shape="circle" styleClass="bg-gradient-to-br from-blue-500 to-blue-700 text-white shadow-md"></p-avatar>
              <div class="hidden lg:flex flex-col items-start">
                <span class="text-xs text-gray-500 font-medium">Мой кабинет</span>
                <span class="text-sm font-bold text-gray-800 leading-none">Профиль</span>
              </div>
            </div>

            <button
              (click)="onLogout()"
              class="w-10 h-10 rounded-full flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors"
              pTooltip="Выйти"
            >
              <i class="pi pi-sign-out"></i>
            </button>

          </ng-container>

          <ng-template #loginBtn>
            <a routerLink="/login" class="text-sm font-bold text-gray-700 hover:text-blue-600 transition-colors">Войти</a>
            <a routerLink="/register" class="bg-gray-900 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-gray-900/20 hover:bg-gray-800 hover:scale-105 transition-all">
              Регистрация
            </a>
          </ng-template>

        </div>
      </div>
    </header>
  `,
  styles: [`
    .spin-slow {
      animation: spin 10s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  `]
})
export class HeaderComponent implements OnInit {
  searchQuery = '';
  @Output() search = new EventEmitter<string>();

  public cartService = inject(CartService);
  public authService = inject(AuthService);
  public router = inject(Router);

  cartCount = this.cartService.cartCountSig;

  ngOnInit() {
    this.cartService.getCart().subscribe();
  }

  onSearch() {
    this.router.navigate(['/catalog'], { queryParams: { q: this.searchQuery } });
    this.search.emit(this.searchQuery);
  }

  get isAdmin() {
    return this.authService.isAdmin();
  }

  onLogout() {
    this.authService.logout();
  }
}
</file>

<file path="autoparts-client/src/app/layout/main-layout/main-layout.component.ts">
import { Component, inject, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterOutlet, Router } from '@angular/router';
import { HeaderComponent } from '../header/header.component';
import { FooterComponent } from '../footer/footer.component';
import { CategoryService } from '../../core/services/category.service';
import { TreeNode } from 'primeng/api';

import { TreeModule } from 'primeng/tree';
import { SidebarModule } from 'primeng/sidebar';
import { ButtonModule } from 'primeng/button';

@Component({
  selector: 'app-main-layout',
  standalone: true,
  imports: [
    CommonModule,
    RouterOutlet,
    HeaderComponent,
    FooterComponent,
    TreeModule,
    SidebarModule,
    ButtonModule
  ],
  template: `
    <div class="min-h-screen flex flex-col bg-slate-50">

      <app-header (search)="onSearch($event)"></app-header>

      <div class="flex flex-1 max-w-7xl mx-auto w-full px-4 sm:px-6 py-8 gap-8 relative">

        <aside class="w-72 hidden lg:flex flex-col gap-6 sticky top-28 h-fit">

          <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden p-5">
            <h3 class="flex items-center gap-2 text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 px-2">
              <i class="pi pi-list"></i> Каталог
            </h3>

            <ng-container *ngTemplateOutlet="categoriesTree"></ng-container>
          </div>

          <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl p-6 text-white shadow-xl shadow-blue-900/20 relative overflow-hidden group cursor-pointer transform transition-transform hover:-translate-y-1">
            <div class="absolute -right-6 -top-6 w-32 h-32 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition-colors"></div>
            <div class="absolute -left-6 bottom-0 w-24 h-24 bg-blue-500/30 rounded-full blur-2xl"></div>

            <h4 class="text-xl font-bold relative z-10 leading-tight">Сезонное ТО</h4>
            <p class="text-blue-100 text-sm mt-2 relative z-10 mb-5 leading-relaxed">
              Масло, фильтры и свечи.<br>Скидки до <span class="text-yellow-300 font-bold">20%</span>
            </p>
            <button class="bg-white text-blue-700 text-xs font-bold py-2.5 px-5 rounded-xl shadow-sm hover:shadow-md transition-all flex items-center gap-2">
              Перейти <i class="pi pi-arrow-right text-[10px]"></i>
            </button>
          </div>

        </aside>

        <div class="lg:hidden w-full mb-4">
            <button
                pButton
                label="Каталог запчастей"
                icon="pi pi-bars"
                class="w-full p-button-outlined p-button-secondary border-gray-300 bg-white text-gray-700"
                (click)="mobileSidebarVisible = true">
            </button>
        </div>

        <main class="flex-1 w-full min-w-0">
          <router-outlet></router-outlet>
        </main>

      </div>

      <app-footer></app-footer>

    </div>

    <p-sidebar [(visible)]="mobileSidebarVisible" position="left" styleClass="w-80">
        <ng-template pTemplate="header">
            <span class="font-bold text-xl text-gray-800">Категории</span>
        </ng-template>
        <div class="mt-4">
             <ng-container *ngTemplateOutlet="categoriesTree"></ng-container>
        </div>
    </p-sidebar>


    <ng-template #categoriesTree>
        <p-tree
            [value]="categories"
            selectionMode="single"
            (onNodeSelect)="onCategorySelect($event)"
            styleClass="w-full border-none p-0 custom-tree"
            [filter]="true"
            filterPlaceholder="Фильтр категорий..."
        >
            <ng-template let-node pTemplate="default">
                <span class="text-sm text-gray-600 font-medium group-hover:text-blue-600 transition-colors">
                    {{node.label}}
                </span>
            </ng-template>
        </p-tree>
    </ng-template>
  `,
  styles: [`
    /* Глубокая стилизация PrimeNG Tree для современного вида */
    :host ::ng-deep {
      .custom-tree .p-tree-container {
        padding: 0;
      }

      .custom-tree .p-treenode-content {
        padding: 0.6rem 0.5rem !important;
        border-radius: 0.75rem; /* Скругленные углы строк */
        margin-bottom: 2px;
        transition: all 0.2s ease;
        border: 1px solid transparent;
      }

      /* Ховер эффект */
      .custom-tree .p-treenode-content:hover {
        background-color: #F8FAFC !important; /* slate-50 */
        border-color: #E2E8F0;
      }

      /* Активный элемент */
      .custom-tree .p-treenode-content.p-highlight {
        background-color: #EFF6FF !important; /* blue-50 */
        border-color: #BFDBFE; /* blue-200 */
      }

      .custom-tree .p-treenode-content.p-highlight .p-tree-toggler {
        color: #2563EB !important;
      }

      .custom-tree .p-treenode-content.p-highlight .text-gray-600 {
        color: #1D4ED8 !important; /* blue-700 */
        font-weight: 700;
      }

      /* Иконка стрелочки */
      .p-tree-toggler {
        width: 1.5rem;
        height: 1.5rem;
        margin-right: 0.25rem;
        color: #94A3B8;
      }

      /* Поле фильтра внутри дерева */
      .p-tree-filter-container {
        margin-bottom: 1rem;
      }
      .p-tree-filter {
        width: 100%;
        padding: 0.5rem;
        border-radius: 0.5rem;
        border: 1px solid #E5E7EB;
        background: #F9FAFB;
        font-size: 0.875rem;
      }
      .p-tree-filter:focus {
        border-color: #3B82F6;
        outline: none;
        background: #FFFFFF;
      }
    }
  `]
})
export class MainLayoutComponent implements OnInit {
  private categoryService = inject(CategoryService);
  private router = inject(Router);

  categories: TreeNode[] = [];
  mobileSidebarVisible = false;

  ngOnInit() {
    this.loadCategories();
  }

  loadCategories() {
    this.categoryService.getTree().subscribe({
      next: (data) => this.categories = data,
      error: (err) => console.error('Ошибка загрузки категорий', err)
    });
  }

  onCategorySelect(event: any) {
    const categoryId = event.node.data;

    this.mobileSidebarVisible = false;

    this.router.navigate(['/catalog'], { queryParams: { category: categoryId } });
  }

  onSearch(query: string) {
    this.router.navigate(['/catalog'], { queryParams: { q: query } });
  }
}
</file>

<file path="autoparts-client/src/app/app.config.ts">
import 'zone.js';
import { ApplicationConfig, provideZoneChangeDetection } from '@angular/core';
import { provideRouter } from '@angular/router';
import { provideHttpClient, withInterceptors } from '@angular/common/http';
import { provideAnimations } from '@angular/platform-browser/animations';

import { MessageService } from 'primeng/api';

import { routes } from './app.routes';
import { authInterceptor } from './core/interceptors/auth.interceptor';

export const appConfig: ApplicationConfig = {
  providers: [
    provideZoneChangeDetection({ eventCoalescing: true }),
    provideRouter(routes),
    provideAnimations(),
    provideHttpClient(
      withInterceptors([authInterceptor])
    ),
    MessageService
  ]
};
</file>

<file path="autoparts-client/src/app/app.html">
<p-toast></p-toast>
<router-outlet></router-outlet>
</file>

<file path="autoparts-client/src/app/app.routes.ts">
import { Routes } from '@angular/router';
import { LoginComponent } from './features/auth/login/login.component';
import { RegisterComponent } from './features/auth/register/register.component';
import { MainLayoutComponent } from './layout/main-layout/main-layout.component';
import { CatalogComponent } from './features/catalog/catalog.component';
import { CartComponent } from './features/cart/cart.component';
import { ProfileComponent } from './features/profile/profile.component';
import { adminGuard } from './core/guards/admin.guard';
import { guestGuard } from './core/guards/guest.guard';
import { AdminLayoutComponent } from './features/admin/admin-layout/admin-layout.component';
import { AdminCategoriesComponent } from './features/admin/categories/admin-categories.component';
import { AdminProductsComponent } from './features/admin/products/admin-products.component';
import { AdminOrdersComponent } from './features/admin/orders/admin-orders.component';
import { LandingComponent } from './features/landing/landing.component';

export const routes: Routes = [
  {
    path: 'login',
    component: LoginComponent,
    title: 'Вход',
    canActivate: [guestGuard]
  },
  {
    path: 'register',
    component: RegisterComponent,
    title: 'Регистрация',
    canActivate: [guestGuard]
  },

  {
    path: 'admin',
    component: AdminLayoutComponent,
    canActivate: [adminGuard],
    children: [
      { path: 'orders', component: AdminOrdersComponent, title: 'Управление заказами' },
      { path: 'products', component: AdminProductsComponent, title: 'Управление товарами' },
      { path: 'categories', component: AdminCategoriesComponent, title: 'Управление категориями' },
      { path: '', redirectTo: 'orders', pathMatch: 'full' }
    ]
  },

  {
    path: 'profile',
    component: ProfileComponent,
    title: 'Мои заказы'
  },

  {
    path: 'cart',
    component: CartComponent,
    title: 'Корзина'
  },

  {
    path: '',
    component: MainLayoutComponent,
    children: [
      { path: '', component: LandingComponent, title: 'AutoParts - Главная' },
      { path: 'catalog', component: CatalogComponent, title: 'Каталог запчастей' }
    ]
  },

  { path: '**', redirectTo: '' }
];
</file>

<file path="autoparts-client/src/app/app.scss">

</file>

<file path="autoparts-client/src/app/app.spec.ts">
import { TestBed } from '@angular/core/testing';
import { App } from './app';

describe('App', () => {
  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [App],
    }).compileComponents();
  });

  it('should create the app', () => {
    const fixture = TestBed.createComponent(App);
    const app = fixture.componentInstance;
    expect(app).toBeTruthy();
  });

  it('should render title', async () => {
    const fixture = TestBed.createComponent(App);
    await fixture.whenStable();
    const compiled = fixture.nativeElement as HTMLElement;
    expect(compiled.querySelector('h1')?.textContent).toContain('Hello, autoparts-client');
  });
});
</file>

<file path="autoparts-client/src/app/app.ts">
import { Component, signal } from '@angular/core';
import { RouterOutlet } from '@angular/router';
import { ToastModule } from 'primeng/toast';


@Component({
  selector: 'app-root',
  imports: [RouterOutlet, ToastModule],
  standalone: true,
  templateUrl: './app.html',
  styleUrl: './app.scss'
})
export class App {
  protected readonly title = signal('autoparts-client');
}
</file>

<file path="autoparts-client/src/index.html">
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AutopartsClient</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="logo.svg">
</head>
<body>
  <app-root></app-root>
</body>
</html>
</file>

<file path="autoparts-client/src/main.ts">
import { bootstrapApplication } from '@angular/platform-browser';
import { appConfig } from './app/app.config';
import { App } from './app/app';

bootstrapApplication(App, appConfig)
  .catch((err) => console.error(err));
</file>

<file path="autoparts-client/src/styles.scss">
@import "primeng/resources/themes/aura-light-blue/theme.css";
@import "primeng/resources/primeng.css";
@import "primeicons/primeicons.css";

@tailwind base;
@tailwind components;
@tailwind utilities;

html, body {
    height: 100%;
    margin: 0;
    font-family: var(--font-family);
    background-color: #f8fafc;
}
</file>

<file path="autoparts-client/.editorconfig">
# Editor configuration, see https://editorconfig.org
root = true

[*]
charset = utf-8
indent_style = space
indent_size = 2
insert_final_newline = true
trim_trailing_whitespace = true

[*.ts]
quote_type = single
ij_typescript_use_double_quotes = false

[*.md]
max_line_length = off
trim_trailing_whitespace = false
</file>

<file path="autoparts-client/.gitignore">
# See https://docs.github.com/get-started/getting-started-with-git/ignoring-files for more about ignoring files.

# Compiled output
/dist
/tmp
/out-tsc
/bazel-out

# Node
/node_modules
npm-debug.log
yarn-error.log

# IDEs and editors
.idea/
.project
.classpath
.c9/
*.launch
.settings/
*.sublime-workspace

# Visual Studio Code
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
.history/*

# Miscellaneous
/.angular/cache
.sass-cache/
/connect.lock
/coverage
/libpeerconnection.log
testem.log
/typings
__screenshots__/

# System files
.DS_Store
Thumbs.db
</file>

<file path="autoparts-client/README.md">
# AutopartsClient

This project was generated using [Angular CLI](https://github.com/angular/angular-cli) version 21.0.4.

## Development server

To start a local development server, run:

```bash
ng serve
```

Once the server is running, open your browser and navigate to `http://localhost:4200/`. The application will automatically reload whenever you modify any of the source files.

## Code scaffolding

Angular CLI includes powerful code scaffolding tools. To generate a new component, run:

```bash
ng generate component component-name
```

For a complete list of available schematics (such as `components`, `directives`, or `pipes`), run:

```bash
ng generate --help
```

## Building

To build the project run:

```bash
ng build
```

This will compile your project and store the build artifacts in the `dist/` directory. By default, the production build optimizes your application for performance and speed.

## Running unit tests

To execute unit tests with the [Vitest](https://vitest.dev/) test runner, use the following command:

```bash
ng test
```

## Running end-to-end tests

For end-to-end (e2e) testing, run:

```bash
ng e2e
```

Angular CLI does not come with an end-to-end testing framework by default. You can choose one that suits your needs.

## Additional Resources

For more information on using the Angular CLI, including detailed command references, visit the [Angular CLI Overview and Command Reference](https://angular.dev/tools/cli) page.
</file>

<file path="autoparts-client/tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./src/**/*.{html,ts}"
  ],
  theme: {
    extend: {
      colors: {
        // Добавляем "primary" цвет, чтобы он совпадал с темой
        primary: {
          50: '#eff6ff',
          100: '#dbeafe',
          500: '#3b82f6', // Основной синий
          600: '#2563eb',
          700: '#1d4ed8',
        }
      },
      container: {
        center: true,
        padding: '1rem', // Отступы по бокам на мобильных
        screens: {
          sm: '640px',
          md: '768px',
          lg: '1024px',
          xl: '1280px', // Ограничим ширину контента на больших экранах
        },
      }
    },
  },
  plugins: [],
}
</file>

<file path="autoparts-store/.mvn/wrapper/maven-wrapper.properties">
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.12/apache-maven-3.9.12-bin.zip
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/config/ApplicationConfig.java">
package com.diploma.autoparts_store.config;

import com.diploma.autoparts_store.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

@Configuration
@RequiredArgsConstructor
public class ApplicationConfig {
    private final UserRepository userRepository;

    @Bean
    public UserDetailsService userDetailsService() {
        return username -> userRepository.findByPhone(username)
                .orElseThrow(() -> new UsernameNotFoundException("Пользователь не найден"));
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/config/DataInitializer.java">
package com.diploma.autoparts_store.config;

import com.diploma.autoparts_store.entity.Cart;
import com.diploma.autoparts_store.entity.Category;
import com.diploma.autoparts_store.entity.Product;
import com.diploma.autoparts_store.entity.Role;
import com.diploma.autoparts_store.entity.User;
import com.diploma.autoparts_store.repository.CartRepository;
import com.diploma.autoparts_store.repository.CategoryRepository;
import com.diploma.autoparts_store.repository.ProductRepository;
import com.diploma.autoparts_store.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.boot.CommandLineRunner;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Component;

import java.math.BigDecimal;
import java.util.List;

@Component
@RequiredArgsConstructor
public class DataInitializer implements CommandLineRunner {

    private final UserRepository userRepository;
    private final CategoryRepository categoryRepository;
    private final ProductRepository productRepository;
    private final CartRepository cartRepository;
    private final PasswordEncoder passwordEncoder;

    @Override
    public void run(String... args) throws Exception {
        // Проверяем, есть ли уже пользователи, чтобы не дублировать данные при перезапуске
        if (userRepository.count() == 0) {
            initUsers();
            initCategoriesAndProducts();
        }
    }

    private void initUsers() {
        // 1. Создаем Админа
        User admin = User.builder()
                .firstName("Admin")
                .lastName("Superuser")
                .phone("+70000000000") // Логин админа
                .password(passwordEncoder.encode("admin")) // Пароль админа
                .role(Role.ADMIN)
                .balance(new BigDecimal("0.00"))
                .build();

        userRepository.save(admin);
        cartRepository.save(Cart.builder().user(admin).build()); // Создаем корзину

        // 2. Создаем Клиента
        User client = User.builder()
                .firstName("Иван")
                .lastName("Клиентов")
                .phone("+77770000000") // Логин клиента
                .password(passwordEncoder.encode("password")) // Пароль клиента
                .role(Role.CLIENT)
                .balance(new BigDecimal("50000.00")) // Дадим ему денег на тест
                .build();

        userRepository.save(client);
        cartRepository.save(Cart.builder().user(client).build());

        System.out.println(">>> Users initialized: Admin (+70000000000 / admin), Client (+77770000000 / password)");
    }

    private void initCategoriesAndProducts() {
        // --- КАТЕГОРИИ ---

        // 1. ТО и Фильтры (Корневая)
        Category maintenance = new Category();
        maintenance.setName("ТО и Запчасти");
        categoryRepository.save(maintenance);

        Category oils = new Category();
        oils.setName("Масла и жидкости");
        oils.setParent(maintenance);
        categoryRepository.save(oils);

        Category filters = new Category();
        filters.setName("Фильтры");
        filters.setParent(maintenance);
        categoryRepository.save(filters);

        // 2. Тормозная система (Корневая)
        Category brakes = new Category();
        brakes.setName("Тормозная система");
        categoryRepository.save(brakes);

        Category pads = new Category();
        pads.setName("Колодки");
        pads.setParent(brakes);
        categoryRepository.save(pads);

        Category discs = new Category();
        discs.setName("Диски");
        discs.setParent(brakes);
        categoryRepository.save(discs);

        // 3. Электрика (Корневая)
        Category electrics = new Category();
        electrics.setName("Электрика");
        categoryRepository.save(electrics);

        // --- ТОВАРЫ ---

        List<Product> products = List.of(
                // Масла
                Product.builder()
                        .name("Моторное масло Shell Helix Ultra 5W-40 4л")
                        .sku("OIL-SHELL-5W40-4")
                        .description("Полностью синтетическое моторное масло для современных двигателей.")
                        .price(new BigDecimal("18500.00"))
                        .stockQuantity(50)
                        .category(oils)
                        .imageUrl("https://m.media-amazon.com/images/I/61+9w+1QouL._AC_SL1000_.jpg")
                        .build(),

                Product.builder()
                        .name("Моторное масло Motul 8100 X-cess 5W-40 5л")
                        .sku("OIL-MOTUL-5W40-5")
                        .description("Высококачественное синтетическое масло.")
                        .price(new BigDecimal("24000.00"))
                        .stockQuantity(30)
                        .category(oils)
                        .imageUrl("https://m.media-amazon.com/images/I/71wQ-+-gUoL._AC_SL1500_.jpg")
                        .build(),

                // Фильтры
                Product.builder()
                        .name("Масляный фильтр MANN-FILTER W 712/94")
                        .sku("FIL-MANN-W712")
                        .description("Оригинальный масляный фильтр для VAG группы.")
                        .price(new BigDecimal("4500.00"))
                        .stockQuantity(100)
                        .category(filters)
                        .imageUrl("https://m.media-amazon.com/images/I/71xQ+q+qUoL._AC_SL1500_.jpg")
                        .build(),

                Product.builder()
                        .name("Воздушный фильтр Bosch F 026 400 002")
                        .sku("FIL-BOSCH-AIR")
                        .description("Надежная защита двигателя от пыли.")
                        .price(new BigDecimal("3200.00"))
                        .stockQuantity(80)
                        .category(filters)
                        .imageUrl("https://m.media-amazon.com/images/I/61xQ+q+qUoL._AC_SL1500_.jpg") // Заглушка, если нет реальной
                        .build(),

                // Колодки
                Product.builder()
                        .name("Тормозные колодки Brembo передние")
                        .sku("BRK-BREMBO-FR")
                        .description("Премиальные тормозные колодки. Высокая эффективность торможения.")
                        .price(new BigDecimal("12000.00"))
                        .stockQuantity(20)
                        .category(pads)
                        .imageUrl("https://m.media-amazon.com/images/I/71xQ+q+qUoL._AC_SL1500_.jpg")
                        .build(),

                Product.builder()
                        .name("Тормозные диски TRW задние (комплект)")
                        .sku("BRK-TRW-RR")
                        .description("Вентилируемые тормозные диски.")
                        .price(new BigDecimal("28000.00"))
                        .stockQuantity(10)
                        .category(discs)
                        .imageUrl("https://m.media-amazon.com/images/I/61xQ+q+qUoL._AC_SL1500_.jpg")
                        .build(),

                // Электрика (Аккумулятор)
                Product.builder()
                        .name("Аккумулятор VARTA Blue Dynamic D24 60 Ач")
                        .sku("BAT-VARTA-60")
                        .description("Надежный аккумулятор для любых погодных условий.")
                        .price(new BigDecimal("45000.00"))
                        .stockQuantity(5)
                        .category(electrics)
                        .imageUrl("https://m.media-amazon.com/images/I/71xQ+q+qUoL._AC_SL1500_.jpg")
                        .build()
        );

        productRepository.saveAll(products);
        System.out.println(">>> Categories and Products initialized!");
    }
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/config/SecurityConfig.java">
package com.diploma.autoparts_store.config;

import com.diploma.autoparts_store.security.AuthEntryPointJwt;
import com.diploma.autoparts_store.security.JwtAuthenticationFilter;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.List;

@Configuration
@EnableWebSecurity
@EnableMethodSecurity
@RequiredArgsConstructor
public class SecurityConfig {
    private final PasswordEncoder passwordEncoder;
    private final UserDetailsService userDetailsService;
    private final JwtAuthenticationFilter jwtFilter;
    private final AuthEntryPointJwt unauthorizedHandler;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
                .csrf(AbstractHttpConfigurer::disable)
                .cors(cors -> cors.configurationSource(corsConfigurationSource()))
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/auth/**").permitAll()
                        .requestMatchers(HttpMethod.GET, "/api/v1/products/**").permitAll()
                        .requestMatchers(HttpMethod.GET, "/api/v1/categories/**").permitAll()
                        .requestMatchers("/v3/api-docs/**", "/swagger-ui/**").permitAll()
                        .requestMatchers("/auth/me").authenticated()
                        .anyRequest().authenticated()
                )
                .sessionManagement(session -> session
                        .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
                )
                .authenticationProvider(authenticationProvider())
                .addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class)
                .exceptionHandling(exception -> exception
                        .authenticationEntryPoint(unauthorizedHandler));

        return http.build();
    }

    @Bean
    public DaoAuthenticationProvider authenticationProvider() {
        DaoAuthenticationProvider provider = new DaoAuthenticationProvider(userDetailsService);
        provider.setPasswordEncoder(passwordEncoder);
        return provider;
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration configuration) throws Exception {
        return configuration.getAuthenticationManager();
    }

    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration corsConfiguration = new CorsConfiguration();
        corsConfiguration.setAllowedOrigins(List.of("http://localhost:4200", "http://localhost:3000"));
        corsConfiguration.setAllowedMethods(List.of("GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"));
        corsConfiguration.setAllowedHeaders(List.of("Authorization", "Content-Type"));
        corsConfiguration.setAllowCredentials(true);

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", corsConfiguration);

        return source;
    }
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/controller/AuthController.java">
package com.diploma.autoparts_store.controller;

import com.diploma.autoparts_store.dto.AuthRequest;
import com.diploma.autoparts_store.dto.AuthResponse;
import com.diploma.autoparts_store.dto.RegisterRequest;
import com.diploma.autoparts_store.dto.UserResponse;
import com.diploma.autoparts_store.service.AuthenticationService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.security.Principal;

@RestController
@RequestMapping("/auth")
@RequiredArgsConstructor
public class AuthController {
    private final AuthenticationService service;

    @PostMapping("/register")
    public ResponseEntity<AuthResponse> register(@RequestBody RegisterRequest request) {
        return ResponseEntity.ok(service.register(request));
    }

    @PostMapping("/login")
    public ResponseEntity<AuthResponse> authenticate(@RequestBody AuthRequest request) {
        return ResponseEntity.ok(service.authenticate(request));
    }

    @GetMapping("/me")
    public ResponseEntity<UserResponse> getProfile(Principal principal) {
        return ResponseEntity.ok(service.getProfile(principal.getName()));
    }
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/controller/CartController.java">
package com.diploma.autoparts_store.controller;

import com.diploma.autoparts_store.dto.AddToCartRequest;
import com.diploma.autoparts_store.dto.CartDto;
import com.diploma.autoparts_store.service.CartService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.security.Principal;

@RestController
@RequestMapping("/api/v1/cart")
@RequiredArgsConstructor
public class CartController {
    private final CartService cartService;

    @GetMapping
    public CartDto getCart(Principal principal) {
        return cartService.getCart(principal.getName());
    }

    @PostMapping("/items")
    public CartDto addToCart(Principal principal, @RequestBody AddToCartRequest request) {
        return cartService.addToCart(principal.getName(), request);
    }

    @DeleteMapping("/items/{itemId}")
    public CartDto removeItem(Principal principal, @PathVariable Long itemId) {
        return cartService.removeFromCart(principal.getName(), itemId);
    }

    @DeleteMapping
    public void clearCart(Principal principal) {
        cartService.clearCart(principal.getName());
    }
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/controller/CategoryController.java">
package com.diploma.autoparts_store.controller;

import com.diploma.autoparts_store.dto.CategoryDto;
import com.diploma.autoparts_store.service.CategoryService;
import lombok.RequiredArgsConstructor;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/v1/categories")
@RequiredArgsConstructor
public class CategoryController {
    private final CategoryService categoryService;

    @GetMapping
    public List<CategoryDto> getTree() {
        return categoryService.getAllCategoriesTree();
    }

    @PostMapping
    @PreAuthorize("hasAuthority('ADMIN')")
    public void create(@RequestParam String name, @RequestParam(required = false) Long parentId) {
        categoryService.createCategory(name, parentId);
    }

    @PutMapping("/{id}")
    @PreAuthorize("hasAuthority('ADMIN')")
    public void update(@PathVariable Long id,
                       @RequestParam String name,
                       @RequestParam(required = false) Long parentId) {
        categoryService.updateCategory(id, name, parentId);
    }

    @DeleteMapping("/{id}")
    @PreAuthorize("hasAuthority('ADMIN')")
    public void delete(@PathVariable Long id) {
        categoryService.deleteCategory(id);
    }
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/controller/OrderController.java">
package com.diploma.autoparts_store.controller;

import com.diploma.autoparts_store.dto.OrderDto;
import com.diploma.autoparts_store.entity.Role;
import com.diploma.autoparts_store.entity.User;
import com.diploma.autoparts_store.repository.UserRepository;
import com.diploma.autoparts_store.service.OrderService;
import lombok.RequiredArgsConstructor;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.security.Principal;
import java.util.List;

@RestController
@RequestMapping("/api/v1/orders")
@RequiredArgsConstructor
public class OrderController {
    private final OrderService orderService;
    private final UserRepository userRepository;

    @PostMapping
    public OrderDto createOrder(Principal principal) {
        return orderService.createOrder(principal.getName());
    }

    @GetMapping
    public List<OrderDto> getOrders(Principal principal) {
        User user = userRepository.findByPhone(principal.getName()).orElseThrow();

        if (user.getRole() == Role.ADMIN) {
            return orderService.getAllOrders();
        } else {
            return orderService.getUserOrders(principal.getName());
        }
    }

    @PatchMapping("/{id}/status")
    @PreAuthorize("hasAuthority('ADMIN')")
    public void updateStatus(@PathVariable Long id, @RequestParam String status) {
        orderService.updateStatus(id, status);
    }
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/controller/ProductController.java">
package com.diploma.autoparts_store.controller;

import com.diploma.autoparts_store.dto.CreateProductRequest;
import com.diploma.autoparts_store.dto.ProductDto;
import com.diploma.autoparts_store.service.ProductService;
import lombok.RequiredArgsConstructor;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/v1/products")
@RequiredArgsConstructor
public class ProductController {
    private final ProductService productService;

    @GetMapping
    public List<ProductDto> getAll(
            @RequestParam(required = false) Long categoryId,
            @RequestParam(required = false) String query
    ) {
        return productService.getProducts(categoryId, query);
    }

    @PostMapping
    @PreAuthorize("hasAuthority('ADMIN')")
    public ProductDto create(@RequestBody CreateProductRequest request) {
        return productService.createProduct(request);
    }

    @PutMapping("/{id}")
    @PreAuthorize("hasAuthority('ADMIN')")
    public ProductDto update(@PathVariable Long id, @RequestBody CreateProductRequest request) {
        return productService.updateProduct(id, request);
    }

    @DeleteMapping("/{id}")
    @PreAuthorize("hasAuthority('ADMIN')")
    public void delete(@PathVariable Long id) {
        productService.deleteProduct(id);
    }
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/dto/AddToCartRequest.java">
package com.diploma.autoparts_store.dto;

public record AddToCartRequest(
        Long productId,
        Integer quantity
) {}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/dto/AuthRequest.java">
package com.diploma.autoparts_store.dto;

public record AuthRequest(String phone, String password) {
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/dto/AuthResponse.java">
package com.diploma.autoparts_store.dto;

public record AuthResponse(String token) {
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/dto/CartDto.java">
package com.diploma.autoparts_store.dto;

import java.math.BigDecimal;
import java.util.List;

public record CartDto(
        List<CartItemDto> items,
        BigDecimal totalPrice
) {}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/dto/CartItemDto.java">
package com.diploma.autoparts_store.dto;

import java.math.BigDecimal;

public record CartItemDto(
        Long id,
        Long productId,
        String sku,
        String name,
        String imageUrl,
        Integer quantity,
        BigDecimal price,
        BigDecimal sum
) {}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/dto/CategoryDto.java">
package com.diploma.autoparts_store.dto;

import java.util.List;

public record CategoryDto(
        Long id,
        String name,
        Long parentId,
        List<CategoryDto> children
) {}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/dto/CreateProductRequest.java">
package com.diploma.autoparts_store.dto;

import java.math.BigDecimal;

public record CreateProductRequest(
        String sku,
        String name,
        String description,
        BigDecimal price,
        Integer stockQuantity,
        String imageUrl,
        Long categoryId
) {}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/dto/OrderDto.java">
package com.diploma.autoparts_store.dto;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;

public record OrderDto(
        Long id,
        String status,
        BigDecimal totalPrice,
        LocalDateTime createdAt,
        List<CartItemDto> items,
        String contactPhone
) {}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/dto/ProductDto.java">
package com.diploma.autoparts_store.dto;

import java.math.BigDecimal;

public record ProductDto(
        Long id,
        String sku,
        String name,
        String description,
        BigDecimal price,
        Integer stockQuantity,
        String imageUrl,
        String categoryName,
        Long categoryId
) {}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/dto/RegisterRequest.java">
package com.diploma.autoparts_store.dto;


public record RegisterRequest(String phone, String password, String firstName, String lastName) {
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/dto/UserResponse.java">
package com.diploma.autoparts_store.dto;

import java.math.BigDecimal;

public record UserResponse(
        Long id,
        String phone,
        String firstName,
        String lastName,
        String role,
        BigDecimal balance
) {}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/entity/Cart.java">
package com.diploma.autoparts_store.entity;

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.ArrayList;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "carts")
public class Cart {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @OneToOne
    @JoinColumn(name = "user_id", referencedColumnName = "id", nullable = false)
    private User user;

    @OneToMany(mappedBy = "cart", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<CartItem> items = new ArrayList<>();
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/entity/CartItem.java">
package com.diploma.autoparts_store.entity;

import jakarta.persistence.*;
import lombok.*;

@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "cart_items")
public class CartItem {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "cart_id", nullable = false)
    private Cart cart;

    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = "product_id", nullable = false)
    private Product product;

    @Column(nullable = false)
    private Integer quantity;
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/entity/Category.java">
package com.diploma.autoparts_store.entity;

import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;

import java.util.ArrayList;
import java.util.List;

@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "categories")
public class Category {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false)
    private String name;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "parent_id")
    @JsonIgnore
    private Category parent;

    @OneToMany(mappedBy = "parent", cascade = CascadeType.ALL)
    private List<Category> children = new ArrayList<>();
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/entity/Order.java">
package com.diploma.autoparts_store.entity;

import jakarta.persistence.*;
import lombok.*;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "orders")
public class Order {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    private User user;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private OrderStatus status;

    @Column(nullable = false)
    private BigDecimal totalPrice;

    private String contactPhone;
    private String address;

    @Builder.Default
    private LocalDateTime createdAt = LocalDateTime.now();

    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL)
    private List<OrderItem> items = new ArrayList<>();
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/entity/OrderItem.java">
package com.diploma.autoparts_store.entity;

import jakarta.persistence.*;
import lombok.*;

import java.math.BigDecimal;

@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "order_items")
public class OrderItem {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "order_id", nullable = false)
    private Order order;

    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = "product_id")
    private Product product;

    @Column(nullable = false)
    private Integer quantity;

    @Column(nullable = false)
    private BigDecimal priceAtPurchase;
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/entity/OrderStatus.java">
package com.diploma.autoparts_store.entity;

public enum OrderStatus {
    CREATED,    // Создан
    CONFIRMED,  // Подтвержден менеджером
    PAID,       // Оплачен
    SHIPPED,    // Отправлен
    COMPLETED,  // Завершен (выдан)
    CANCELLED   // Отменен
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/entity/Product.java">
package com.diploma.autoparts_store.entity;

import jakarta.persistence.*;
import lombok.*;

import java.math.BigDecimal;

@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "products")
public class Product {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, unique = true)
    private String sku; // Артикул

    @Column(nullable = false)
    private String name;

    @Column(columnDefinition = "TEXT")
    private String description;

    @Column(nullable = false)
    private BigDecimal price;

    @Column(nullable = false)
    private Integer stockQuantity;

    private String imageUrl;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "category_id")
    private Category category;
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/entity/Role.java">
package com.diploma.autoparts_store.entity;

public enum Role {
    CLIENT,
    ADMIN
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/entity/User.java">
package com.diploma.autoparts_store.entity;

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import java.math.BigDecimal;
import java.util.Collection;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "users")
public class User implements UserDetails {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(unique = true, nullable = false)
    private String phone;

    @Column(nullable = false)
    private String password;

    private String firstName;
    private String lastName;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private Role role;

    private BigDecimal balance;

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return List.of(new SimpleGrantedAuthority(role.name()));
    }

    @Override
    public String getUsername() {
        return phone;
    }

    @Override
    public boolean isAccountNonExpired() {
        return true;
    }

    @Override
    public boolean isAccountNonLocked() {
        return true;
    }

    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }

    @Override
    public boolean isEnabled() {
        return true;
    }
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/repository/CartRepository.java">
package com.diploma.autoparts_store.repository;

import com.diploma.autoparts_store.entity.Cart;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

public interface CartRepository extends JpaRepository<Cart, Long> {
    Optional<Cart> findByUserId(Long userId);
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/repository/CategoryRepository.java">
package com.diploma.autoparts_store.repository;

import com.diploma.autoparts_store.entity.Category;
import org.springframework.data.jpa.repository.JpaRepository;
import java.util.List;

public interface CategoryRepository extends JpaRepository<Category, Long> {
    List<Category> findByParentIsNull();
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/repository/OrderRepository.java">
package com.diploma.autoparts_store.repository;

import com.diploma.autoparts_store.entity.Order;
import org.springframework.data.jpa.repository.JpaRepository;
import java.util.List;

public interface OrderRepository extends JpaRepository<Order, Long> {
    List<Order> findByUserId(Long userId);
    List<Order> findAllByOrderByCreatedAtDesc();
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/repository/ProductRepository.java">
package com.diploma.autoparts_store.repository;

import com.diploma.autoparts_store.entity.Product;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import java.util.List;

public interface ProductRepository extends JpaRepository<Product, Long> {
    List<Product> findByCategoryId(Long categoryId);

    List<Product> findByNameContainingIgnoreCaseOrSkuContainingIgnoreCase(String name, String sku);

    @Query("SELECT p FROM Product p WHERE " +
            "(:categoryId IS NULL OR p.category.id = :categoryId) AND " +
            "(:query IS NULL OR LOWER(p.name) LIKE :query OR LOWER(p.sku) LIKE :query)")
    List<Product> searchProducts(@Param("categoryId") Long categoryId, @Param("query") String query);
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/repository/UserRepository.java">
package com.diploma.autoparts_store.repository;

import com.diploma.autoparts_store.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByPhone(String phone);
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/security/AuthEntryPointJwt.java">
package com.diploma.autoparts_store.security;

import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.AuthenticationEntryPoint;
import org.springframework.stereotype.Component;

import java.io.IOException;

@Component
public class AuthEntryPointJwt implements AuthenticationEntryPoint {
    @Override
    public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException)
            throws IOException, ServletException {
        response.sendError(HttpServletResponse.SC_UNAUTHORIZED, "Error: Unauthorized");
    }
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/security/JwtAuthenticationFilter.java">
package com.diploma.autoparts_store.security;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.lang.NonNull;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;

@Component
@RequiredArgsConstructor
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    private final JwtService jwtService;
    private final UserDetailsService userDetailsService;

    @Override
    protected void doFilterInternal(
            @NonNull HttpServletRequest request,
            @NonNull HttpServletResponse response,
            @NonNull FilterChain filterChain
    ) throws ServletException, IOException {
        final String authHeader = request.getHeader("Authorization");
        final String jwt;
        final String userPhone;

        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            filterChain.doFilter(request, response);
            return;
        }

        jwt = authHeader.substring(7);
        userPhone = jwtService.extractUsername(jwt);

        if (userPhone != null && SecurityContextHolder.getContext().getAuthentication() == null) {
            UserDetails userDetails = this.userDetailsService.loadUserByUsername(userPhone);
            if (jwtService.isTokenValid(jwt, userDetails)) {
                UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                        userDetails,
                        null,
                        userDetails.getAuthorities()
                );
                authToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                SecurityContextHolder.getContext().setAuthentication(authToken);
            }
        }
        filterChain.doFilter(request, response);
    }
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/security/JwtService.java">
package com.diploma.autoparts_store.security;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.io.Decoders;
import io.jsonwebtoken.security.Keys;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Service;

import java.security.Key;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.function.Function;

@Service
public class JwtService {
    private static final String SECRET_KEY = "404E635266556A586E3272357538782F413F4428472B4B6250645367566B5970";

    public String extractUsername(String token) {
        return extractClaim(token, Claims::getSubject);
    }

    public <T> T extractClaim(String token, Function<Claims, T> claimsResolver) {
        final Claims claims = extractAllClaims(token);
        return claimsResolver.apply(claims);
    }

    public String generateToken(UserDetails userDetails) {
        return generateToken(new HashMap<>(), userDetails);
    }

    public String generateToken(Map<String, Object> extraClaims, UserDetails userDetails) {
        return Jwts.builder()
                .setClaims(extraClaims)
                .setSubject(userDetails.getUsername())
                .setIssuedAt(new Date(System.currentTimeMillis()))
                .setExpiration(new Date(System.currentTimeMillis() + 1000 * 60 * 60 * 72))
                .signWith(getSignInKey(), SignatureAlgorithm.HS256)
                .compact();
    }

    public boolean isTokenValid(String token, UserDetails userDetails) {
        final String username = extractUsername(token);
        return (username.equals(userDetails.getUsername())) && !isTokenExpired(token);
    }

    private boolean isTokenExpired(String token) {
        return extractExpiration(token).before(new Date());
    }

    private Date extractExpiration(String token) {
        return extractClaim(token, Claims::getExpiration);
    }

    private Claims extractAllClaims(String token) {
        return Jwts.parserBuilder()
                .setSigningKey(getSignInKey())
                .build()
                .parseClaimsJws(token)
                .getBody();
    }

    private Key getSignInKey() {
        byte[] keyBytes = Decoders.BASE64.decode(SECRET_KEY);
        return Keys.hmacShaKeyFor(keyBytes);
    }
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/service/AuthenticationService.java">
package com.diploma.autoparts_store.service;

import com.diploma.autoparts_store.dto.AuthRequest;
import com.diploma.autoparts_store.dto.AuthResponse;
import com.diploma.autoparts_store.dto.RegisterRequest;
import com.diploma.autoparts_store.dto.UserResponse;
import com.diploma.autoparts_store.entity.Cart;
import com.diploma.autoparts_store.entity.Role;
import com.diploma.autoparts_store.entity.User;
import com.diploma.autoparts_store.repository.CartRepository;
import com.diploma.autoparts_store.repository.UserRepository;
import com.diploma.autoparts_store.security.JwtService;
import lombok.RequiredArgsConstructor;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.util.HashMap;
import java.util.Map;

@Service
@RequiredArgsConstructor
public class AuthenticationService {
    private final UserRepository userRepository;
    private final CartRepository cartRepository;
    private final PasswordEncoder passwordEncoder;
    private final JwtService jwtService;
    private final AuthenticationManager authenticationManager;

    public AuthResponse register(RegisterRequest request) {
        var user = User.builder()
                .firstName(request.firstName())
                .lastName(request.lastName())
                .phone(request.phone())
                .password(passwordEncoder.encode(request.password()))
                .role(Role.CLIENT)
                .balance(BigDecimal.ZERO)
                .build();

        User savedUser = userRepository.save(user);

        var cart = Cart.builder()
                .user(savedUser)
                .build();
        cartRepository.save(cart);

        Map<String, Object> extraClaims = new HashMap<>();
        extraClaims.put("role", user.getRole().name());

        var jwtToken = jwtService.generateToken(extraClaims, user);
        return new AuthResponse(jwtToken);
    }

    public AuthResponse authenticate(AuthRequest request) {
        authenticationManager.authenticate(
                new UsernamePasswordAuthenticationToken(request.phone(), request.password())
        );
        var user = userRepository.findByPhone(request.phone())
                .orElseThrow();

        Map<String, Object> extraClaims = new HashMap<>();
        extraClaims.put("role", user.getRole().name());

        var jwtToken = jwtService.generateToken(extraClaims, user);
        return new AuthResponse(jwtToken);
    }

    public UserResponse getProfile(String phone) {
        var user = userRepository.findByPhone(phone)
                .orElseThrow(() -> new RuntimeException("User not found"));

        return new UserResponse(
                user.getId(),
                user.getPhone(),
                user.getFirstName(),
                user.getLastName(),
                user.getRole().name(),
                user.getBalance()
        );
    }
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/service/CartService.java">
package com.diploma.autoparts_store.service;

import com.diploma.autoparts_store.dto.AddToCartRequest;
import com.diploma.autoparts_store.dto.CartDto;
import com.diploma.autoparts_store.dto.CartItemDto;
import com.diploma.autoparts_store.entity.Cart;
import com.diploma.autoparts_store.entity.CartItem;
import com.diploma.autoparts_store.entity.Product;
import com.diploma.autoparts_store.entity.User;
import com.diploma.autoparts_store.repository.CartRepository;
import com.diploma.autoparts_store.repository.ProductRepository;
import com.diploma.autoparts_store.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.Optional;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class CartService {
    private final CartRepository cartRepository;
    private final ProductRepository productRepository;
    private final UserRepository userRepository;

    @Transactional
    public CartDto getCart(String userPhone) {
        Cart cart = getCartEntity(userPhone);
        return mapToDto(cart);
    }

    @Transactional
    public CartDto addToCart(String userPhone, AddToCartRequest request) {
        Cart cart = getCartEntity(userPhone);

        Product product = productRepository.findById(request.productId())
                .orElseThrow(() -> new RuntimeException("Товар не найден"));

        Optional<CartItem> existingItem = cart.getItems().stream()
                .filter(item -> item.getProduct().getId().equals(product.getId()))
                .findFirst();

        if (existingItem.isPresent()) {
            CartItem item = existingItem.get();
            item.setQuantity(item.getQuantity() + request.quantity());
        } else {
            CartItem newItem = CartItem.builder()
                    .cart(cart)
                    .product(product)
                    .quantity(request.quantity())
                    .build();
            cart.getItems().add(newItem);
        }

        cartRepository.save(cart);
        return mapToDto(cart);
    }

    @Transactional
    public CartDto removeFromCart(String userPhone, Long cartItemId) {
        Cart cart = getCartEntity(userPhone);

        cart.getItems().removeIf(item -> item.getId().equals(cartItemId));

        cartRepository.save(cart);
        return mapToDto(cart);
    }

    @Transactional
    public void clearCart(String userPhone) {
        Cart cart = getCartEntity(userPhone);
        cart.getItems().clear();
        cartRepository.save(cart);
    }

    private Cart getCartEntity(String phone) {
        User user = userRepository.findByPhone(phone)
                .orElseThrow(() -> new UsernameNotFoundException("Пользователь не найден"));

        return cartRepository.findByUserId(user.getId())
                .orElseThrow(() -> new RuntimeException("Корзина пользователя не найдена" + phone));
    }

    private CartDto mapToDto(Cart cart) {
        BigDecimal totalPrice = BigDecimal.ZERO;

        var itemsDto = cart.getItems().stream().map(item -> {
            BigDecimal sum = item.getProduct().getPrice().multiply(BigDecimal.valueOf(item.getQuantity()));
            return new CartItemDto(
                    item.getId(),
                    item.getProduct().getId(),
                    item.getProduct().getSku(),
                    item.getProduct().getName(),
                    item.getProduct().getImageUrl(),
                    item.getQuantity(),
                    item.getProduct().getPrice(),
                    sum
            );
        }).collect(Collectors.toList());

        for (CartItemDto item : itemsDto) {
            totalPrice = totalPrice.add(item.sum());
        }

        return new CartDto(itemsDto, totalPrice);
    }
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/service/CategoryService.java">
package com.diploma.autoparts_store.service;

import com.diploma.autoparts_store.dto.CategoryDto;
import com.diploma.autoparts_store.entity.Category;
import com.diploma.autoparts_store.repository.CategoryRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class CategoryService {
    private final CategoryRepository categoryRepository;

    @Transactional(readOnly = true)
    public List<CategoryDto> getAllCategoriesTree() {
        List<Category> roots = categoryRepository.findByParentIsNull();
        return roots.stream()
                .map(this::mapToDto)
                .collect(Collectors.toList());
    }

    private CategoryDto mapToDto(Category category) {
        List<CategoryDto> childrenDto = category.getChildren().stream()
                .map(this::mapToDto)
                .collect(Collectors.toList());

        return new CategoryDto(
                category.getId(),
                category.getName(),
                category.getParent() != null ? category.getParent().getId() : null,
                childrenDto
        );
    }

    @Transactional
    public void createCategory(String name, Long parentId) {
        Category category = new Category();
        category.setName(name);

        if (parentId != null) {
            Category parent = categoryRepository.findById(parentId)
                    .orElseThrow(() -> new RuntimeException("Родительская категория не найдена"));
            category.setParent(parent);
        }

        categoryRepository.save(category);
    }

    @Transactional
    public void updateCategory(Long id, String name, Long parentId) {
        Category category = categoryRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("Категория не найдена"));

        category.setName(name);

        if (parentId != null) {
            if (parentId.equals(id)) {
                throw new RuntimeException("Категория не может быть своим родителем");
            }
            Category parent = categoryRepository.findById(parentId)
                    .orElseThrow(() -> new RuntimeException("Родительская категория не найдена"));
            category.setParent(parent);
        } else {
            category.setParent(null);
        }

        categoryRepository.save(category);
    }

    @Transactional
    public void deleteCategory(Long id) {
        if (!categoryRepository.existsById(id)) {
            throw new RuntimeException("Категория не найдена");
        }
        categoryRepository.deleteById(id);
    }
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/service/OrderService.java">
package com.diploma.autoparts_store.service;

import com.diploma.autoparts_store.dto.CartItemDto;
import com.diploma.autoparts_store.dto.OrderDto;
import com.diploma.autoparts_store.entity.*;
import com.diploma.autoparts_store.repository.*;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class OrderService {
    private final OrderRepository orderRepository;
    private final CartRepository cartRepository;
    private final UserRepository userRepository;
    private final ProductRepository productRepository;

    @Transactional
    public OrderDto createOrder(String userPhone) {
        User user = userRepository.findByPhone(userPhone)
                .orElseThrow(() -> new UsernameNotFoundException("Пользователь не найден"));

        Cart cart = cartRepository.findByUserId(user.getId())
                .orElseThrow(() -> new RuntimeException("Корзина не найдена"));

        if (cart.getItems().isEmpty()) {
            throw new RuntimeException("Корзина пуста! Нельзя оформить заказ.");
        }

        Order order = Order.builder()
                .user(user)
                .status(OrderStatus.CREATED)
                .contactPhone(user.getPhone())
                .build();

        List<OrderItem> orderItems = new java.util.ArrayList<>();
        BigDecimal totalAmount = BigDecimal.ZERO;

        for (CartItem cartItem : cart.getItems()) {
            Product product = cartItem.getProduct();

            if (product.getStockQuantity() < cartItem.getQuantity()) {
                throw new RuntimeException("Товара " + product.getName() + " недостаточно на складе. Доступно: " + product.getStockQuantity());
            }

            product.setStockQuantity(product.getStockQuantity() - cartItem.getQuantity());
            productRepository.save(product);

            OrderItem orderItem = OrderItem.builder()
                    .order(order)
                    .product(product)
                    .quantity(cartItem.getQuantity())
                    .priceAtPurchase(product.getPrice())
                    .build();

            orderItems.add(orderItem);

            totalAmount = totalAmount.add(product.getPrice().multiply(BigDecimal.valueOf(cartItem.getQuantity())));
        }

        order.setItems(orderItems);
        order.setTotalPrice(totalAmount);

        Order savedOrder = orderRepository.save(order);

        cart.getItems().clear();
        cartRepository.save(cart);

        return mapToDto(savedOrder);
    }

    @Transactional(readOnly = true)
    public List<OrderDto> getUserOrders(String userPhone) {
        User user = userRepository.findByPhone(userPhone).orElseThrow();
        return orderRepository.findByUserId(user.getId()).stream()
                .map(this::mapToDto)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public List<OrderDto> getAllOrders() {
        return orderRepository.findAllByOrderByCreatedAtDesc().stream()
                .map(this::mapToDto)
                .collect(Collectors.toList());
    }

    @Transactional
    public void updateStatus(Long orderId, String statusName) {
        Order order = orderRepository.findById(orderId)
                .orElseThrow(() -> new RuntimeException("Заказ не найден"));

        try {
            OrderStatus newStatus = OrderStatus.valueOf(statusName.toUpperCase());
            order.setStatus(newStatus);
            orderRepository.save(order);
        } catch (IllegalArgumentException e) {
            throw new RuntimeException("Неверный статус заказа");
        }
    }

    private OrderDto mapToDto(Order order) {
        List<CartItemDto> itemsDto = order.getItems().stream()
                .map(item -> new CartItemDto(
                        item.getId(),
                        item.getProduct() != null ? item.getProduct().getId() : null,
                        item.getProduct() != null ? item.getProduct().getSku() : "DELETED",
                        item.getProduct() != null ? item.getProduct().getName() : "Товар удален",
                        item.getProduct() != null ? item.getProduct().getImageUrl() : null,
                        item.getQuantity(),
                        item.getPriceAtPurchase(), // Цена из истории!
                        item.getPriceAtPurchase().multiply(BigDecimal.valueOf(item.getQuantity()))
                ))
                .collect(Collectors.toList());

        return new OrderDto(
                order.getId(),
                order.getStatus().name(),
                order.getTotalPrice(),
                order.getCreatedAt(),
                itemsDto,
                order.getContactPhone()
        );
    }
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/service/ProductService.java">
package com.diploma.autoparts_store.service;

import com.diploma.autoparts_store.dto.CreateProductRequest;
import com.diploma.autoparts_store.dto.ProductDto;
import com.diploma.autoparts_store.entity.Category;
import com.diploma.autoparts_store.entity.Product;
import com.diploma.autoparts_store.repository.CategoryRepository;
import com.diploma.autoparts_store.repository.ProductRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class ProductService {
    private final ProductRepository productRepository;
    private final CategoryRepository categoryRepository;

    @Transactional(readOnly = true)
    public List<ProductDto> getProducts(Long categoryId, String query) {
        String searchQuery = null;

        if (query != null && !query.isBlank()) {
            searchQuery = "%" + query.toLowerCase() + "%";
        }

        List<Product> products = productRepository.searchProducts(categoryId, searchQuery);

        return products.stream()
                .map(this::mapToDto)
                .collect(Collectors.toList());
    }

    @Transactional
    public ProductDto createProduct(CreateProductRequest request) {
        Category category = null;
        if (request.categoryId() != null) {
            category = categoryRepository.findById(request.categoryId())
                    .orElseThrow(() -> new RuntimeException("Category not found"));
        }

        Product product = Product.builder()
                .sku(request.sku())
                .name(request.name())
                .description(request.description())
                .price(request.price())
                .stockQuantity(request.stockQuantity())
                .imageUrl(request.imageUrl())
                .category(category)
                .build();

        Product saved = productRepository.save(product);
        return mapToDto(saved);
    }

    @Transactional
    public ProductDto updateProduct(Long id, CreateProductRequest request) {
        Product product = productRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("Товар не найден"));

        if (request.categoryId() != null) {
            Category category = categoryRepository.findById(request.categoryId())
                    .orElseThrow(() -> new RuntimeException("Категория не найдена"));
            product.setCategory(category);
        }

        product.setSku(request.sku());
        product.setName(request.name());
        product.setDescription(request.description());
        product.setPrice(request.price());
        product.setStockQuantity(request.stockQuantity());
        product.setImageUrl(request.imageUrl());

        return mapToDto(productRepository.save(product));
    }

    @Transactional
    public void deleteProduct(Long id) {
        if (!productRepository.existsById(id)) {
            throw new RuntimeException("Товар не найден");
        }
        productRepository.deleteById(id);
    }

    private ProductDto mapToDto(Product p) {
        return new ProductDto(
                p.getId(),
                p.getSku(),
                p.getName(),
                p.getDescription(),
                p.getPrice(),
                p.getStockQuantity(),
                p.getImageUrl(),
                p.getCategory() != null ? p.getCategory().getName() : null,
                p.getCategory() != null ? p.getCategory().getId() : null
        );
    }
}
</file>

<file path="autoparts-store/src/main/java/com/diploma/autoparts_store/AutopartsStoreApplication.java">
package com.diploma.autoparts_store;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class AutopartsStoreApplication {
	public static void main(String[] args) {
		SpringApplication.run(AutopartsStoreApplication.class, args);
	}
}
</file>

<file path="autoparts-store/src/main/resources/db/migration/V1__init_schema.sql">
-- 1. Таблица Пользователей
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    phone VARCHAR(20) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    role VARCHAR(20) NOT NULL,
    balance DECIMAL(19, 2) DEFAULT 0.00
);

-- 2. Таблица Категорий
CREATE TABLE categories (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    parent_id BIGINT REFERENCES categories(id) ON DELETE SET NULL
);

-- 3. Таблица Товаров
CREATE TABLE products (
    id BIGSERIAL PRIMARY KEY,
    category_id BIGINT REFERENCES categories(id),
    sku VARCHAR(100) NOT NULL UNIQUE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(19, 2) NOT NULL,
    stock_quantity INTEGER NOT NULL DEFAULT 0,
    image_url VARCHAR(512)
);

-- Индексы
CREATE INDEX idx_products_sku ON products(sku);
CREATE INDEX idx_products_name ON products(name);
CREATE INDEX idx_products_category ON products(category_id);

-- 4. Корзина
CREATE TABLE carts (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE UNIQUE
);

CREATE TABLE cart_items (
    id BIGSERIAL PRIMARY KEY,
    cart_id BIGINT NOT NULL REFERENCES carts(id) ON DELETE CASCADE,
    product_id BIGINT NOT NULL REFERENCES products(id),
    quantity INTEGER NOT NULL DEFAULT 1
);

-- 5. Заказы
CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id) ON DELETE SET NULL,
    status VARCHAR(50) NOT NULL,
    total_price DECIMAL(19, 2) NOT NULL,
    contact_phone VARCHAR(20),
    address TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE order_items (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    product_id BIGINT REFERENCES products(id),
    quantity INTEGER NOT NULL,
    price_at_purchase DECIMAL(19, 2) NOT NULL
);
</file>

<file path="autoparts-store/src/main/resources/application.yaml">
spring:
  application:
    name: autoparts-store

  datasource:
    url: jdbc:postgresql://localhost:5434/autoparts_db
    username: postgres
    password: password
    driver-class-name: org.postgresql.Driver

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: true
    properties:
      hibernate:
        format_sql: true

  flyway:
    enabled: true
    baseline-on-migrate: true

server:
  port: 8080
</file>

<file path="autoparts-store/src/test/java/com/diploma/autoparts_store/AutopartsStoreApplicationTests.java">
package com.diploma.autoparts_store;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class AutopartsStoreApplicationTests {

	@Test
	void contextLoads() {
	}

}
</file>

<file path="autoparts-store/.gitattributes">
/mvnw text eol=lf
*.cmd text eol=crlf
</file>

<file path="autoparts-store/.gitignore">
HELP.md
target/
.mvn/wrapper/maven-wrapper.jar
!**/src/main/**/target/
!**/src/test/**/target/

### STS ###
.apt_generated
.classpath
.factorypath
.project
.settings
.springBeans
.sts4-cache

### IntelliJ IDEA ###
.idea
*.iws
*.iml
*.ipr

### NetBeans ###
/nbproject/private/
/nbbuild/
/dist/
/nbdist/
/.nb-gradle/
build/
!**/src/main/**/build/
!**/src/test/**/build/

### VS Code ###
.vscode/
</file>

<file path="autoparts-store/docker-compose.yaml">
services:
  postgres:
    image: 'postgres:16-alpine'
    ports:
      - '5434:5432'
    environment:
      - 'POSTGRES_DB=autoparts_db'
      - 'POSTGRES_PASSWORD=password'
      - 'POSTGRES_USER=postgres'
    volumes:
      - 'postgres_data:/var/lib/postgresql/data'

volumes:
  postgres_data:
</file>

<file path="autoparts-store/mvnw">
#!/bin/sh
# ----------------------------------------------------------------------------
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# Apache Maven Wrapper startup batch script, version 3.3.4
#
# Optional ENV vars
# -----------------
#   JAVA_HOME - location of a JDK home dir, required when download maven via java source
#   MVNW_REPOURL - repo url base for downloading maven distribution
#   MVNW_USERNAME/MVNW_PASSWORD - user and password for downloading maven
#   MVNW_VERBOSE - true: enable verbose log; debug: trace the mvnw script; others: silence the output
# ----------------------------------------------------------------------------

set -euf
[ "${MVNW_VERBOSE-}" != debug ] || set -x

# OS specific support.
native_path() { printf %s\\n "$1"; }
case "$(uname)" in
CYGWIN* | MINGW*)
  [ -z "${JAVA_HOME-}" ] || JAVA_HOME="$(cygpath --unix "$JAVA_HOME")"
  native_path() { cygpath --path --windows "$1"; }
  ;;
esac

# set JAVACMD and JAVACCMD
set_java_home() {
  # For Cygwin and MinGW, ensure paths are in Unix format before anything is touched
  if [ -n "${JAVA_HOME-}" ]; then
    if [ -x "$JAVA_HOME/jre/sh/java" ]; then
      # IBM's JDK on AIX uses strange locations for the executables
      JAVACMD="$JAVA_HOME/jre/sh/java"
      JAVACCMD="$JAVA_HOME/jre/sh/javac"
    else
      JAVACMD="$JAVA_HOME/bin/java"
      JAVACCMD="$JAVA_HOME/bin/javac"

      if [ ! -x "$JAVACMD" ] || [ ! -x "$JAVACCMD" ]; then
        echo "The JAVA_HOME environment variable is not defined correctly, so mvnw cannot run." >&2
        echo "JAVA_HOME is set to \"$JAVA_HOME\", but \"\$JAVA_HOME/bin/java\" or \"\$JAVA_HOME/bin/javac\" does not exist." >&2
        return 1
      fi
    fi
  else
    JAVACMD="$(
      'set' +e
      'unset' -f command 2>/dev/null
      'command' -v java
    )" || :
    JAVACCMD="$(
      'set' +e
      'unset' -f command 2>/dev/null
      'command' -v javac
    )" || :

    if [ ! -x "${JAVACMD-}" ] || [ ! -x "${JAVACCMD-}" ]; then
      echo "The java/javac command does not exist in PATH nor is JAVA_HOME set, so mvnw cannot run." >&2
      return 1
    fi
  fi
}

# hash string like Java String::hashCode
hash_string() {
  str="${1:-}" h=0
  while [ -n "$str" ]; do
    char="${str%"${str#?}"}"
    h=$(((h * 31 + $(LC_CTYPE=C printf %d "'$char")) % 4294967296))
    str="${str#?}"
  done
  printf %x\\n $h
}

verbose() { :; }
[ "${MVNW_VERBOSE-}" != true ] || verbose() { printf %s\\n "${1-}"; }

die() {
  printf %s\\n "$1" >&2
  exit 1
}

trim() {
  # MWRAPPER-139:
  #   Trims trailing and leading whitespace, carriage returns, tabs, and linefeeds.
  #   Needed for removing poorly interpreted newline sequences when running in more
  #   exotic environments such as mingw bash on Windows.
  printf "%s" "${1}" | tr -d '[:space:]'
}

scriptDir="$(dirname "$0")"
scriptName="$(basename "$0")"

# parse distributionUrl and optional distributionSha256Sum, requires .mvn/wrapper/maven-wrapper.properties
while IFS="=" read -r key value; do
  case "${key-}" in
  distributionUrl) distributionUrl=$(trim "${value-}") ;;
  distributionSha256Sum) distributionSha256Sum=$(trim "${value-}") ;;
  esac
done <"$scriptDir/.mvn/wrapper/maven-wrapper.properties"
[ -n "${distributionUrl-}" ] || die "cannot read distributionUrl property in $scriptDir/.mvn/wrapper/maven-wrapper.properties"

case "${distributionUrl##*/}" in
maven-mvnd-*bin.*)
  MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/
  case "${PROCESSOR_ARCHITECTURE-}${PROCESSOR_ARCHITEW6432-}:$(uname -a)" in
  *AMD64:CYGWIN* | *AMD64:MINGW*) distributionPlatform=windows-amd64 ;;
  :Darwin*x86_64) distributionPlatform=darwin-amd64 ;;
  :Darwin*arm64) distributionPlatform=darwin-aarch64 ;;
  :Linux*x86_64*) distributionPlatform=linux-amd64 ;;
  *)
    echo "Cannot detect native platform for mvnd on $(uname)-$(uname -m), use pure java version" >&2
    distributionPlatform=linux-amd64
    ;;
  esac
  distributionUrl="${distributionUrl%-bin.*}-$distributionPlatform.zip"
  ;;
maven-mvnd-*) MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/ ;;
*) MVN_CMD="mvn${scriptName#mvnw}" _MVNW_REPO_PATTERN=/org/apache/maven/ ;;
esac

# apply MVNW_REPOURL and calculate MAVEN_HOME
# maven home pattern: ~/.m2/wrapper/dists/{apache-maven-<version>,maven-mvnd-<version>-<platform>}/<hash>
[ -z "${MVNW_REPOURL-}" ] || distributionUrl="$MVNW_REPOURL$_MVNW_REPO_PATTERN${distributionUrl#*"$_MVNW_REPO_PATTERN"}"
distributionUrlName="${distributionUrl##*/}"
distributionUrlNameMain="${distributionUrlName%.*}"
distributionUrlNameMain="${distributionUrlNameMain%-bin}"
MAVEN_USER_HOME="${MAVEN_USER_HOME:-${HOME}/.m2}"
MAVEN_HOME="${MAVEN_USER_HOME}/wrapper/dists/${distributionUrlNameMain-}/$(hash_string "$distributionUrl")"

exec_maven() {
  unset MVNW_VERBOSE MVNW_USERNAME MVNW_PASSWORD MVNW_REPOURL || :
  exec "$MAVEN_HOME/bin/$MVN_CMD" "$@" || die "cannot exec $MAVEN_HOME/bin/$MVN_CMD"
}

if [ -d "$MAVEN_HOME" ]; then
  verbose "found existing MAVEN_HOME at $MAVEN_HOME"
  exec_maven "$@"
fi

case "${distributionUrl-}" in
*?-bin.zip | *?maven-mvnd-?*-?*.zip) ;;
*) die "distributionUrl is not valid, must match *-bin.zip or maven-mvnd-*.zip, but found '${distributionUrl-}'" ;;
esac

# prepare tmp dir
if TMP_DOWNLOAD_DIR="$(mktemp -d)" && [ -d "$TMP_DOWNLOAD_DIR" ]; then
  clean() { rm -rf -- "$TMP_DOWNLOAD_DIR"; }
  trap clean HUP INT TERM EXIT
else
  die "cannot create temp dir"
fi

mkdir -p -- "${MAVEN_HOME%/*}"

# Download and Install Apache Maven
verbose "Couldn't find MAVEN_HOME, downloading and installing it ..."
verbose "Downloading from: $distributionUrl"
verbose "Downloading to: $TMP_DOWNLOAD_DIR/$distributionUrlName"

# select .zip or .tar.gz
if ! command -v unzip >/dev/null; then
  distributionUrl="${distributionUrl%.zip}.tar.gz"
  distributionUrlName="${distributionUrl##*/}"
fi

# verbose opt
__MVNW_QUIET_WGET=--quiet __MVNW_QUIET_CURL=--silent __MVNW_QUIET_UNZIP=-q __MVNW_QUIET_TAR=''
[ "${MVNW_VERBOSE-}" != true ] || __MVNW_QUIET_WGET='' __MVNW_QUIET_CURL='' __MVNW_QUIET_UNZIP='' __MVNW_QUIET_TAR=v

# normalize http auth
case "${MVNW_PASSWORD:+has-password}" in
'') MVNW_USERNAME='' MVNW_PASSWORD='' ;;
has-password) [ -n "${MVNW_USERNAME-}" ] || MVNW_USERNAME='' MVNW_PASSWORD='' ;;
esac

if [ -z "${MVNW_USERNAME-}" ] && command -v wget >/dev/null; then
  verbose "Found wget ... using wget"
  wget ${__MVNW_QUIET_WGET:+"$__MVNW_QUIET_WGET"} "$distributionUrl" -O "$TMP_DOWNLOAD_DIR/$distributionUrlName" || die "wget: Failed to fetch $distributionUrl"
elif [ -z "${MVNW_USERNAME-}" ] && command -v curl >/dev/null; then
  verbose "Found curl ... using curl"
  curl ${__MVNW_QUIET_CURL:+"$__MVNW_QUIET_CURL"} -f -L -o "$TMP_DOWNLOAD_DIR/$distributionUrlName" "$distributionUrl" || die "curl: Failed to fetch $distributionUrl"
elif set_java_home; then
  verbose "Falling back to use Java to download"
  javaSource="$TMP_DOWNLOAD_DIR/Downloader.java"
  targetZip="$TMP_DOWNLOAD_DIR/$distributionUrlName"
  cat >"$javaSource" <<-END
	public class Downloader extends java.net.Authenticator
	{
	  protected java.net.PasswordAuthentication getPasswordAuthentication()
	  {
	    return new java.net.PasswordAuthentication( System.getenv( "MVNW_USERNAME" ), System.getenv( "MVNW_PASSWORD" ).toCharArray() );
	  }
	  public static void main( String[] args ) throws Exception
	  {
	    setDefault( new Downloader() );
	    java.nio.file.Files.copy( java.net.URI.create( args[0] ).toURL().openStream(), java.nio.file.Paths.get( args[1] ).toAbsolutePath().normalize() );
	  }
	}
	END
  # For Cygwin/MinGW, switch paths to Windows format before running javac and java
  verbose " - Compiling Downloader.java ..."
  "$(native_path "$JAVACCMD")" "$(native_path "$javaSource")" || die "Failed to compile Downloader.java"
  verbose " - Running Downloader.java ..."
  "$(native_path "$JAVACMD")" -cp "$(native_path "$TMP_DOWNLOAD_DIR")" Downloader "$distributionUrl" "$(native_path "$targetZip")"
fi

# If specified, validate the SHA-256 sum of the Maven distribution zip file
if [ -n "${distributionSha256Sum-}" ]; then
  distributionSha256Result=false
  if [ "$MVN_CMD" = mvnd.sh ]; then
    echo "Checksum validation is not supported for maven-mvnd." >&2
    echo "Please disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties." >&2
    exit 1
  elif command -v sha256sum >/dev/null; then
    if echo "$distributionSha256Sum  $TMP_DOWNLOAD_DIR/$distributionUrlName" | sha256sum -c - >/dev/null 2>&1; then
      distributionSha256Result=true
    fi
  elif command -v shasum >/dev/null; then
    if echo "$distributionSha256Sum  $TMP_DOWNLOAD_DIR/$distributionUrlName" | shasum -a 256 -c >/dev/null 2>&1; then
      distributionSha256Result=true
    fi
  else
    echo "Checksum validation was requested but neither 'sha256sum' or 'shasum' are available." >&2
    echo "Please install either command, or disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties." >&2
    exit 1
  fi
  if [ $distributionSha256Result = false ]; then
    echo "Error: Failed to validate Maven distribution SHA-256, your Maven distribution might be compromised." >&2
    echo "If you updated your Maven version, you need to update the specified distributionSha256Sum property." >&2
    exit 1
  fi
fi

# unzip and move
if command -v unzip >/dev/null; then
  unzip ${__MVNW_QUIET_UNZIP:+"$__MVNW_QUIET_UNZIP"} "$TMP_DOWNLOAD_DIR/$distributionUrlName" -d "$TMP_DOWNLOAD_DIR" || die "failed to unzip"
else
  tar xzf${__MVNW_QUIET_TAR:+"$__MVNW_QUIET_TAR"} "$TMP_DOWNLOAD_DIR/$distributionUrlName" -C "$TMP_DOWNLOAD_DIR" || die "failed to untar"
fi

# Find the actual extracted directory name (handles snapshots where filename != directory name)
actualDistributionDir=""

# First try the expected directory name (for regular distributions)
if [ -d "$TMP_DOWNLOAD_DIR/$distributionUrlNameMain" ]; then
  if [ -f "$TMP_DOWNLOAD_DIR/$distributionUrlNameMain/bin/$MVN_CMD" ]; then
    actualDistributionDir="$distributionUrlNameMain"
  fi
fi

# If not found, search for any directory with the Maven executable (for snapshots)
if [ -z "$actualDistributionDir" ]; then
  # enable globbing to iterate over items
  set +f
  for dir in "$TMP_DOWNLOAD_DIR"/*; do
    if [ -d "$dir" ]; then
      if [ -f "$dir/bin/$MVN_CMD" ]; then
        actualDistributionDir="$(basename "$dir")"
        break
      fi
    fi
  done
  set -f
fi

if [ -z "$actualDistributionDir" ]; then
  verbose "Contents of $TMP_DOWNLOAD_DIR:"
  verbose "$(ls -la "$TMP_DOWNLOAD_DIR")"
  die "Could not find Maven distribution directory in extracted archive"
fi

verbose "Found extracted Maven distribution directory: $actualDistributionDir"
printf %s\\n "$distributionUrl" >"$TMP_DOWNLOAD_DIR/$actualDistributionDir/mvnw.url"
mv -- "$TMP_DOWNLOAD_DIR/$actualDistributionDir" "$MAVEN_HOME" || [ -d "$MAVEN_HOME" ] || die "fail to move MAVEN_HOME"

clean || :
exec_maven "$@"
</file>

<file path="autoparts-store/mvnw.cmd">
<# : batch portion
@REM ----------------------------------------------------------------------------
@REM Licensed to the Apache Software Foundation (ASF) under one
@REM or more contributor license agreements.  See the NOTICE file
@REM distributed with this work for additional information
@REM regarding copyright ownership.  The ASF licenses this file
@REM to you under the Apache License, Version 2.0 (the
@REM "License"); you may not use this file except in compliance
@REM with the License.  You may obtain a copy of the License at
@REM
@REM    http://www.apache.org/licenses/LICENSE-2.0
@REM
@REM Unless required by applicable law or agreed to in writing,
@REM software distributed under the License is distributed on an
@REM "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
@REM KIND, either express or implied.  See the License for the
@REM specific language governing permissions and limitations
@REM under the License.
@REM ----------------------------------------------------------------------------

@REM ----------------------------------------------------------------------------
@REM Apache Maven Wrapper startup batch script, version 3.3.4
@REM
@REM Optional ENV vars
@REM   MVNW_REPOURL - repo url base for downloading maven distribution
@REM   MVNW_USERNAME/MVNW_PASSWORD - user and password for downloading maven
@REM   MVNW_VERBOSE - true: enable verbose log; others: silence the output
@REM ----------------------------------------------------------------------------

@IF "%__MVNW_ARG0_NAME__%"=="" (SET __MVNW_ARG0_NAME__=%~nx0)
@SET __MVNW_CMD__=
@SET __MVNW_ERROR__=
@SET __MVNW_PSMODULEP_SAVE=%PSModulePath%
@SET PSModulePath=
@FOR /F "usebackq tokens=1* delims==" %%A IN (`powershell -noprofile "& {$scriptDir='%~dp0'; $script='%__MVNW_ARG0_NAME__%'; icm -ScriptBlock ([Scriptblock]::Create((Get-Content -Raw '%~f0'))) -NoNewScope}"`) DO @(
  IF "%%A"=="MVN_CMD" (set __MVNW_CMD__=%%B) ELSE IF "%%B"=="" (echo %%A) ELSE (echo %%A=%%B)
)
@SET PSModulePath=%__MVNW_PSMODULEP_SAVE%
@SET __MVNW_PSMODULEP_SAVE=
@SET __MVNW_ARG0_NAME__=
@SET MVNW_USERNAME=
@SET MVNW_PASSWORD=
@IF NOT "%__MVNW_CMD__%"=="" ("%__MVNW_CMD__%" %*)
@echo Cannot start maven from wrapper >&2 && exit /b 1
@GOTO :EOF
: end batch / begin powershell #>

$ErrorActionPreference = "Stop"
if ($env:MVNW_VERBOSE -eq "true") {
  $VerbosePreference = "Continue"
}

# calculate distributionUrl, requires .mvn/wrapper/maven-wrapper.properties
$distributionUrl = (Get-Content -Raw "$scriptDir/.mvn/wrapper/maven-wrapper.properties" | ConvertFrom-StringData).distributionUrl
if (!$distributionUrl) {
  Write-Error "cannot read distributionUrl property in $scriptDir/.mvn/wrapper/maven-wrapper.properties"
}

switch -wildcard -casesensitive ( $($distributionUrl -replace '^.*/','') ) {
  "maven-mvnd-*" {
    $USE_MVND = $true
    $distributionUrl = $distributionUrl -replace '-bin\.[^.]*$',"-windows-amd64.zip"
    $MVN_CMD = "mvnd.cmd"
    break
  }
  default {
    $USE_MVND = $false
    $MVN_CMD = $script -replace '^mvnw','mvn'
    break
  }
}

# apply MVNW_REPOURL and calculate MAVEN_HOME
# maven home pattern: ~/.m2/wrapper/dists/{apache-maven-<version>,maven-mvnd-<version>-<platform>}/<hash>
if ($env:MVNW_REPOURL) {
  $MVNW_REPO_PATTERN = if ($USE_MVND -eq $False) { "/org/apache/maven/" } else { "/maven/mvnd/" }
  $distributionUrl = "$env:MVNW_REPOURL$MVNW_REPO_PATTERN$($distributionUrl -replace "^.*$MVNW_REPO_PATTERN",'')"
}
$distributionUrlName = $distributionUrl -replace '^.*/',''
$distributionUrlNameMain = $distributionUrlName -replace '\.[^.]*$','' -replace '-bin$',''

$MAVEN_M2_PATH = "$HOME/.m2"
if ($env:MAVEN_USER_HOME) {
  $MAVEN_M2_PATH = "$env:MAVEN_USER_HOME"
}

if (-not (Test-Path -Path $MAVEN_M2_PATH)) {
    New-Item -Path $MAVEN_M2_PATH -ItemType Directory | Out-Null
}

$MAVEN_WRAPPER_DISTS = $null
if ((Get-Item $MAVEN_M2_PATH).Target[0] -eq $null) {
  $MAVEN_WRAPPER_DISTS = "$MAVEN_M2_PATH/wrapper/dists"
} else {
  $MAVEN_WRAPPER_DISTS = (Get-Item $MAVEN_M2_PATH).Target[0] + "/wrapper/dists"
}

$MAVEN_HOME_PARENT = "$MAVEN_WRAPPER_DISTS/$distributionUrlNameMain"
$MAVEN_HOME_NAME = ([System.Security.Cryptography.SHA256]::Create().ComputeHash([byte[]][char[]]$distributionUrl) | ForEach-Object {$_.ToString("x2")}) -join ''
$MAVEN_HOME = "$MAVEN_HOME_PARENT/$MAVEN_HOME_NAME"

if (Test-Path -Path "$MAVEN_HOME" -PathType Container) {
  Write-Verbose "found existing MAVEN_HOME at $MAVEN_HOME"
  Write-Output "MVN_CMD=$MAVEN_HOME/bin/$MVN_CMD"
  exit $?
}

if (! $distributionUrlNameMain -or ($distributionUrlName -eq $distributionUrlNameMain)) {
  Write-Error "distributionUrl is not valid, must end with *-bin.zip, but found $distributionUrl"
}

# prepare tmp dir
$TMP_DOWNLOAD_DIR_HOLDER = New-TemporaryFile
$TMP_DOWNLOAD_DIR = New-Item -Itemtype Directory -Path "$TMP_DOWNLOAD_DIR_HOLDER.dir"
$TMP_DOWNLOAD_DIR_HOLDER.Delete() | Out-Null
trap {
  if ($TMP_DOWNLOAD_DIR.Exists) {
    try { Remove-Item $TMP_DOWNLOAD_DIR -Recurse -Force | Out-Null }
    catch { Write-Warning "Cannot remove $TMP_DOWNLOAD_DIR" }
  }
}

New-Item -Itemtype Directory -Path "$MAVEN_HOME_PARENT" -Force | Out-Null

# Download and Install Apache Maven
Write-Verbose "Couldn't find MAVEN_HOME, downloading and installing it ..."
Write-Verbose "Downloading from: $distributionUrl"
Write-Verbose "Downloading to: $TMP_DOWNLOAD_DIR/$distributionUrlName"

$webclient = New-Object System.Net.WebClient
if ($env:MVNW_USERNAME -and $env:MVNW_PASSWORD) {
  $webclient.Credentials = New-Object System.Net.NetworkCredential($env:MVNW_USERNAME, $env:MVNW_PASSWORD)
}
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
$webclient.DownloadFile($distributionUrl, "$TMP_DOWNLOAD_DIR/$distributionUrlName") | Out-Null

# If specified, validate the SHA-256 sum of the Maven distribution zip file
$distributionSha256Sum = (Get-Content -Raw "$scriptDir/.mvn/wrapper/maven-wrapper.properties" | ConvertFrom-StringData).distributionSha256Sum
if ($distributionSha256Sum) {
  if ($USE_MVND) {
    Write-Error "Checksum validation is not supported for maven-mvnd. `nPlease disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties."
  }
  Import-Module $PSHOME\Modules\Microsoft.PowerShell.Utility -Function Get-FileHash
  if ((Get-FileHash "$TMP_DOWNLOAD_DIR/$distributionUrlName" -Algorithm SHA256).Hash.ToLower() -ne $distributionSha256Sum) {
    Write-Error "Error: Failed to validate Maven distribution SHA-256, your Maven distribution might be compromised. If you updated your Maven version, you need to update the specified distributionSha256Sum property."
  }
}

# unzip and move
Expand-Archive "$TMP_DOWNLOAD_DIR/$distributionUrlName" -DestinationPath "$TMP_DOWNLOAD_DIR" | Out-Null

# Find the actual extracted directory name (handles snapshots where filename != directory name)
$actualDistributionDir = ""

# First try the expected directory name (for regular distributions)
$expectedPath = Join-Path "$TMP_DOWNLOAD_DIR" "$distributionUrlNameMain"
$expectedMvnPath = Join-Path "$expectedPath" "bin/$MVN_CMD"
if ((Test-Path -Path $expectedPath -PathType Container) -and (Test-Path -Path $expectedMvnPath -PathType Leaf)) {
  $actualDistributionDir = $distributionUrlNameMain
}

# If not found, search for any directory with the Maven executable (for snapshots)
if (!$actualDistributionDir) {
  Get-ChildItem -Path "$TMP_DOWNLOAD_DIR" -Directory | ForEach-Object {
    $testPath = Join-Path $_.FullName "bin/$MVN_CMD"
    if (Test-Path -Path $testPath -PathType Leaf) {
      $actualDistributionDir = $_.Name
    }
  }
}

if (!$actualDistributionDir) {
  Write-Error "Could not find Maven distribution directory in extracted archive"
}

Write-Verbose "Found extracted Maven distribution directory: $actualDistributionDir"
Rename-Item -Path "$TMP_DOWNLOAD_DIR/$actualDistributionDir" -NewName $MAVEN_HOME_NAME | Out-Null
try {
  Move-Item -Path "$TMP_DOWNLOAD_DIR/$MAVEN_HOME_NAME" -Destination $MAVEN_HOME_PARENT | Out-Null
} catch {
  if (! (Test-Path -Path "$MAVEN_HOME" -PathType Container)) {
    Write-Error "fail to move MAVEN_HOME"
  }
} finally {
  try { Remove-Item $TMP_DOWNLOAD_DIR -Recurse -Force | Out-Null }
  catch { Write-Warning "Cannot remove $TMP_DOWNLOAD_DIR" }
}

Write-Output "MVN_CMD=$MAVEN_HOME/bin/$MVN_CMD"
</file>

<file path="autoparts-store/pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>4.0.2</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>com.diploma</groupId>
	<artifactId>autoparts-store</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>autoparts-store</name>
	<description>Backend for diploma</description>
	<url/>
	<licenses>
		<license/>
	</licenses>
	<developers>
		<developer/>
	</developers>
	<scm>
		<connection/>
		<developerConnection/>
		<tag/>
		<url/>
	</scm>
	<properties>
		<java.version>21</java.version>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-flyway</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-validation</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-webmvc</artifactId>
		</dependency>
		<dependency>
			<groupId>org.flywaydb</groupId>
			<artifactId>flyway-database-postgresql</artifactId>
		</dependency>

		<dependency>
			<groupId>org.postgresql</groupId>
			<artifactId>postgresql</artifactId>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-api</artifactId>
			<version>0.11.5</version>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-impl</artifactId>
			<version>0.11.5</version>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-jackson</artifactId>
			<version>0.11.5</version>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-flyway-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-validation-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-webmvc-test</artifactId>
			<scope>test</scope>
		</dependency>
	</dependencies>

	<build>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-compiler-plugin</artifactId>
				<configuration>
					<annotationProcessorPaths>
						<path>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</path>
					</annotationProcessorPaths>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
				<configuration>
					<excludes>
						<exclude>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</exclude>
					</excludes>
				</configuration>
			</plugin>
		</plugins>
	</build>

</project>
</file>

<file path="autoparts-store/repomix-output.xml">
This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: **/*.lock, **/*.svg, **/*.png, **/*.ico, **/*.json
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.mvn/
  wrapper/
    maven-wrapper.properties
src/
  main/
    java/
      com/
        diploma/
          autoparts_store/
            config/
              ApplicationConfig.java
              SecurityConfig.java
            controller/
              AuthController.java
              CartController.java
              CategoryController.java
              OrderController.java
              ProductController.java
            dto/
              AddToCartRequest.java
              AuthRequest.java
              AuthResponse.java
              CartDto.java
              CartItemDto.java
              CategoryDto.java
              CreateProductRequest.java
              OrderDto.java
              ProductDto.java
              RegisterRequest.java
            entity/
              Cart.java
              CartItem.java
              Category.java
              Order.java
              OrderItem.java
              OrderStatus.java
              Product.java
              Role.java
              User.java
            repository/
              CartRepository.java
              CategoryRepository.java
              OrderRepository.java
              ProductRepository.java
              UserRepository.java
            security/
              AuthEntryPointJwt.java
              JwtAuthenticationFilter.java
              JwtService.java
            service/
              AuthenticationService.java
              CartService.java
              CategoryService.java
              OrderService.java
              ProductService.java
            AutopartsStoreApplication.java
    resources/
      db/
        migration/
          V1__init_schema.sql
      application.yaml
  test/
    java/
      com/
        diploma/
          autoparts_store/
            AutopartsStoreApplicationTests.java
.gitattributes
.gitignore
docker-compose.yaml
mvnw
mvnw.cmd
pom.xml
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".mvn/wrapper/maven-wrapper.properties">
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.12/apache-maven-3.9.12-bin.zip
</file>

<file path="src/main/java/com/diploma/autoparts_store/config/ApplicationConfig.java">
package com.diploma.autoparts_store.config;

import com.diploma.autoparts_store.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

@Configuration
@RequiredArgsConstructor
public class ApplicationConfig {
    private final UserRepository userRepository;

    @Bean
    public UserDetailsService userDetailsService() {
        return username -> userRepository.findByPhone(username)
                .orElseThrow(() -> new UsernameNotFoundException("Пользователь не найден"));
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/config/SecurityConfig.java">
package com.diploma.autoparts_store.config;

import com.diploma.autoparts_store.security.AuthEntryPointJwt;
import com.diploma.autoparts_store.security.JwtAuthenticationFilter;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.List;

@Configuration
@EnableWebSecurity
@EnableMethodSecurity
@RequiredArgsConstructor
public class SecurityConfig {
    private final PasswordEncoder passwordEncoder;
    private final UserDetailsService userDetailsService;
    private final JwtAuthenticationFilter jwtFilter;
    private final AuthEntryPointJwt unauthorizedHandler;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
                .csrf(AbstractHttpConfigurer::disable)
                .cors(cors -> cors.configurationSource(corsConfigurationSource()))
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/auth/**").permitAll()
                        .requestMatchers(HttpMethod.GET, "/api/v1/products/**").permitAll()
                        .requestMatchers(HttpMethod.GET, "/api/v1/categories/**").permitAll()
                        .requestMatchers("/v3/api-docs/**", "/swagger-ui/**").permitAll()
                        .anyRequest().authenticated()
                )
                .sessionManagement(session -> session
                        .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
                )
                .authenticationProvider(authenticationProvider())
                .addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class)
                .exceptionHandling(exception -> exception
                        .authenticationEntryPoint(unauthorizedHandler));

        return http.build();
    }

    @Bean
    public DaoAuthenticationProvider authenticationProvider() {
        DaoAuthenticationProvider provider = new DaoAuthenticationProvider(userDetailsService);
        provider.setPasswordEncoder(passwordEncoder);
        return provider;
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration configuration) throws Exception {
        return configuration.getAuthenticationManager();
    }

    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration corsConfiguration = new CorsConfiguration();
        corsConfiguration.setAllowedOrigins(List.of("http://localhost:4200", "http://localhost:3000"));
        corsConfiguration.setAllowedMethods(List.of("GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"));
        corsConfiguration.setAllowedHeaders(List.of("Authorization", "Content-Type"));
        corsConfiguration.setAllowCredentials(true);

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", corsConfiguration);

        return source;
    }
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/controller/AuthController.java">
package com.diploma.autoparts_store.controller;

import com.diploma.autoparts_store.dto.AuthRequest;
import com.diploma.autoparts_store.dto.AuthResponse;
import com.diploma.autoparts_store.dto.RegisterRequest;
import com.diploma.autoparts_store.service.AuthenticationService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/auth")
@RequiredArgsConstructor
public class AuthController {
    private final AuthenticationService service;

    @PostMapping("/register")
    public ResponseEntity<AuthResponse> register(@RequestBody RegisterRequest request) {
        return ResponseEntity.ok(service.register(request));
    }

    @PostMapping("/login")
    public ResponseEntity<AuthResponse> authenticate(@RequestBody AuthRequest request) {
        return ResponseEntity.ok(service.authenticate(request));
    }
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/controller/CartController.java">
package com.diploma.autoparts_store.controller;

import com.diploma.autoparts_store.dto.AddToCartRequest;
import com.diploma.autoparts_store.dto.CartDto;
import com.diploma.autoparts_store.service.CartService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.security.Principal;

@RestController
@RequestMapping("/api/v1/cart")
@RequiredArgsConstructor
public class CartController {
    private final CartService cartService;

    @GetMapping
    public CartDto getCart(Principal principal) {
        return cartService.getCart(principal.getName());
    }

    @PostMapping("/items")
    public CartDto addToCart(Principal principal, @RequestBody AddToCartRequest request) {
        return cartService.addToCart(principal.getName(), request);
    }

    @DeleteMapping("/items/{itemId}")
    public CartDto removeItem(Principal principal, @PathVariable Long itemId) {
        return cartService.removeFromCart(principal.getName(), itemId);
    }

    @DeleteMapping
    public void clearCart(Principal principal) {
        cartService.clearCart(principal.getName());
    }
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/controller/CategoryController.java">
package com.diploma.autoparts_store.controller;

import com.diploma.autoparts_store.dto.CategoryDto;
import com.diploma.autoparts_store.service.CategoryService;
import lombok.RequiredArgsConstructor;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/v1/categories")
@RequiredArgsConstructor
public class CategoryController {
    private final CategoryService categoryService;

    @GetMapping
    public List<CategoryDto> getTree() {
        return categoryService.getAllCategoriesTree();
    }

    @PostMapping
    @PreAuthorize("hasAuthority('ADMIN')")
    public void create(@RequestParam String name, @RequestParam(required = false) Long parentId) {
        categoryService.createCategory(name, parentId);
    }

    @PutMapping("/{id}")
    @PreAuthorize("hasAuthority('ADMIN')")
    public void update(@PathVariable Long id,
                       @RequestParam String name,
                       @RequestParam(required = false) Long parentId) {
        categoryService.updateCategory(id, name, parentId);
    }

    @DeleteMapping("/{id}")
    @PreAuthorize("hasAuthority('ADMIN')")
    public void delete(@PathVariable Long id) {
        categoryService.deleteCategory(id);
    }
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/controller/OrderController.java">
package com.diploma.autoparts_store.controller;

import com.diploma.autoparts_store.dto.OrderDto;
import com.diploma.autoparts_store.entity.Role;
import com.diploma.autoparts_store.entity.User;
import com.diploma.autoparts_store.repository.UserRepository;
import com.diploma.autoparts_store.service.OrderService;
import lombok.RequiredArgsConstructor;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.security.Principal;
import java.util.List;

@RestController
@RequestMapping("/api/v1/orders")
@RequiredArgsConstructor
public class OrderController {
    private final OrderService orderService;
    private final UserRepository userRepository;

    @PostMapping
    public OrderDto createOrder(Principal principal) {
        return orderService.createOrder(principal.getName());
    }

    @GetMapping
    public List<OrderDto> getOrders(Principal principal) {
        User user = userRepository.findByPhone(principal.getName()).orElseThrow();

        if (user.getRole() == Role.ADMIN) {
            return orderService.getAllOrders();
        } else {
            return orderService.getUserOrders(principal.getName());
        }
    }

    @PatchMapping("/{id}/status")
    @PreAuthorize("hasAuthority('ADMIN')")
    public void updateStatus(@PathVariable Long id, @RequestParam String status) {
        orderService.updateStatus(id, status);
    }
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/controller/ProductController.java">
package com.diploma.autoparts_store.controller;

import com.diploma.autoparts_store.dto.CreateProductRequest;
import com.diploma.autoparts_store.dto.ProductDto;
import com.diploma.autoparts_store.service.ProductService;
import lombok.RequiredArgsConstructor;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/v1/products")
@RequiredArgsConstructor
public class ProductController {
    private final ProductService productService;

    @GetMapping
    public List<ProductDto> getAll(
            @RequestParam(required = false) Long categoryId,
            @RequestParam(required = false) String query
    ) {
        return productService.getProducts(categoryId, query);
    }

    @PostMapping
    @PreAuthorize("hasAuthority('ADMIN')")
    public ProductDto create(@RequestBody CreateProductRequest request) {
        return productService.createProduct(request);
    }

    @PutMapping("/{id}")
    @PreAuthorize("hasAuthority('ADMIN')")
    public ProductDto update(@PathVariable Long id, @RequestBody CreateProductRequest request) {
        return productService.updateProduct(id, request);
    }

    @DeleteMapping("/{id}")
    @PreAuthorize("hasAuthority('ADMIN')")
    public void delete(@PathVariable Long id) {
        productService.deleteProduct(id);
    }
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/dto/AddToCartRequest.java">
package com.diploma.autoparts_store.dto;

public record AddToCartRequest(
        Long productId,
        Integer quantity
) {}
</file>

<file path="src/main/java/com/diploma/autoparts_store/dto/AuthRequest.java">
package com.diploma.autoparts_store.dto;

public record AuthRequest(String phone, String password) {
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/dto/AuthResponse.java">
package com.diploma.autoparts_store.dto;

public record AuthResponse(String token) {
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/dto/CartDto.java">
package com.diploma.autoparts_store.dto;

import java.math.BigDecimal;
import java.util.List;

public record CartDto(
        List<CartItemDto> items,
        BigDecimal totalPrice
) {}
</file>

<file path="src/main/java/com/diploma/autoparts_store/dto/CartItemDto.java">
package com.diploma.autoparts_store.dto;

import java.math.BigDecimal;

public record CartItemDto(
        Long id,
        Long productId,
        String sku,
        String name,
        String imageUrl,
        Integer quantity,
        BigDecimal price,
        BigDecimal sum
) {}
</file>

<file path="src/main/java/com/diploma/autoparts_store/dto/CategoryDto.java">
package com.diploma.autoparts_store.dto;

import java.util.List;

public record CategoryDto(
        Long id,
        String name,
        Long parentId,
        List<CategoryDto> children
) {}
</file>

<file path="src/main/java/com/diploma/autoparts_store/dto/CreateProductRequest.java">
package com.diploma.autoparts_store.dto;

import java.math.BigDecimal;

public record CreateProductRequest(
        String sku,
        String name,
        String description,
        BigDecimal price,
        Integer stockQuantity,
        String imageUrl,
        Long categoryId
) {}
</file>

<file path="src/main/java/com/diploma/autoparts_store/dto/OrderDto.java">
package com.diploma.autoparts_store.dto;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;

public record OrderDto(
        Long id,
        String status,
        BigDecimal totalPrice,
        LocalDateTime createdAt,
        List<CartItemDto> items,
        String contactPhone
) {}
</file>

<file path="src/main/java/com/diploma/autoparts_store/dto/ProductDto.java">
package com.diploma.autoparts_store.dto;

import java.math.BigDecimal;

public record ProductDto(
        Long id,
        String sku,
        String name,
        String description,
        BigDecimal price,
        Integer stockQuantity,
        String imageUrl,
        String categoryName,
        Long categoryId
) {}
</file>

<file path="src/main/java/com/diploma/autoparts_store/dto/RegisterRequest.java">
package com.diploma.autoparts_store.dto;


public record RegisterRequest(String phone, String password, String firstName, String lastName) {
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/entity/Cart.java">
package com.diploma.autoparts_store.entity;

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.ArrayList;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "carts")
public class Cart {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @OneToOne
    @JoinColumn(name = "user_id", referencedColumnName = "id", nullable = false)
    private User user;

    @OneToMany(mappedBy = "cart", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<CartItem> items = new ArrayList<>();
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/entity/CartItem.java">
package com.diploma.autoparts_store.entity;

import jakarta.persistence.*;
import lombok.*;

@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "cart_items")
public class CartItem {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "cart_id", nullable = false)
    private Cart cart;

    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = "product_id", nullable = false)
    private Product product;

    @Column(nullable = false)
    private Integer quantity;
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/entity/Category.java">
package com.diploma.autoparts_store.entity;

import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;

import java.util.ArrayList;
import java.util.List;

@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "categories")
public class Category {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false)
    private String name;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "parent_id")
    @JsonIgnore
    private Category parent;

    @OneToMany(mappedBy = "parent", cascade = CascadeType.ALL)
    private List<Category> children = new ArrayList<>();
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/entity/Order.java">
package com.diploma.autoparts_store.entity;

import jakarta.persistence.*;
import lombok.*;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "orders")
public class Order {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    private User user;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private OrderStatus status;

    @Column(nullable = false)
    private BigDecimal totalPrice;

    private String contactPhone;
    private String address;

    @Builder.Default
    private LocalDateTime createdAt = LocalDateTime.now();

    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL)
    private List<OrderItem> items = new ArrayList<>();
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/entity/OrderItem.java">
package com.diploma.autoparts_store.entity;

import jakarta.persistence.*;
import lombok.*;

import java.math.BigDecimal;

@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "order_items")
public class OrderItem {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "order_id", nullable = false)
    private Order order;

    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = "product_id")
    private Product product;

    @Column(nullable = false)
    private Integer quantity;

    @Column(nullable = false)
    private BigDecimal priceAtPurchase;
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/entity/OrderStatus.java">
package com.diploma.autoparts_store.entity;

public enum OrderStatus {
    CREATED,    // Создан
    CONFIRMED,  // Подтвержден менеджером
    PAID,       // Оплачен
    SHIPPED,    // Отправлен
    COMPLETED,  // Завершен (выдан)
    CANCELLED   // Отменен
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/entity/Product.java">
package com.diploma.autoparts_store.entity;

import jakarta.persistence.*;
import lombok.*;

import java.math.BigDecimal;

@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "products")
public class Product {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, unique = true)
    private String sku; // Артикул

    @Column(nullable = false)
    private String name;

    @Column(columnDefinition = "TEXT")
    private String description;

    @Column(nullable = false)
    private BigDecimal price;

    @Column(nullable = false)
    private Integer stockQuantity;

    private String imageUrl;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "category_id")
    private Category category;
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/entity/Role.java">
package com.diploma.autoparts_store.entity;

public enum Role {
    CLIENT,
    ADMIN
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/entity/User.java">
package com.diploma.autoparts_store.entity;

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import java.math.BigDecimal;
import java.util.Collection;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "users")
public class User implements UserDetails {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(unique = true, nullable = false)
    private String phone;

    @Column(nullable = false)
    private String password;

    private String firstName;
    private String lastName;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private Role role;

    private BigDecimal balance;

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return List.of(new SimpleGrantedAuthority(role.name()));
    }

    @Override
    public String getUsername() {
        return phone;
    }

    @Override
    public boolean isAccountNonExpired() {
        return true;
    }

    @Override
    public boolean isAccountNonLocked() {
        return true;
    }

    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }

    @Override
    public boolean isEnabled() {
        return true;
    }
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/repository/CartRepository.java">
package com.diploma.autoparts_store.repository;

import com.diploma.autoparts_store.entity.Cart;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

public interface CartRepository extends JpaRepository<Cart, Long> {
    Optional<Cart> findByUserId(Long userId);
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/repository/CategoryRepository.java">
package com.diploma.autoparts_store.repository;

import com.diploma.autoparts_store.entity.Category;
import org.springframework.data.jpa.repository.JpaRepository;
import java.util.List;

public interface CategoryRepository extends JpaRepository<Category, Long> {
    List<Category> findByParentIsNull();
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/repository/OrderRepository.java">
package com.diploma.autoparts_store.repository;

import com.diploma.autoparts_store.entity.Order;
import org.springframework.data.jpa.repository.JpaRepository;
import java.util.List;

public interface OrderRepository extends JpaRepository<Order, Long> {
    List<Order> findByUserId(Long userId);
    List<Order> findAllByOrderByCreatedAtDesc();
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/repository/ProductRepository.java">
package com.diploma.autoparts_store.repository;

import com.diploma.autoparts_store.entity.Product;
import org.springframework.data.jpa.repository.JpaRepository;
import java.util.List;

public interface ProductRepository extends JpaRepository<Product, Long> {
    List<Product> findByCategoryId(Long categoryId);

    List<Product> findByNameContainingIgnoreCaseOrSkuContainingIgnoreCase(String name, String sku);
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/repository/UserRepository.java">
package com.diploma.autoparts_store.repository;

import com.diploma.autoparts_store.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByPhone(String phone);
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/security/AuthEntryPointJwt.java">
package com.diploma.autoparts_store.security;

import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.AuthenticationEntryPoint;
import org.springframework.stereotype.Component;

import java.io.IOException;

@Component
public class AuthEntryPointJwt implements AuthenticationEntryPoint {
    @Override
    public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException)
            throws IOException, ServletException {
        response.sendError(HttpServletResponse.SC_UNAUTHORIZED, "Error: Unauthorized");
    }
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/security/JwtAuthenticationFilter.java">
package com.diploma.autoparts_store.security;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.lang.NonNull;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;

@Component
@RequiredArgsConstructor
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    private final JwtService jwtService;
    private final UserDetailsService userDetailsService;

    @Override
    protected void doFilterInternal(
            @NonNull HttpServletRequest request,
            @NonNull HttpServletResponse response,
            @NonNull FilterChain filterChain
    ) throws ServletException, IOException {
        final String authHeader = request.getHeader("Authorization");
        final String jwt;
        final String userPhone;

        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            filterChain.doFilter(request, response);
            return;
        }

        jwt = authHeader.substring(7);
        userPhone = jwtService.extractUsername(jwt);

        if (userPhone != null && SecurityContextHolder.getContext().getAuthentication() == null) {
            UserDetails userDetails = this.userDetailsService.loadUserByUsername(userPhone);
            if (jwtService.isTokenValid(jwt, userDetails)) {
                UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                        userDetails,
                        null,
                        userDetails.getAuthorities()
                );
                authToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                SecurityContextHolder.getContext().setAuthentication(authToken);
            }
        }
        filterChain.doFilter(request, response);
    }
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/security/JwtService.java">
package com.diploma.autoparts_store.security;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.io.Decoders;
import io.jsonwebtoken.security.Keys;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Service;

import java.security.Key;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.function.Function;

@Service
public class JwtService {
    private static final String SECRET_KEY = "404E635266556A586E3272357538782F413F4428472B4B6250645367566B5970";

    public String extractUsername(String token) {
        return extractClaim(token, Claims::getSubject);
    }

    public <T> T extractClaim(String token, Function<Claims, T> claimsResolver) {
        final Claims claims = extractAllClaims(token);
        return claimsResolver.apply(claims);
    }

    public String generateToken(UserDetails userDetails) {
        return generateToken(new HashMap<>(), userDetails);
    }

    public String generateToken(Map<String, Object> extraClaims, UserDetails userDetails) {
        return Jwts.builder()
                .setClaims(extraClaims)
                .setSubject(userDetails.getUsername())
                .setIssuedAt(new Date(System.currentTimeMillis()))
                .setExpiration(new Date(System.currentTimeMillis() + 1000 * 60 * 60 * 72))
                .signWith(getSignInKey(), SignatureAlgorithm.HS256)
                .compact();
    }

    public boolean isTokenValid(String token, UserDetails userDetails) {
        final String username = extractUsername(token);
        return (username.equals(userDetails.getUsername())) && !isTokenExpired(token);
    }

    private boolean isTokenExpired(String token) {
        return extractExpiration(token).before(new Date());
    }

    private Date extractExpiration(String token) {
        return extractClaim(token, Claims::getExpiration);
    }

    private Claims extractAllClaims(String token) {
        return Jwts.parserBuilder()
                .setSigningKey(getSignInKey())
                .build()
                .parseClaimsJws(token)
                .getBody();
    }

    private Key getSignInKey() {
        byte[] keyBytes = Decoders.BASE64.decode(SECRET_KEY);
        return Keys.hmacShaKeyFor(keyBytes);
    }
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/service/AuthenticationService.java">
package com.diploma.autoparts_store.service;

import com.diploma.autoparts_store.dto.AuthRequest;
import com.diploma.autoparts_store.dto.AuthResponse;
import com.diploma.autoparts_store.dto.RegisterRequest;
import com.diploma.autoparts_store.entity.Cart;
import com.diploma.autoparts_store.entity.Role;
import com.diploma.autoparts_store.entity.User;
import com.diploma.autoparts_store.repository.CartRepository;
import com.diploma.autoparts_store.repository.UserRepository;
import com.diploma.autoparts_store.security.JwtService;
import lombok.RequiredArgsConstructor;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;

@Service
@RequiredArgsConstructor
public class AuthenticationService {
    private final UserRepository userRepository;
    private final CartRepository cartRepository;
    private final PasswordEncoder passwordEncoder;
    private final JwtService jwtService;
    private final AuthenticationManager authenticationManager;

    public AuthResponse register(RegisterRequest request) {
        var user = User.builder()
                .firstName(request.firstName())
                .lastName(request.lastName())
                .phone(request.phone())
                .password(passwordEncoder.encode(request.password()))
                .role(Role.CLIENT)
                .balance(BigDecimal.ZERO)
                .build();

        User savedUser = userRepository.save(user);

        var cart = Cart.builder()
                .user(savedUser)
                .build();
        cartRepository.save(cart);

        var jwtToken = jwtService.generateToken(user);
        return new AuthResponse(jwtToken);
    }

    public AuthResponse authenticate(AuthRequest request) {
        authenticationManager.authenticate(
                new UsernamePasswordAuthenticationToken(request.phone(), request.password())
        );
        var user = userRepository.findByPhone(request.phone())
                .orElseThrow();
        var jwtToken = jwtService.generateToken(user);
        return new AuthResponse(jwtToken);
    }
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/service/CartService.java">
package com.diploma.autoparts_store.service;

import com.diploma.autoparts_store.dto.AddToCartRequest;
import com.diploma.autoparts_store.dto.CartDto;
import com.diploma.autoparts_store.dto.CartItemDto;
import com.diploma.autoparts_store.entity.Cart;
import com.diploma.autoparts_store.entity.CartItem;
import com.diploma.autoparts_store.entity.Product;
import com.diploma.autoparts_store.entity.User;
import com.diploma.autoparts_store.repository.CartRepository;
import com.diploma.autoparts_store.repository.ProductRepository;
import com.diploma.autoparts_store.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.Optional;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class CartService {
    private final CartRepository cartRepository;
    private final ProductRepository productRepository;
    private final UserRepository userRepository;

    @Transactional
    public CartDto getCart(String userPhone) {
        Cart cart = getCartEntity(userPhone);
        return mapToDto(cart);
    }

    @Transactional
    public CartDto addToCart(String userPhone, AddToCartRequest request) {
        Cart cart = getCartEntity(userPhone);

        Product product = productRepository.findById(request.productId())
                .orElseThrow(() -> new RuntimeException("Товар не найден"));

        Optional<CartItem> existingItem = cart.getItems().stream()
                .filter(item -> item.getProduct().getId().equals(product.getId()))
                .findFirst();

        if (existingItem.isPresent()) {
            CartItem item = existingItem.get();
            item.setQuantity(item.getQuantity() + request.quantity());
        } else {
            CartItem newItem = CartItem.builder()
                    .cart(cart)
                    .product(product)
                    .quantity(request.quantity())
                    .build();
            cart.getItems().add(newItem);
        }

        cartRepository.save(cart);
        return mapToDto(cart);
    }

    @Transactional
    public CartDto removeFromCart(String userPhone, Long cartItemId) {
        Cart cart = getCartEntity(userPhone);

        cart.getItems().removeIf(item -> item.getId().equals(cartItemId));

        cartRepository.save(cart);
        return mapToDto(cart);
    }

    @Transactional
    public void clearCart(String userPhone) {
        Cart cart = getCartEntity(userPhone);
        cart.getItems().clear();
        cartRepository.save(cart);
    }

    private Cart getCartEntity(String phone) {
        User user = userRepository.findByPhone(phone)
                .orElseThrow(() -> new UsernameNotFoundException("Пользователь не найден"));

        return cartRepository.findByUserId(user.getId())
                .orElseThrow(() -> new RuntimeException("Корзина пользователя не найдена" + phone));
    }

    private CartDto mapToDto(Cart cart) {
        BigDecimal totalPrice = BigDecimal.ZERO;

        var itemsDto = cart.getItems().stream().map(item -> {
            BigDecimal sum = item.getProduct().getPrice().multiply(BigDecimal.valueOf(item.getQuantity()));
            return new CartItemDto(
                    item.getId(),
                    item.getProduct().getId(),
                    item.getProduct().getSku(),
                    item.getProduct().getName(),
                    item.getProduct().getImageUrl(),
                    item.getQuantity(),
                    item.getProduct().getPrice(),
                    sum
            );
        }).collect(Collectors.toList());

        for (CartItemDto item : itemsDto) {
            totalPrice = totalPrice.add(item.sum());
        }

        return new CartDto(itemsDto, totalPrice);
    }
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/service/CategoryService.java">
package com.diploma.autoparts_store.service;

import com.diploma.autoparts_store.dto.CategoryDto;
import com.diploma.autoparts_store.entity.Category;
import com.diploma.autoparts_store.repository.CategoryRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class CategoryService {
    private final CategoryRepository categoryRepository;

    @Transactional(readOnly = true)
    public List<CategoryDto> getAllCategoriesTree() {
        List<Category> roots = categoryRepository.findByParentIsNull();
        return roots.stream()
                .map(this::mapToDto)
                .collect(Collectors.toList());
    }

    private CategoryDto mapToDto(Category category) {
        List<CategoryDto> childrenDto = category.getChildren().stream()
                .map(this::mapToDto)
                .collect(Collectors.toList());

        return new CategoryDto(
                category.getId(),
                category.getName(),
                category.getParent() != null ? category.getParent().getId() : null,
                childrenDto
        );
    }

    @Transactional
    public void createCategory(String name, Long parentId) {
        Category category = new Category();
        category.setName(name);

        if (parentId != null) {
            Category parent = categoryRepository.findById(parentId)
                    .orElseThrow(() -> new RuntimeException("Родительская категория не найдена"));
            category.setParent(parent);
        }

        categoryRepository.save(category);
    }

    @Transactional
    public void updateCategory(Long id, String name, Long parentId) {
        Category category = categoryRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("Категория не найдена"));

        category.setName(name);

        if (parentId != null) {
            if (parentId.equals(id)) {
                throw new RuntimeException("Категория не может быть своим родителем");
            }
            Category parent = categoryRepository.findById(parentId)
                    .orElseThrow(() -> new RuntimeException("Родительская категория не найдена"));
            category.setParent(parent);
        } else {
            category.setParent(null);
        }

        categoryRepository.save(category);
    }

    @Transactional
    public void deleteCategory(Long id) {
        if (!categoryRepository.existsById(id)) {
            throw new RuntimeException("Категория не найдена");
        }
        categoryRepository.deleteById(id);
    }
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/service/OrderService.java">
package com.diploma.autoparts_store.service;

import com.diploma.autoparts_store.dto.CartItemDto;
import com.diploma.autoparts_store.dto.OrderDto;
import com.diploma.autoparts_store.entity.*;
import com.diploma.autoparts_store.repository.*;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class OrderService {
    private final OrderRepository orderRepository;
    private final CartRepository cartRepository;
    private final UserRepository userRepository;
    private final ProductRepository productRepository;

    @Transactional
    public OrderDto createOrder(String userPhone) {
        User user = userRepository.findByPhone(userPhone)
                .orElseThrow(() -> new UsernameNotFoundException("Пользователь не найден"));

        Cart cart = cartRepository.findByUserId(user.getId())
                .orElseThrow(() -> new RuntimeException("Корзина не найдена"));

        if (cart.getItems().isEmpty()) {
            throw new RuntimeException("Корзина пуста! Нельзя оформить заказ.");
        }

        Order order = Order.builder()
                .user(user)
                .status(OrderStatus.CREATED)
                .contactPhone(user.getPhone())
                .build();

        List<OrderItem> orderItems = new java.util.ArrayList<>();
        BigDecimal totalAmount = BigDecimal.ZERO;

        for (CartItem cartItem : cart.getItems()) {
            Product product = cartItem.getProduct();

            if (product.getStockQuantity() < cartItem.getQuantity()) {
                throw new RuntimeException("Товара " + product.getName() + " недостаточно на складе. Доступно: " + product.getStockQuantity());
            }

            product.setStockQuantity(product.getStockQuantity() - cartItem.getQuantity());
            productRepository.save(product);

            OrderItem orderItem = OrderItem.builder()
                    .order(order)
                    .product(product)
                    .quantity(cartItem.getQuantity())
                    .priceAtPurchase(product.getPrice())
                    .build();

            orderItems.add(orderItem);

            totalAmount = totalAmount.add(product.getPrice().multiply(BigDecimal.valueOf(cartItem.getQuantity())));
        }

        order.setItems(orderItems);
        order.setTotalPrice(totalAmount);

        Order savedOrder = orderRepository.save(order);

        cart.getItems().clear();
        cartRepository.save(cart);

        return mapToDto(savedOrder);
    }

    @Transactional(readOnly = true)
    public List<OrderDto> getUserOrders(String userPhone) {
        User user = userRepository.findByPhone(userPhone).orElseThrow();
        return orderRepository.findByUserId(user.getId()).stream()
                .map(this::mapToDto)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public List<OrderDto> getAllOrders() {
        return orderRepository.findAllByOrderByCreatedAtDesc().stream()
                .map(this::mapToDto)
                .collect(Collectors.toList());
    }

    @Transactional
    public void updateStatus(Long orderId, String statusName) {
        Order order = orderRepository.findById(orderId)
                .orElseThrow(() -> new RuntimeException("Заказ не найден"));

        try {
            OrderStatus newStatus = OrderStatus.valueOf(statusName.toUpperCase());
            order.setStatus(newStatus);
            orderRepository.save(order);
        } catch (IllegalArgumentException e) {
            throw new RuntimeException("Неверный статус заказа");
        }
    }

    private OrderDto mapToDto(Order order) {
        List<CartItemDto> itemsDto = order.getItems().stream()
                .map(item -> new CartItemDto(
                        item.getId(),
                        item.getProduct() != null ? item.getProduct().getId() : null,
                        item.getProduct() != null ? item.getProduct().getSku() : "DELETED",
                        item.getProduct() != null ? item.getProduct().getName() : "Товар удален",
                        item.getProduct() != null ? item.getProduct().getImageUrl() : null,
                        item.getQuantity(),
                        item.getPriceAtPurchase(), // Цена из истории!
                        item.getPriceAtPurchase().multiply(BigDecimal.valueOf(item.getQuantity()))
                ))
                .collect(Collectors.toList());

        return new OrderDto(
                order.getId(),
                order.getStatus().name(),
                order.getTotalPrice(),
                order.getCreatedAt(),
                itemsDto,
                order.getContactPhone()
        );
    }
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/service/ProductService.java">
package com.diploma.autoparts_store.service;

import com.diploma.autoparts_store.dto.CreateProductRequest;
import com.diploma.autoparts_store.dto.ProductDto;
import com.diploma.autoparts_store.entity.Category;
import com.diploma.autoparts_store.entity.Product;
import com.diploma.autoparts_store.repository.CategoryRepository;
import com.diploma.autoparts_store.repository.ProductRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class ProductService {
    private final ProductRepository productRepository;
    private final CategoryRepository categoryRepository;

    @Transactional(readOnly = true)
    public List<ProductDto> getProducts(Long categoryId, String query) {
        List<Product> products;

        if (categoryId != null) {
            products = productRepository.findByCategoryId(categoryId);
        } else if (query != null && !query.isBlank()) {
            products = productRepository.findByNameContainingIgnoreCaseOrSkuContainingIgnoreCase(query, query);
        } else {
            products = productRepository.findAll();
        }

        return products.stream()
                .map(this::mapToDto)
                .collect(Collectors.toList());
    }

    @Transactional
    public ProductDto createProduct(CreateProductRequest request) {
        Category category = null;
        if (request.categoryId() != null) {
            category = categoryRepository.findById(request.categoryId())
                    .orElseThrow(() -> new RuntimeException("Category not found"));
        }

        Product product = Product.builder()
                .sku(request.sku())
                .name(request.name())
                .description(request.description())
                .price(request.price())
                .stockQuantity(request.stockQuantity())
                .imageUrl(request.imageUrl())
                .category(category)
                .build();

        Product saved = productRepository.save(product);
        return mapToDto(saved);
    }

    @Transactional
    public ProductDto updateProduct(Long id, CreateProductRequest request) {
        Product product = productRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("Товар не найден"));

        if (request.categoryId() != null) {
            Category category = categoryRepository.findById(request.categoryId())
                    .orElseThrow(() -> new RuntimeException("Категория не найдена"));
            product.setCategory(category);
        }

        product.setSku(request.sku());
        product.setName(request.name());
        product.setDescription(request.description());
        product.setPrice(request.price());
        product.setStockQuantity(request.stockQuantity());
        product.setImageUrl(request.imageUrl());

        return mapToDto(productRepository.save(product));
    }

    @Transactional
    public void deleteProduct(Long id) {
        if (!productRepository.existsById(id)) {
            throw new RuntimeException("Товар не найден");
        }
        productRepository.deleteById(id);
    }

    private ProductDto mapToDto(Product p) {
        return new ProductDto(
                p.getId(),
                p.getSku(),
                p.getName(),
                p.getDescription(),
                p.getPrice(),
                p.getStockQuantity(),
                p.getImageUrl(),
                p.getCategory() != null ? p.getCategory().getName() : null,
                p.getCategory() != null ? p.getCategory().getId() : null
        );
    }
}
</file>

<file path="src/main/java/com/diploma/autoparts_store/AutopartsStoreApplication.java">
package com.diploma.autoparts_store;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class AutopartsStoreApplication {
	public static void main(String[] args) {
		SpringApplication.run(AutopartsStoreApplication.class, args);
	}
}
</file>

<file path="src/main/resources/db/migration/V1__init_schema.sql">
-- 1. Таблица Пользователей
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    phone VARCHAR(20) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    role VARCHAR(20) NOT NULL,
    balance DECIMAL(19, 2) DEFAULT 0.00
);

-- 2. Таблица Категорий
CREATE TABLE categories (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    parent_id BIGINT REFERENCES categories(id) ON DELETE SET NULL
);

-- 3. Таблица Товаров
CREATE TABLE products (
    id BIGSERIAL PRIMARY KEY,
    category_id BIGINT REFERENCES categories(id),
    sku VARCHAR(100) NOT NULL UNIQUE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(19, 2) NOT NULL,
    stock_quantity INTEGER NOT NULL DEFAULT 0,
    image_url VARCHAR(512)
);

-- Индексы
CREATE INDEX idx_products_sku ON products(sku);
CREATE INDEX idx_products_name ON products(name);
CREATE INDEX idx_products_category ON products(category_id);

-- 4. Корзина
CREATE TABLE carts (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE UNIQUE
);

CREATE TABLE cart_items (
    id BIGSERIAL PRIMARY KEY,
    cart_id BIGINT NOT NULL REFERENCES carts(id) ON DELETE CASCADE,
    product_id BIGINT NOT NULL REFERENCES products(id),
    quantity INTEGER NOT NULL DEFAULT 1
);

-- 5. Заказы
CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id) ON DELETE SET NULL,
    status VARCHAR(50) NOT NULL,
    total_price DECIMAL(19, 2) NOT NULL,
    contact_phone VARCHAR(20),
    address TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE order_items (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    product_id BIGINT REFERENCES products(id),
    quantity INTEGER NOT NULL,
    price_at_purchase DECIMAL(19, 2) NOT NULL
);
</file>

<file path="src/main/resources/application.yaml">
spring:
  application:
    name: autoparts-store

  datasource:
    url: jdbc:postgresql://localhost:5434/autoparts_db
    username: postgres
    password: password
    driver-class-name: org.postgresql.Driver

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: true
    properties:
      hibernate:
        format_sql: true

  flyway:
    enabled: true
    baseline-on-migrate: true

server:
  port: 8080
</file>

<file path="src/test/java/com/diploma/autoparts_store/AutopartsStoreApplicationTests.java">
package com.diploma.autoparts_store;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class AutopartsStoreApplicationTests {

	@Test
	void contextLoads() {
	}

}
</file>

<file path=".gitattributes">
/mvnw text eol=lf
*.cmd text eol=crlf
</file>

<file path=".gitignore">
HELP.md
target/
.mvn/wrapper/maven-wrapper.jar
!**/src/main/**/target/
!**/src/test/**/target/

### STS ###
.apt_generated
.classpath
.factorypath
.project
.settings
.springBeans
.sts4-cache

### IntelliJ IDEA ###
.idea
*.iws
*.iml
*.ipr

### NetBeans ###
/nbproject/private/
/nbbuild/
/dist/
/nbdist/
/.nb-gradle/
build/
!**/src/main/**/build/
!**/src/test/**/build/

### VS Code ###
.vscode/
</file>

<file path="docker-compose.yaml">
services:
  postgres:
    image: 'postgres:16-alpine'
    ports:
      - '5434:5432'
    environment:
      - 'POSTGRES_DB=autoparts_db'
      - 'POSTGRES_PASSWORD=password'
      - 'POSTGRES_USER=postgres'
    volumes:
      - 'postgres_data:/var/lib/postgresql/data'

volumes:
  postgres_data:
</file>

<file path="mvnw">
#!/bin/sh
# ----------------------------------------------------------------------------
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# Apache Maven Wrapper startup batch script, version 3.3.4
#
# Optional ENV vars
# -----------------
#   JAVA_HOME - location of a JDK home dir, required when download maven via java source
#   MVNW_REPOURL - repo url base for downloading maven distribution
#   MVNW_USERNAME/MVNW_PASSWORD - user and password for downloading maven
#   MVNW_VERBOSE - true: enable verbose log; debug: trace the mvnw script; others: silence the output
# ----------------------------------------------------------------------------

set -euf
[ "${MVNW_VERBOSE-}" != debug ] || set -x

# OS specific support.
native_path() { printf %s\\n "$1"; }
case "$(uname)" in
CYGWIN* | MINGW*)
  [ -z "${JAVA_HOME-}" ] || JAVA_HOME="$(cygpath --unix "$JAVA_HOME")"
  native_path() { cygpath --path --windows "$1"; }
  ;;
esac

# set JAVACMD and JAVACCMD
set_java_home() {
  # For Cygwin and MinGW, ensure paths are in Unix format before anything is touched
  if [ -n "${JAVA_HOME-}" ]; then
    if [ -x "$JAVA_HOME/jre/sh/java" ]; then
      # IBM's JDK on AIX uses strange locations for the executables
      JAVACMD="$JAVA_HOME/jre/sh/java"
      JAVACCMD="$JAVA_HOME/jre/sh/javac"
    else
      JAVACMD="$JAVA_HOME/bin/java"
      JAVACCMD="$JAVA_HOME/bin/javac"

      if [ ! -x "$JAVACMD" ] || [ ! -x "$JAVACCMD" ]; then
        echo "The JAVA_HOME environment variable is not defined correctly, so mvnw cannot run." >&2
        echo "JAVA_HOME is set to \"$JAVA_HOME\", but \"\$JAVA_HOME/bin/java\" or \"\$JAVA_HOME/bin/javac\" does not exist." >&2
        return 1
      fi
    fi
  else
    JAVACMD="$(
      'set' +e
      'unset' -f command 2>/dev/null
      'command' -v java
    )" || :
    JAVACCMD="$(
      'set' +e
      'unset' -f command 2>/dev/null
      'command' -v javac
    )" || :

    if [ ! -x "${JAVACMD-}" ] || [ ! -x "${JAVACCMD-}" ]; then
      echo "The java/javac command does not exist in PATH nor is JAVA_HOME set, so mvnw cannot run." >&2
      return 1
    fi
  fi
}

# hash string like Java String::hashCode
hash_string() {
  str="${1:-}" h=0
  while [ -n "$str" ]; do
    char="${str%"${str#?}"}"
    h=$(((h * 31 + $(LC_CTYPE=C printf %d "'$char")) % 4294967296))
    str="${str#?}"
  done
  printf %x\\n $h
}

verbose() { :; }
[ "${MVNW_VERBOSE-}" != true ] || verbose() { printf %s\\n "${1-}"; }

die() {
  printf %s\\n "$1" >&2
  exit 1
}

trim() {
  # MWRAPPER-139:
  #   Trims trailing and leading whitespace, carriage returns, tabs, and linefeeds.
  #   Needed for removing poorly interpreted newline sequences when running in more
  #   exotic environments such as mingw bash on Windows.
  printf "%s" "${1}" | tr -d '[:space:]'
}

scriptDir="$(dirname "$0")"
scriptName="$(basename "$0")"

# parse distributionUrl and optional distributionSha256Sum, requires .mvn/wrapper/maven-wrapper.properties
while IFS="=" read -r key value; do
  case "${key-}" in
  distributionUrl) distributionUrl=$(trim "${value-}") ;;
  distributionSha256Sum) distributionSha256Sum=$(trim "${value-}") ;;
  esac
done <"$scriptDir/.mvn/wrapper/maven-wrapper.properties"
[ -n "${distributionUrl-}" ] || die "cannot read distributionUrl property in $scriptDir/.mvn/wrapper/maven-wrapper.properties"

case "${distributionUrl##*/}" in
maven-mvnd-*bin.*)
  MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/
  case "${PROCESSOR_ARCHITECTURE-}${PROCESSOR_ARCHITEW6432-}:$(uname -a)" in
  *AMD64:CYGWIN* | *AMD64:MINGW*) distributionPlatform=windows-amd64 ;;
  :Darwin*x86_64) distributionPlatform=darwin-amd64 ;;
  :Darwin*arm64) distributionPlatform=darwin-aarch64 ;;
  :Linux*x86_64*) distributionPlatform=linux-amd64 ;;
  *)
    echo "Cannot detect native platform for mvnd on $(uname)-$(uname -m), use pure java version" >&2
    distributionPlatform=linux-amd64
    ;;
  esac
  distributionUrl="${distributionUrl%-bin.*}-$distributionPlatform.zip"
  ;;
maven-mvnd-*) MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/ ;;
*) MVN_CMD="mvn${scriptName#mvnw}" _MVNW_REPO_PATTERN=/org/apache/maven/ ;;
esac

# apply MVNW_REPOURL and calculate MAVEN_HOME
# maven home pattern: ~/.m2/wrapper/dists/{apache-maven-<version>,maven-mvnd-<version>-<platform>}/<hash>
[ -z "${MVNW_REPOURL-}" ] || distributionUrl="$MVNW_REPOURL$_MVNW_REPO_PATTERN${distributionUrl#*"$_MVNW_REPO_PATTERN"}"
distributionUrlName="${distributionUrl##*/}"
distributionUrlNameMain="${distributionUrlName%.*}"
distributionUrlNameMain="${distributionUrlNameMain%-bin}"
MAVEN_USER_HOME="${MAVEN_USER_HOME:-${HOME}/.m2}"
MAVEN_HOME="${MAVEN_USER_HOME}/wrapper/dists/${distributionUrlNameMain-}/$(hash_string "$distributionUrl")"

exec_maven() {
  unset MVNW_VERBOSE MVNW_USERNAME MVNW_PASSWORD MVNW_REPOURL || :
  exec "$MAVEN_HOME/bin/$MVN_CMD" "$@" || die "cannot exec $MAVEN_HOME/bin/$MVN_CMD"
}

if [ -d "$MAVEN_HOME" ]; then
  verbose "found existing MAVEN_HOME at $MAVEN_HOME"
  exec_maven "$@"
fi

case "${distributionUrl-}" in
*?-bin.zip | *?maven-mvnd-?*-?*.zip) ;;
*) die "distributionUrl is not valid, must match *-bin.zip or maven-mvnd-*.zip, but found '${distributionUrl-}'" ;;
esac

# prepare tmp dir
if TMP_DOWNLOAD_DIR="$(mktemp -d)" && [ -d "$TMP_DOWNLOAD_DIR" ]; then
  clean() { rm -rf -- "$TMP_DOWNLOAD_DIR"; }
  trap clean HUP INT TERM EXIT
else
  die "cannot create temp dir"
fi

mkdir -p -- "${MAVEN_HOME%/*}"

# Download and Install Apache Maven
verbose "Couldn't find MAVEN_HOME, downloading and installing it ..."
verbose "Downloading from: $distributionUrl"
verbose "Downloading to: $TMP_DOWNLOAD_DIR/$distributionUrlName"

# select .zip or .tar.gz
if ! command -v unzip >/dev/null; then
  distributionUrl="${distributionUrl%.zip}.tar.gz"
  distributionUrlName="${distributionUrl##*/}"
fi

# verbose opt
__MVNW_QUIET_WGET=--quiet __MVNW_QUIET_CURL=--silent __MVNW_QUIET_UNZIP=-q __MVNW_QUIET_TAR=''
[ "${MVNW_VERBOSE-}" != true ] || __MVNW_QUIET_WGET='' __MVNW_QUIET_CURL='' __MVNW_QUIET_UNZIP='' __MVNW_QUIET_TAR=v

# normalize http auth
case "${MVNW_PASSWORD:+has-password}" in
'') MVNW_USERNAME='' MVNW_PASSWORD='' ;;
has-password) [ -n "${MVNW_USERNAME-}" ] || MVNW_USERNAME='' MVNW_PASSWORD='' ;;
esac

if [ -z "${MVNW_USERNAME-}" ] && command -v wget >/dev/null; then
  verbose "Found wget ... using wget"
  wget ${__MVNW_QUIET_WGET:+"$__MVNW_QUIET_WGET"} "$distributionUrl" -O "$TMP_DOWNLOAD_DIR/$distributionUrlName" || die "wget: Failed to fetch $distributionUrl"
elif [ -z "${MVNW_USERNAME-}" ] && command -v curl >/dev/null; then
  verbose "Found curl ... using curl"
  curl ${__MVNW_QUIET_CURL:+"$__MVNW_QUIET_CURL"} -f -L -o "$TMP_DOWNLOAD_DIR/$distributionUrlName" "$distributionUrl" || die "curl: Failed to fetch $distributionUrl"
elif set_java_home; then
  verbose "Falling back to use Java to download"
  javaSource="$TMP_DOWNLOAD_DIR/Downloader.java"
  targetZip="$TMP_DOWNLOAD_DIR/$distributionUrlName"
  cat >"$javaSource" <<-END
	public class Downloader extends java.net.Authenticator
	{
	  protected java.net.PasswordAuthentication getPasswordAuthentication()
	  {
	    return new java.net.PasswordAuthentication( System.getenv( "MVNW_USERNAME" ), System.getenv( "MVNW_PASSWORD" ).toCharArray() );
	  }
	  public static void main( String[] args ) throws Exception
	  {
	    setDefault( new Downloader() );
	    java.nio.file.Files.copy( java.net.URI.create( args[0] ).toURL().openStream(), java.nio.file.Paths.get( args[1] ).toAbsolutePath().normalize() );
	  }
	}
	END
  # For Cygwin/MinGW, switch paths to Windows format before running javac and java
  verbose " - Compiling Downloader.java ..."
  "$(native_path "$JAVACCMD")" "$(native_path "$javaSource")" || die "Failed to compile Downloader.java"
  verbose " - Running Downloader.java ..."
  "$(native_path "$JAVACMD")" -cp "$(native_path "$TMP_DOWNLOAD_DIR")" Downloader "$distributionUrl" "$(native_path "$targetZip")"
fi

# If specified, validate the SHA-256 sum of the Maven distribution zip file
if [ -n "${distributionSha256Sum-}" ]; then
  distributionSha256Result=false
  if [ "$MVN_CMD" = mvnd.sh ]; then
    echo "Checksum validation is not supported for maven-mvnd." >&2
    echo "Please disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties." >&2
    exit 1
  elif command -v sha256sum >/dev/null; then
    if echo "$distributionSha256Sum  $TMP_DOWNLOAD_DIR/$distributionUrlName" | sha256sum -c - >/dev/null 2>&1; then
      distributionSha256Result=true
    fi
  elif command -v shasum >/dev/null; then
    if echo "$distributionSha256Sum  $TMP_DOWNLOAD_DIR/$distributionUrlName" | shasum -a 256 -c >/dev/null 2>&1; then
      distributionSha256Result=true
    fi
  else
    echo "Checksum validation was requested but neither 'sha256sum' or 'shasum' are available." >&2
    echo "Please install either command, or disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties." >&2
    exit 1
  fi
  if [ $distributionSha256Result = false ]; then
    echo "Error: Failed to validate Maven distribution SHA-256, your Maven distribution might be compromised." >&2
    echo "If you updated your Maven version, you need to update the specified distributionSha256Sum property." >&2
    exit 1
  fi
fi

# unzip and move
if command -v unzip >/dev/null; then
  unzip ${__MVNW_QUIET_UNZIP:+"$__MVNW_QUIET_UNZIP"} "$TMP_DOWNLOAD_DIR/$distributionUrlName" -d "$TMP_DOWNLOAD_DIR" || die "failed to unzip"
else
  tar xzf${__MVNW_QUIET_TAR:+"$__MVNW_QUIET_TAR"} "$TMP_DOWNLOAD_DIR/$distributionUrlName" -C "$TMP_DOWNLOAD_DIR" || die "failed to untar"
fi

# Find the actual extracted directory name (handles snapshots where filename != directory name)
actualDistributionDir=""

# First try the expected directory name (for regular distributions)
if [ -d "$TMP_DOWNLOAD_DIR/$distributionUrlNameMain" ]; then
  if [ -f "$TMP_DOWNLOAD_DIR/$distributionUrlNameMain/bin/$MVN_CMD" ]; then
    actualDistributionDir="$distributionUrlNameMain"
  fi
fi

# If not found, search for any directory with the Maven executable (for snapshots)
if [ -z "$actualDistributionDir" ]; then
  # enable globbing to iterate over items
  set +f
  for dir in "$TMP_DOWNLOAD_DIR"/*; do
    if [ -d "$dir" ]; then
      if [ -f "$dir/bin/$MVN_CMD" ]; then
        actualDistributionDir="$(basename "$dir")"
        break
      fi
    fi
  done
  set -f
fi

if [ -z "$actualDistributionDir" ]; then
  verbose "Contents of $TMP_DOWNLOAD_DIR:"
  verbose "$(ls -la "$TMP_DOWNLOAD_DIR")"
  die "Could not find Maven distribution directory in extracted archive"
fi

verbose "Found extracted Maven distribution directory: $actualDistributionDir"
printf %s\\n "$distributionUrl" >"$TMP_DOWNLOAD_DIR/$actualDistributionDir/mvnw.url"
mv -- "$TMP_DOWNLOAD_DIR/$actualDistributionDir" "$MAVEN_HOME" || [ -d "$MAVEN_HOME" ] || die "fail to move MAVEN_HOME"

clean || :
exec_maven "$@"
</file>

<file path="mvnw.cmd">
<# : batch portion
@REM ----------------------------------------------------------------------------
@REM Licensed to the Apache Software Foundation (ASF) under one
@REM or more contributor license agreements.  See the NOTICE file
@REM distributed with this work for additional information
@REM regarding copyright ownership.  The ASF licenses this file
@REM to you under the Apache License, Version 2.0 (the
@REM "License"); you may not use this file except in compliance
@REM with the License.  You may obtain a copy of the License at
@REM
@REM    http://www.apache.org/licenses/LICENSE-2.0
@REM
@REM Unless required by applicable law or agreed to in writing,
@REM software distributed under the License is distributed on an
@REM "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
@REM KIND, either express or implied.  See the License for the
@REM specific language governing permissions and limitations
@REM under the License.
@REM ----------------------------------------------------------------------------

@REM ----------------------------------------------------------------------------
@REM Apache Maven Wrapper startup batch script, version 3.3.4
@REM
@REM Optional ENV vars
@REM   MVNW_REPOURL - repo url base for downloading maven distribution
@REM   MVNW_USERNAME/MVNW_PASSWORD - user and password for downloading maven
@REM   MVNW_VERBOSE - true: enable verbose log; others: silence the output
@REM ----------------------------------------------------------------------------

@IF "%__MVNW_ARG0_NAME__%"=="" (SET __MVNW_ARG0_NAME__=%~nx0)
@SET __MVNW_CMD__=
@SET __MVNW_ERROR__=
@SET __MVNW_PSMODULEP_SAVE=%PSModulePath%
@SET PSModulePath=
@FOR /F "usebackq tokens=1* delims==" %%A IN (`powershell -noprofile "& {$scriptDir='%~dp0'; $script='%__MVNW_ARG0_NAME__%'; icm -ScriptBlock ([Scriptblock]::Create((Get-Content -Raw '%~f0'))) -NoNewScope}"`) DO @(
  IF "%%A"=="MVN_CMD" (set __MVNW_CMD__=%%B) ELSE IF "%%B"=="" (echo %%A) ELSE (echo %%A=%%B)
)
@SET PSModulePath=%__MVNW_PSMODULEP_SAVE%
@SET __MVNW_PSMODULEP_SAVE=
@SET __MVNW_ARG0_NAME__=
@SET MVNW_USERNAME=
@SET MVNW_PASSWORD=
@IF NOT "%__MVNW_CMD__%"=="" ("%__MVNW_CMD__%" %*)
@echo Cannot start maven from wrapper >&2 && exit /b 1
@GOTO :EOF
: end batch / begin powershell #>

$ErrorActionPreference = "Stop"
if ($env:MVNW_VERBOSE -eq "true") {
  $VerbosePreference = "Continue"
}

# calculate distributionUrl, requires .mvn/wrapper/maven-wrapper.properties
$distributionUrl = (Get-Content -Raw "$scriptDir/.mvn/wrapper/maven-wrapper.properties" | ConvertFrom-StringData).distributionUrl
if (!$distributionUrl) {
  Write-Error "cannot read distributionUrl property in $scriptDir/.mvn/wrapper/maven-wrapper.properties"
}

switch -wildcard -casesensitive ( $($distributionUrl -replace '^.*/','') ) {
  "maven-mvnd-*" {
    $USE_MVND = $true
    $distributionUrl = $distributionUrl -replace '-bin\.[^.]*$',"-windows-amd64.zip"
    $MVN_CMD = "mvnd.cmd"
    break
  }
  default {
    $USE_MVND = $false
    $MVN_CMD = $script -replace '^mvnw','mvn'
    break
  }
}

# apply MVNW_REPOURL and calculate MAVEN_HOME
# maven home pattern: ~/.m2/wrapper/dists/{apache-maven-<version>,maven-mvnd-<version>-<platform>}/<hash>
if ($env:MVNW_REPOURL) {
  $MVNW_REPO_PATTERN = if ($USE_MVND -eq $False) { "/org/apache/maven/" } else { "/maven/mvnd/" }
  $distributionUrl = "$env:MVNW_REPOURL$MVNW_REPO_PATTERN$($distributionUrl -replace "^.*$MVNW_REPO_PATTERN",'')"
}
$distributionUrlName = $distributionUrl -replace '^.*/',''
$distributionUrlNameMain = $distributionUrlName -replace '\.[^.]*$','' -replace '-bin$',''

$MAVEN_M2_PATH = "$HOME/.m2"
if ($env:MAVEN_USER_HOME) {
  $MAVEN_M2_PATH = "$env:MAVEN_USER_HOME"
}

if (-not (Test-Path -Path $MAVEN_M2_PATH)) {
    New-Item -Path $MAVEN_M2_PATH -ItemType Directory | Out-Null
}

$MAVEN_WRAPPER_DISTS = $null
if ((Get-Item $MAVEN_M2_PATH).Target[0] -eq $null) {
  $MAVEN_WRAPPER_DISTS = "$MAVEN_M2_PATH/wrapper/dists"
} else {
  $MAVEN_WRAPPER_DISTS = (Get-Item $MAVEN_M2_PATH).Target[0] + "/wrapper/dists"
}

$MAVEN_HOME_PARENT = "$MAVEN_WRAPPER_DISTS/$distributionUrlNameMain"
$MAVEN_HOME_NAME = ([System.Security.Cryptography.SHA256]::Create().ComputeHash([byte[]][char[]]$distributionUrl) | ForEach-Object {$_.ToString("x2")}) -join ''
$MAVEN_HOME = "$MAVEN_HOME_PARENT/$MAVEN_HOME_NAME"

if (Test-Path -Path "$MAVEN_HOME" -PathType Container) {
  Write-Verbose "found existing MAVEN_HOME at $MAVEN_HOME"
  Write-Output "MVN_CMD=$MAVEN_HOME/bin/$MVN_CMD"
  exit $?
}

if (! $distributionUrlNameMain -or ($distributionUrlName -eq $distributionUrlNameMain)) {
  Write-Error "distributionUrl is not valid, must end with *-bin.zip, but found $distributionUrl"
}

# prepare tmp dir
$TMP_DOWNLOAD_DIR_HOLDER = New-TemporaryFile
$TMP_DOWNLOAD_DIR = New-Item -Itemtype Directory -Path "$TMP_DOWNLOAD_DIR_HOLDER.dir"
$TMP_DOWNLOAD_DIR_HOLDER.Delete() | Out-Null
trap {
  if ($TMP_DOWNLOAD_DIR.Exists) {
    try { Remove-Item $TMP_DOWNLOAD_DIR -Recurse -Force | Out-Null }
    catch { Write-Warning "Cannot remove $TMP_DOWNLOAD_DIR" }
  }
}

New-Item -Itemtype Directory -Path "$MAVEN_HOME_PARENT" -Force | Out-Null

# Download and Install Apache Maven
Write-Verbose "Couldn't find MAVEN_HOME, downloading and installing it ..."
Write-Verbose "Downloading from: $distributionUrl"
Write-Verbose "Downloading to: $TMP_DOWNLOAD_DIR/$distributionUrlName"

$webclient = New-Object System.Net.WebClient
if ($env:MVNW_USERNAME -and $env:MVNW_PASSWORD) {
  $webclient.Credentials = New-Object System.Net.NetworkCredential($env:MVNW_USERNAME, $env:MVNW_PASSWORD)
}
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
$webclient.DownloadFile($distributionUrl, "$TMP_DOWNLOAD_DIR/$distributionUrlName") | Out-Null

# If specified, validate the SHA-256 sum of the Maven distribution zip file
$distributionSha256Sum = (Get-Content -Raw "$scriptDir/.mvn/wrapper/maven-wrapper.properties" | ConvertFrom-StringData).distributionSha256Sum
if ($distributionSha256Sum) {
  if ($USE_MVND) {
    Write-Error "Checksum validation is not supported for maven-mvnd. `nPlease disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties."
  }
  Import-Module $PSHOME\Modules\Microsoft.PowerShell.Utility -Function Get-FileHash
  if ((Get-FileHash "$TMP_DOWNLOAD_DIR/$distributionUrlName" -Algorithm SHA256).Hash.ToLower() -ne $distributionSha256Sum) {
    Write-Error "Error: Failed to validate Maven distribution SHA-256, your Maven distribution might be compromised. If you updated your Maven version, you need to update the specified distributionSha256Sum property."
  }
}

# unzip and move
Expand-Archive "$TMP_DOWNLOAD_DIR/$distributionUrlName" -DestinationPath "$TMP_DOWNLOAD_DIR" | Out-Null

# Find the actual extracted directory name (handles snapshots where filename != directory name)
$actualDistributionDir = ""

# First try the expected directory name (for regular distributions)
$expectedPath = Join-Path "$TMP_DOWNLOAD_DIR" "$distributionUrlNameMain"
$expectedMvnPath = Join-Path "$expectedPath" "bin/$MVN_CMD"
if ((Test-Path -Path $expectedPath -PathType Container) -and (Test-Path -Path $expectedMvnPath -PathType Leaf)) {
  $actualDistributionDir = $distributionUrlNameMain
}

# If not found, search for any directory with the Maven executable (for snapshots)
if (!$actualDistributionDir) {
  Get-ChildItem -Path "$TMP_DOWNLOAD_DIR" -Directory | ForEach-Object {
    $testPath = Join-Path $_.FullName "bin/$MVN_CMD"
    if (Test-Path -Path $testPath -PathType Leaf) {
      $actualDistributionDir = $_.Name
    }
  }
}

if (!$actualDistributionDir) {
  Write-Error "Could not find Maven distribution directory in extracted archive"
}

Write-Verbose "Found extracted Maven distribution directory: $actualDistributionDir"
Rename-Item -Path "$TMP_DOWNLOAD_DIR/$actualDistributionDir" -NewName $MAVEN_HOME_NAME | Out-Null
try {
  Move-Item -Path "$TMP_DOWNLOAD_DIR/$MAVEN_HOME_NAME" -Destination $MAVEN_HOME_PARENT | Out-Null
} catch {
  if (! (Test-Path -Path "$MAVEN_HOME" -PathType Container)) {
    Write-Error "fail to move MAVEN_HOME"
  }
} finally {
  try { Remove-Item $TMP_DOWNLOAD_DIR -Recurse -Force | Out-Null }
  catch { Write-Warning "Cannot remove $TMP_DOWNLOAD_DIR" }
}

Write-Output "MVN_CMD=$MAVEN_HOME/bin/$MVN_CMD"
</file>

<file path="pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>4.0.2</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>com.diploma</groupId>
	<artifactId>autoparts-store</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>autoparts-store</name>
	<description>Backend for diploma</description>
	<url/>
	<licenses>
		<license/>
	</licenses>
	<developers>
		<developer/>
	</developers>
	<scm>
		<connection/>
		<developerConnection/>
		<tag/>
		<url/>
	</scm>
	<properties>
		<java.version>21</java.version>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-flyway</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-validation</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-webmvc</artifactId>
		</dependency>
		<dependency>
			<groupId>org.flywaydb</groupId>
			<artifactId>flyway-database-postgresql</artifactId>
		</dependency>

		<dependency>
			<groupId>org.postgresql</groupId>
			<artifactId>postgresql</artifactId>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-api</artifactId>
			<version>0.11.5</version>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-impl</artifactId>
			<version>0.11.5</version>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-jackson</artifactId>
			<version>0.11.5</version>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-flyway-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-validation-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-webmvc-test</artifactId>
			<scope>test</scope>
		</dependency>
	</dependencies>

	<build>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-compiler-plugin</artifactId>
				<configuration>
					<annotationProcessorPaths>
						<path>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</path>
					</annotationProcessorPaths>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
				<configuration>
					<excludes>
						<exclude>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</exclude>
					</excludes>
				</configuration>
			</plugin>
		</plugins>
	</build>

</project>
</file>

</files>
</file>

</files>
